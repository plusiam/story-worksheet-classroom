<script>
  /* ============================================
     êµì‚¬ ì´ˆê¸° ì„¤ì • ë§ˆë²•ì‚¬
     - ì‹œìŠ¤í…œ ëª¨ë“œ ì„ íƒ (í•™ê¸‰/ê°œì¸) ì¶”ê°€
     ============================================ */

  let wizardStep = 1;
  let wizardData = {};

  function renderTeacherSetupWizard(container) {
    wizardStep = 1;
    wizardData = { systemMode: 'classroom' };  // ê¸°ë³¸ê°’: í•™ê¸‰ ëª¨ë“œ

    renderWizardStep(container);
  }

  function renderWizardStep(container) {
    // ê°œì¸ ëª¨ë“œì¼ ê²½ìš° ë‹¨ê³„ ì¶•ì†Œ (í•™ê¸‰ ì •ë³´ ìŠ¤í‚µ)
    const isPersonalMode = wizardData.systemMode === 'personal';

    const steps = isPersonalMode ? [
      { title: 'í™˜ì˜í•©ë‹ˆë‹¤', render: renderWizardStep1 },
      { title: 'ì‚¬ìš© ëª¨ë“œ', render: renderWizardStepMode },
      { title: 'ì‚¬ìš©ì ì •ë³´', render: renderWizardStep2Personal },
      { title: 'ë³´ì•ˆ ì„¤ì •', render: renderWizardStepPin },
      { title: 'ì™„ë£Œ', render: renderWizardStep4 }
    ] : [
      { title: 'í™˜ì˜í•©ë‹ˆë‹¤', render: renderWizardStep1 },
      { title: 'ì‚¬ìš© ëª¨ë“œ', render: renderWizardStepMode },
      { title: 'ì„ ìƒë‹˜ ì •ë³´', render: renderWizardStep2 },
      { title: 'ë³´ì•ˆ ì„¤ì •', render: renderWizardStepPin },
      { title: 'í•™ê¸‰ ì •ë³´', render: renderWizardStep3 },
      { title: 'ì™„ë£Œ', render: renderWizardStep4 }
    ];

    const totalSteps = steps.length;
    const currentStep = steps[wizardStep - 1];

    if (!currentStep) {
      // ê°œì¸ ëª¨ë“œë¡œ ì „í™˜ ì‹œ ë‹¨ê³„ ì¡°ì •
      wizardStep = Math.min(wizardStep, totalSteps);
      renderWizardStep(container);
      return;
    }

    container.innerHTML = `
      <div class="container-narrow fade-in">
        <div class="card card-rainbow-top" style="padding-top: 30px;">
          ${renderProgressSteps(wizardStep, totalSteps)}

          <div class="text-center mb-3">
            <h2>${currentStep.title}</h2>
          </div>

          <div id="wizard-content">
            ${currentStep.render()}
          </div>
        </div>
      </div>
    `;
  }

  /**
   * ë§ˆë²•ì‚¬ 1ë‹¨ê³„: í™˜ì˜
   */
  function renderWizardStep1() {
    return `
      <div class="text-center">
        <div style="font-size: 5rem; margin-bottom: 24px;">ğŸ“š</div>
        <h1 class="title-handwriting" style="color: var(--primary); margin-bottom: 16px;">
          ìŠ¤í† ë¦¬ êµ¬ì„± ì›¹í•™ìŠµì§€
        </h1>
        <p style="color: var(--text-light); margin-bottom: 24px;">
          ë‚˜ë§Œì˜ ìŠ¤í† ë¦¬ í•™ìŠµì§€ ì‹œìŠ¤í…œì„ ë§Œë“¤ì–´ë³´ì„¸ìš”!<br>
          ì•½ 2ë¶„ ì •ë„ ì†Œìš”ë©ë‹ˆë‹¤.
        </p>

        <div class="card" style="background: var(--primary-light); text-align: left; margin-bottom: 24px;">
          <h4 style="margin-bottom: 12px;">âœ¨ ì´ëŸ° ê²ƒë“¤ì„ í•  ìˆ˜ ìˆì–´ìš”</h4>
          <ul style="margin: 0; padding-left: 20px; line-height: 1.8;">
            <li>4ì»· ìŠ¤í† ë¦¬ë¥¼ ì‰½ê²Œ ë§Œë“¤ ìˆ˜ ìˆì–´ìš”</li>
            <li>AI ê·¸ë¦¼ì±… ìƒì„±ì„ ìœ„í•œ ë‚´ë³´ë‚´ê¸° ê¸°ëŠ¥</li>
            <li>QR ì½”ë“œë¡œ ì‰½ê²Œ ì ‘ì† (í•™ê¸‰ ëª¨ë“œ)</li>
            <li>í•™ìƒ ì‘í’ˆ ê´€ë¦¬ (í•™ê¸‰ ëª¨ë“œ)</li>
          </ul>
        </div>

        <button class="btn btn-primary btn-lg" onclick="nextWizardStep()">
          ì‹œì‘í•˜ê¸° â†’
        </button>
      </div>
    `;
  }

  /**
   * ë§ˆë²•ì‚¬ 2ë‹¨ê³„: ì‚¬ìš© ëª¨ë“œ ì„ íƒ
   */
  function renderWizardStepMode() {
    const currentMode = wizardData.systemMode || 'classroom';

    return `
      <div class="text-center mb-3">
        <p style="color: var(--text-light);">
          ì–´ë–¤ ìš©ë„ë¡œ ì‚¬ìš©í•˜ì‹¤ ê±´ê°€ìš”?
        </p>
      </div>

      <div class="mode-selection" style="display: flex; flex-direction: column; gap: 16px;">
        <!-- í•™ê¸‰ ëª¨ë“œ -->
        <div class="mode-card ${currentMode === 'classroom' ? 'selected' : ''}"
             onclick="selectSystemMode('classroom')"
             style="border: 2px solid ${currentMode === 'classroom' ? 'var(--primary)' : 'var(--border)'};
                    border-radius: 12px; padding: 20px; cursor: pointer; transition: all 0.2s;
                    background: ${currentMode === 'classroom' ? 'var(--primary-light)' : 'white'};">
          <div style="display: flex; align-items: center; gap: 16px;">
            <div style="font-size: 2.5rem;">ğŸ‘©â€ğŸ«</div>
            <div style="text-align: left; flex: 1;">
              <h3 style="margin: 0 0 4px 0; color: var(--text);">í•™ê¸‰ ëª¨ë“œ</h3>
              <p style="margin: 0; color: var(--text-light); font-size: 0.9rem;">
                êµì‚¬ê°€ í•™ìƒë“¤ì„ ê´€ë¦¬í•˜ë©° ì‚¬ìš©
              </p>
              <ul style="margin: 8px 0 0 0; padding-left: 16px; font-size: 0.85rem; color: var(--text-light);">
                <li>í•™ìƒ ë¡œê·¸ì¸ ì‹œìŠ¤í…œ</li>
                <li>QR ì½”ë“œ ì¶œì„/ì ‘ì†</li>
                <li>í•™ìƒë³„ ì‘í’ˆ ê´€ë¦¬</li>
              </ul>
            </div>
            ${currentMode === 'classroom' ? '<span style="color: var(--primary); font-size: 1.5rem;">âœ“</span>' : ''}
          </div>
        </div>

        <!-- ê°œì¸ ëª¨ë“œ -->
        <div class="mode-card ${currentMode === 'personal' ? 'selected' : ''}"
             onclick="selectSystemMode('personal')"
             style="border: 2px solid ${currentMode === 'personal' ? 'var(--primary)' : 'var(--border)'};
                    border-radius: 12px; padding: 20px; cursor: pointer; transition: all 0.2s;
                    background: ${currentMode === 'personal' ? 'var(--primary-light)' : 'white'};">
          <div style="display: flex; align-items: center; gap: 16px;">
            <div style="font-size: 2.5rem;">ğŸ¨</div>
            <div style="text-align: left; flex: 1;">
              <h3 style="margin: 0 0 4px 0; color: var(--text);">ê°œì¸ ëª¨ë“œ</h3>
              <p style="margin: 0; color: var(--text-light); font-size: 0.9rem;">
                í˜¼ìì„œ ì½˜í…ì¸ ë¥¼ ì œì‘í•  ë•Œ ì‚¬ìš©
              </p>
              <ul style="margin: 8px 0 0 0; padding-left: 16px; font-size: 0.85rem; color: var(--text-light);">
                <li>ë¡œê·¸ì¸ ì—†ì´ ë°”ë¡œ ì‹œì‘</li>
                <li>ìœ íŠœë²„, ì½˜í…ì¸  í¬ë¦¬ì—ì´í„°ìš©</li>
                <li>ê°œì¸ í•™ìŠµ/ì°½ì‘ìš©</li>
              </ul>
            </div>
            ${currentMode === 'personal' ? '<span style="color: var(--primary); font-size: 1.5rem;">âœ“</span>' : ''}
          </div>
        </div>
      </div>

      <div class="flex gap-2 mt-3">
        <button type="button" class="btn btn-outline" onclick="prevWizardStep()">
          â† ì´ì „
        </button>
        <button type="button" class="btn btn-primary" style="flex: 1;" onclick="nextWizardStep()">
          ë‹¤ìŒ â†’
        </button>
      </div>
    `;
  }

  /**
   * ì‹œìŠ¤í…œ ëª¨ë“œ ì„ íƒ
   */
  function selectSystemMode(mode) {
    wizardData.systemMode = mode;
    renderWizardStep(document.getElementById('app'));
  }

  /**
   * ë§ˆë²•ì‚¬ 3ë‹¨ê³„: ì„ ìƒë‹˜ ì •ë³´ (í•™ê¸‰ ëª¨ë“œ)
   */
  function renderWizardStep2() {
    return `
      <form id="wizard-form-2" onsubmit="submitWizardStep2(event)">
        <div class="form-group">
          <label class="form-label" for="teacher-name">ì„ ìƒë‹˜ ì„±í•¨ *</label>
          <input type="text" id="teacher-name" name="teacherName" class="form-input form-input-lg"
                 placeholder="ì˜ˆ: ê¹€ì˜í¬" value="${escapeHtml(wizardData.teacherName || '')}" required>
          <p class="form-helper">í•™ìƒë“¤ì—ê²Œ í‘œì‹œë˜ëŠ” ì´ë¦„ì´ì—ìš”</p>
        </div>

        <div class="flex gap-2 mt-3">
          <button type="button" class="btn btn-outline" onclick="prevWizardStep()">
            â† ì´ì „
          </button>
          <button type="submit" class="btn btn-primary" style="flex: 1;">
            ë‹¤ìŒ â†’
          </button>
        </div>
      </form>
    `;
  }

  /**
   * ë§ˆë²•ì‚¬ 3ë‹¨ê³„: ì‚¬ìš©ì ì •ë³´ (ê°œì¸ ëª¨ë“œ)
   */
  function renderWizardStep2Personal() {
    return `
      <form id="wizard-form-2" onsubmit="submitWizardStep2Personal(event)">
        <div class="form-group">
          <label class="form-label" for="user-name">ë‹‰ë„¤ì„ *</label>
          <input type="text" id="user-name" name="userName" class="form-input form-input-lg"
                 placeholder="ì˜ˆ: ìŠ¤í† ë¦¬ì‘ê°€" value="${escapeHtml(wizardData.teacherName || '')}" required>
          <p class="form-helper">ì‘í’ˆì— í‘œì‹œë  ì´ë¦„ì´ì—ìš”</p>
        </div>

        <div class="flex gap-2 mt-3">
          <button type="button" class="btn btn-outline" onclick="prevWizardStep()">
            â† ì´ì „
          </button>
          <button type="submit" class="btn btn-primary" style="flex: 1;">
            ë‹¤ìŒ â†’
          </button>
        </div>
      </form>
    `;
  }

  function submitWizardStep2(event) {
    event.preventDefault();

    const teacherName = document.getElementById('teacher-name').value.trim();

    if (!teacherName) {
      showFieldError('teacher-name', 'ì„ ìƒë‹˜ ì„±í•¨ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      return;
    }

    wizardData.teacherName = teacherName;
    nextWizardStep();
  }

  function submitWizardStep2Personal(event) {
    event.preventDefault();

    const userName = document.getElementById('user-name').value.trim();

    if (!userName) {
      showFieldError('user-name', 'ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      return;
    }

    wizardData.teacherName = userName;  // ê°™ì€ í•„ë“œ ì‚¬ìš©
    nextWizardStep();
  }

  /**
   * ë§ˆë²•ì‚¬ PIN ë‹¨ê³„: êµì‚¬/ê´€ë¦¬ì PIN ì„¤ì •
   */
  function renderWizardStepPin() {
    const isPersonal = wizardData.systemMode === 'personal';

    return `
      <div class="text-center mb-3">
        <div style="font-size: 3rem; margin-bottom: 16px;">ğŸ”</div>
        <p style="color: var(--text-light);">
          ${isPersonal ? 'ì„¤ì • í™”ë©´ì„ ë³´í˜¸í•˜ê¸° ìœ„í•œ' : 'ë‹¤ë¥¸ ì‚¬ëŒì´ êµì‚¬ ëª¨ë“œì— ì ‘ê·¼í•˜ì§€ ëª»í•˜ë„ë¡'}<br>
          <strong>${isPersonal ? 'ê´€ë¦¬ì PIN' : 'êµì‚¬ ì „ìš© PIN'}</strong>ì„ ì„¤ì •í•´ì£¼ì„¸ìš”.
        </p>
      </div>

      <form id="wizard-form-pin" onsubmit="submitWizardStepPin(event)">
        <div class="form-group">
          <label class="form-label">${isPersonal ? 'ê´€ë¦¬ì' : 'êµì‚¬'} PIN (4~6ìë¦¬ ìˆ«ì) *</label>
          <div id="teacher-pin-setup" class="pin-input-container" style="justify-content: center;">
            <input type="tel" class="pin-input" maxlength="1" pattern="[0-9]" inputmode="numeric">
            <input type="tel" class="pin-input" maxlength="1" pattern="[0-9]" inputmode="numeric">
            <input type="tel" class="pin-input" maxlength="1" pattern="[0-9]" inputmode="numeric">
            <input type="tel" class="pin-input" maxlength="1" pattern="[0-9]" inputmode="numeric">
            <input type="tel" class="pin-input" maxlength="1" pattern="[0-9]" inputmode="numeric" style="opacity: 0.5;">
            <input type="tel" class="pin-input" maxlength="1" pattern="[0-9]" inputmode="numeric" style="opacity: 0.5;">
          </div>
          <p class="form-helper" style="text-align: center;">
            ì´ PINì€ ë³¸ì¸ë§Œ ì•Œê³  ê³„ì…”ì•¼ í•©ë‹ˆë‹¤!
          </p>
        </div>

        <div class="card" style="background: var(--warning-light); margin-top: 16px;">
          <p style="font-size: 0.9rem; margin: 0;">
            <strong>âš ï¸ ì¤‘ìš”:</strong> ì´ PINì„ ìŠì–´ë²„ë¦¬ë©´ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ì˜ SETTINGS ì‹œíŠ¸ì—ì„œ
            <code>teacherPinHash</code> í–‰ì„ ì‚­ì œí•´ì•¼ ì¬ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
          </p>
        </div>

        <div id="pin-error" class="alert alert-error" style="display: none;"></div>

        <div class="flex gap-2 mt-3">
          <button type="button" class="btn btn-outline" onclick="prevWizardStep()">
            â† ì´ì „
          </button>
          <button type="submit" class="btn btn-primary" style="flex: 1;">
            ${wizardData.systemMode === 'personal' ? 'ì™„ë£Œí•˜ê¸° ğŸ‰' : 'ë‹¤ìŒ â†’'}
          </button>
        </div>
      </form>
    `;
  }

  async function submitWizardStepPin(event) {
    event.preventDefault();

    const container = document.getElementById('teacher-pin-setup');
    const inputs = container.querySelectorAll('.pin-input');
    const pin = Array.from(inputs).map(input => input.value).join('');
    const errorDiv = document.getElementById('pin-error');

    if (pin.length < 4) {
      errorDiv.textContent = 'PINì€ ìµœì†Œ 4ìë¦¬ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.';
      errorDiv.style.display = 'block';
      return;
    }

    if (!/^\d+$/.test(pin)) {
      errorDiv.textContent = 'PINì€ ìˆ«ìë§Œ ì…ë ¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.';
      errorDiv.style.display = 'block';
      return;
    }

    errorDiv.style.display = 'none';
    showLoading('PIN ì„¤ì • ì¤‘...');

    try {
      const result = await callApi('setTeacherPin', { pin: pin });

      if (result.success) {
        wizardData.teacherPinSet = true;
        hideLoading();

        // ê°œì¸ ëª¨ë“œë©´ ë°”ë¡œ ì™„ë£Œ ì²˜ë¦¬
        if (wizardData.systemMode === 'personal') {
          completeTeacherSetup(wizardData);
        } else {
          nextWizardStep();
        }
      } else {
        hideLoading();
        errorDiv.textContent = result.error || 'PIN ì„¤ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
        errorDiv.style.display = 'block';
      }
    } catch (error) {
      hideLoading();
      errorDiv.textContent = 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
      errorDiv.style.display = 'block';
    }
  }

  // PIN ì…ë ¥ ì„¤ì • (ë§ˆë²•ì‚¬ìš©)
  function setupWizardPinInput() {
    const container = document.getElementById('teacher-pin-setup');
    if (!container) return;

    const inputs = container.querySelectorAll('.pin-input');

    inputs.forEach((input, index) => {
      input.addEventListener('input', (e) => {
        e.target.value = e.target.value.replace(/[^0-9]/g, '');
        if (e.target.value && index < inputs.length - 1) {
          inputs[index + 1].focus();
        }
      });

      input.addEventListener('keydown', (e) => {
        if (e.key === 'Backspace' && !e.target.value && index > 0) {
          inputs[index - 1].focus();
        }
      });
    });

    inputs[0]?.focus();
  }

  /**
   * ë§ˆë²•ì‚¬: í•™ê¸‰ ì •ë³´ (í•™ê¸‰ ëª¨ë“œ ì „ìš©)
   */
  function renderWizardStep3() {
    return `
      <form id="wizard-form-3" onsubmit="submitWizardStep3(event)">
        <div class="form-group">
          <label class="form-label" for="school-name">í•™êµ ì´ë¦„</label>
          <input type="text" id="school-name" name="schoolName" class="form-input"
                 placeholder="ì˜ˆ: ì„œìš¸ì´ˆë“±í•™êµ" value="${escapeHtml(wizardData.schoolName || '')}">
        </div>

        <div class="form-group">
          <label class="form-label" for="class-name">í•™ê¸‰</label>
          <input type="text" id="class-name" name="className" class="form-input"
                 placeholder="ì˜ˆ: 4í•™ë…„ 2ë°˜" value="${escapeHtml(wizardData.className || '')}">
        </div>

        <div class="form-group">
          <label class="form-label" for="welcome-message">í™˜ì˜ ë©”ì‹œì§€</label>
          <textarea id="welcome-message" name="welcomeMessage" class="form-input" rows="2"
                    placeholder="ì˜ˆ: ì˜¤ëŠ˜ë„ ë©‹ì§„ ì´ì•¼ê¸°ë¥¼ ë§Œë“¤ì–´ë³¼ê¹Œìš”? ğŸŒŸ">${escapeHtml(wizardData.welcomeMessage || 'ì˜¤ëŠ˜ë„ ë©‹ì§„ ì´ì•¼ê¸°ë¥¼ ë§Œë“¤ì–´ë³¼ê¹Œìš”! ğŸŒŸ')}</textarea>
          <p class="form-helper">í•™ìƒë“¤ì´ ë¡œê·¸ì¸í•  ë•Œ ë³´ì´ëŠ” ë©”ì‹œì§€ì˜ˆìš”</p>
        </div>

        <div class="flex gap-2 mt-3">
          <button type="button" class="btn btn-outline" onclick="prevWizardStep()">
            â† ì´ì „
          </button>
          <button type="submit" class="btn btn-primary" style="flex: 1;">
            ì™„ë£Œí•˜ê¸° ğŸ‰
          </button>
        </div>
      </form>
    `;
  }

  function submitWizardStep3(event) {
    event.preventDefault();

    wizardData.schoolName = document.getElementById('school-name').value.trim();
    wizardData.className = document.getElementById('class-name').value.trim();
    wizardData.welcomeMessage = document.getElementById('welcome-message').value.trim();

    // ì„¤ì • ì €ì¥
    completeTeacherSetup(wizardData);
  }

  /**
   * ë§ˆë²•ì‚¬ ì™„ë£Œ ë‹¨ê³„
   */
  function renderWizardStep4() {
    const isPersonal = wizardData.systemMode === 'personal';

    return `
      <div class="text-center">
        <div style="font-size: 5rem; margin-bottom: 24px;">ğŸ‰</div>
        <h2>ì„¤ì •ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!</h2>
        <p style="color: var(--text-light); margin-top: 8px;">
          ${isPersonal
            ? 'ì´ì œ ë°”ë¡œ ìŠ¤í† ë¦¬ë¥¼ ë§Œë“¤ì–´ë³´ì„¸ìš”!'
            : 'ì´ì œ í•™ìƒë“¤ì„ ë“±ë¡í•˜ê³  ì‹œì‘í•´ë³´ì„¸ìš”.'}
        </p>

        <button class="btn btn-primary btn-lg mt-3" onclick="${isPersonal ? "navigateTo('personal-main')" : "navigateTo('teacher-dashboard')"}">
          ${isPersonal ? 'ìŠ¤í† ë¦¬ ë§Œë“¤ê¸° â†’' : 'ëŒ€ì‹œë³´ë“œë¡œ ì´ë™ â†’'}
        </button>
      </div>
    `;
  }

  /**
   * ë‹¤ìŒ ë‹¨ê³„
   */
  function nextWizardStep() {
    const isPersonalMode = wizardData.systemMode === 'personal';
    const maxSteps = isPersonalMode ? 5 : 6;

    if (wizardStep < maxSteps) {
      wizardStep++;
      renderWizardStep(document.getElementById('app'));

      // PIN ì…ë ¥ ë‹¨ê³„ë©´ í¬ì»¤ìŠ¤ ì„¤ì •
      const pinStep = isPersonalMode ? 4 : 4;
      if (wizardStep === pinStep) {
        setTimeout(setupWizardPinInput, 100);
      }
    }
  }

  /**
   * ì´ì „ ë‹¨ê³„
   */
  function prevWizardStep() {
    if (wizardStep > 1) {
      wizardStep--;
      renderWizardStep(document.getElementById('app'));
    }
  }
</script>
