<script>
  /* ============================================
     êµì‚¬ ë¡œê·¸ì¸ í™”ë©´ (Google OAuth ì¸ì¦)
     ============================================ */

  /**
   * êµì‚¬ ë¡œê·¸ì¸ í™”ë©´ ë Œë”ë§
   */
  function renderTeacherLogin(container, data = {}) {
    const settings = AppState.settings || {};
    const mode = data.mode || 'login'; // 'login', 'pending', 'not-registered'

    container.innerHTML = `
      <div class="container-narrow fade-in" role="main" aria-label="êµì‚¬ ë¡œê·¸ì¸ í˜ì´ì§€">
        <!-- í—¤ë” -->
        <header class="card card-rainbow-top" style="margin-bottom: 24px; padding-top: 30px;" role="banner">
          <div class="text-center">
            <h1 class="title-handwriting" style="color: var(--primary); font-size: 1.8rem;">
              ğŸ“š ìŠ¤í† ë¦¬ í•™ìŠµì§€
            </h1>
            <p style="color: var(--text-light); margin-top: 8px;">
              <span class="badge" style="background: var(--primary); color: white;" role="status">ì„ ìƒë‹˜ ëª¨ë“œ</span>
            </p>
          </div>
        </header>

        <div class="card slide-up" role="region" aria-label="êµì‚¬ ë¡œê·¸ì¸ ì˜ì—­">
          ${renderTeacherAuthContent(mode, data)}
        </div>

        <nav class="text-center mt-3" aria-label="í˜ì´ì§€ ë‚´ë¹„ê²Œì´ì…˜">
          <a href="javascript:void(0)" onclick="backToStudentLogin()"
             style="color: var(--text-light); font-size: 0.85rem;"
             role="button" aria-label="í•™ìƒ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ëŒì•„ê°€ê¸°">
            â† í•™ìƒ ë¡œê·¸ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°
          </a>
        </nav>
      </div>
    `;

    // ìë™ ë¡œê·¸ì¸ ì‹œë„
    if (mode === 'login') {
      setTimeout(() => autoLoginWithGoogle(), 100);
    }
  }

  /**
   * êµì‚¬ ì¸ì¦ ì½˜í…ì¸  ë Œë”ë§
   */
  function renderTeacherAuthContent(mode, data) {
    if (mode === 'pending') {
      return renderPendingApproval(data.email);
    }

    if (mode === 'not-registered') {
      return renderNotRegistered(data.email);
    }

    if (mode === 'error') {
      return renderLoginError(data.error);
    }

    // ê¸°ë³¸: Google ë¡œê·¸ì¸ í™”ë©´
    return renderGoogleLoginForm();
  }

  /**
   * Google OAuth ë¡œê·¸ì¸ í¼
   */
  function renderGoogleLoginForm() {
    return `
      <div class="text-center" role="form" aria-labelledby="login-title">
        <div style="font-size: 3rem; margin-bottom: 16px;" aria-hidden="true">ğŸ‘©â€ğŸ«</div>
        <h2 id="login-title">êµì‚¬ ë¡œê·¸ì¸</h2>
        <p style="color: var(--text-light); margin-bottom: 24px;">
          Google ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸í•©ë‹ˆë‹¤
        </p>

        <div id="login-status" style="padding: 20px;">
          <div class="loading-spinner" style="margin: 0 auto 16px;"></div>
          <p style="color: var(--text-light);">Google ê³„ì • í™•ì¸ ì¤‘...</p>
        </div>

        <div id="login-error" class="alert alert-error" style="display: none;" role="alert"></div>

        <div id="login-actions" style="display: none;">
          <button onclick="retryGoogleLogin()" class="btn btn-primary btn-lg btn-block">
            ğŸ”„ ë‹¤ì‹œ ì‹œë„
          </button>
        </div>

        <div class="card" style="background: var(--info-light); margin-top: 24px; text-align: left;">
          <p style="font-size: 0.85rem; color: var(--info-dark); margin: 0;">
            â„¹ï¸ <strong>ì•ˆë‚´</strong><br>
            â€¢ TEACHERS ì‹œíŠ¸ì— ë“±ë¡ëœ Google ê³„ì •ë§Œ ë¡œê·¸ì¸ ê°€ëŠ¥í•©ë‹ˆë‹¤.<br>
            â€¢ ì²« ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ì†Œìœ ìëŠ” ìë™ìœ¼ë¡œ ê´€ë¦¬ìê°€ ë©ë‹ˆë‹¤.<br>
            â€¢ ì¶”ê°€ êµì‚¬ëŠ” ê´€ë¦¬ìê°€ ì§ì ‘ ë“±ë¡í•´ì•¼ í•©ë‹ˆë‹¤.
          </p>
        </div>
      </div>
    `;
  }

  /**
   * ë¯¸ë“±ë¡ ê³„ì • í™”ë©´
   */
  function renderNotRegistered(email) {
    return `
      <div class="text-center" role="status" aria-labelledby="not-registered-title">
        <div style="font-size: 3rem; margin-bottom: 16px;" aria-hidden="true">ğŸš«</div>
        <h2 id="not-registered-title">ë“±ë¡ë˜ì§€ ì•Šì€ ê³„ì •</h2>
        <p style="color: var(--text-light); margin-bottom: 16px;">
          í˜„ì¬ ë¡œê·¸ì¸ëœ Google ê³„ì •:
        </p>
        <p style="font-weight: 600; color: var(--primary); margin-bottom: 24px;">
          ${escapeHtml(email || 'ì•Œ ìˆ˜ ì—†ìŒ')}
        </p>

        <div class="card" style="background: var(--warning-light); text-align: left;">
          <p style="font-size: 0.9rem; color: var(--warning-dark); margin: 0;">
            âš ï¸ <strong>ì ‘ê·¼ ë¶ˆê°€</strong><br>
            ì´ ê³„ì •ì€ êµì‚¬ë¡œ ë“±ë¡ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.<br>
            ê´€ë¦¬ìì—ê²Œ êµì‚¬ ë“±ë¡ì„ ìš”ì²­í•˜ì„¸ìš”.
          </p>
        </div>

        <button class="btn btn-outline btn-block mt-3" onclick="backToStudentLogin()">
          â† í•™ìƒ ë¡œê·¸ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°
        </button>
      </div>
    `;
  }

  /**
   * ìŠ¹ì¸ ëŒ€ê¸° í™”ë©´
   */
  function renderPendingApproval(email) {
    return `
      <div class="text-center" role="status" aria-labelledby="pending-title">
        <div style="font-size: 3rem; margin-bottom: 16px;" aria-hidden="true">â³</div>
        <h2 id="pending-title">ìŠ¹ì¸ ëŒ€ê¸° ì¤‘</h2>
        <p style="color: var(--text-light); margin-bottom: 16px;">
          ê³„ì •: <strong>${escapeHtml(email || '')}</strong>
        </p>
        <p style="color: var(--text-light); margin-bottom: 24px;">
          ê³„ì • ìŠ¹ì¸ì„ ê¸°ë‹¤ë¦¬ê³  ìˆìŠµë‹ˆë‹¤.<br>
          ê´€ë¦¬ìê°€ ìŠ¹ì¸í•˜ë©´ ë¡œê·¸ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        </p>

        <div class="card" style="background: var(--warning-light); text-align: left;">
          <p style="font-size: 0.9rem; color: var(--warning-dark); margin: 0;">
            ğŸ”” <strong>ìŠ¹ì¸ ì ˆì°¨</strong><br>
            ê´€ë¦¬ìì—ê²Œ ìŠ¹ì¸ ìš”ì²­ì´ ì „ë‹¬ë˜ì—ˆìŠµë‹ˆë‹¤.<br>
            ìŠ¹ì¸ ì™„ë£Œ í›„ ë‹¤ì‹œ ì ‘ì†í•´ì£¼ì„¸ìš”.
          </p>
        </div>

        <button class="btn btn-outline btn-block mt-3" onclick="retryGoogleLogin()">
          ğŸ”„ ë‹¤ì‹œ í™•ì¸í•˜ê¸°
        </button>
      </div>
    `;
  }

  /**
   * ë¡œê·¸ì¸ ì˜¤ë¥˜ í™”ë©´
   */
  function renderLoginError(error) {
    return `
      <div class="text-center" role="alert" aria-labelledby="error-title">
        <div style="font-size: 3rem; margin-bottom: 16px;" aria-hidden="true">âŒ</div>
        <h2 id="error-title">ë¡œê·¸ì¸ ì‹¤íŒ¨</h2>
        <p style="color: var(--danger); margin-bottom: 24px;">
          ${escapeHtml(error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.')}
        </p>

        <button onclick="retryGoogleLogin()" class="btn btn-primary btn-lg btn-block">
          ğŸ”„ ë‹¤ì‹œ ì‹œë„
        </button>

        <div class="card" style="background: var(--info-light); margin-top: 24px; text-align: left;">
          <p style="font-size: 0.85rem; color: var(--info-dark); margin: 0;">
            ğŸ’¡ <strong>í•´ê²° ë°©ë²•</strong><br>
            â€¢ ì›¹ì•± ë°°í¬ ì„¤ì •ì—ì„œ "ë‚˜" ë¡œ ì‹¤í–‰ë˜ëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.<br>
            â€¢ ë‹¤ë¥¸ Google ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸ ë˜ì–´ìˆë‹¤ë©´ ì „í™˜í•´ì£¼ì„¸ìš”.<br>
            â€¢ ë¬¸ì œê°€ ì§€ì†ë˜ë©´ ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.
          </p>
        </div>
      </div>
    `;
  }

  /**
   * Google ê³„ì •ìœ¼ë¡œ ìë™ ë¡œê·¸ì¸ ì‹œë„
   * ì ì¡°ì§ ëª¨ë¸: ê°œë³„ GASì˜ Google OAuth í™œìš©
   */
  async function autoLoginWithGoogle() {
    const statusDiv = document.getElementById('login-status');
    const errorDiv = document.getElementById('login-error');
    const actionsDiv = document.getElementById('login-actions');

    try {
      // Google OAuth ë¡œê·¸ì¸ ì‹œë„
      const result = await callApi('loginTeacherWithGoogle', {});

      if (result.success) {
        // ë¡œê·¸ì¸ ì„±ê³µ - AppStateì— ë¨¼ì € ì €ì¥
        AppState.teacherToken = result.teacherToken;
        AppState.teacherEmail = result.email;
        AppState.teacherName = result.name || '';
        AppState.teacherRole = result.role || 'teacher';
        AppState.isTeacher = true;
        AppState.isAdmin = result.isAdmin || false;

        // sessionStorageì— ì €ì¥ (ë ˆì´ìŠ¤ ì»¨ë””ì…˜ ë°©ì§€ë¥¼ ìœ„í•´ ë™ê¸°ì ìœ¼ë¡œ ì €ì¥ ì™„ë£Œ í™•ì¸)
        try {
          sessionStorage.setItem('teacherToken', result.teacherToken);
          sessionStorage.setItem('teacherEmail', result.email);
          sessionStorage.setItem('teacherRole', result.role || 'teacher');
          sessionStorage.setItem('teacherName', result.name || '');
          sessionStorage.setItem('isAdmin', result.isAdmin ? 'true' : 'false');
        } catch (storageError) {
          console.warn('sessionStorage ì €ì¥ ì‹¤íŒ¨:', storageError);
          // ì €ì¥ ì‹¤íŒ¨í•´ë„ AppStateì—ëŠ” ìˆìœ¼ë¯€ë¡œ ê³„ì† ì§„í–‰
        }

        showToast(`${result.name || 'ì„ ìƒë‹˜'}, í™˜ì˜í•©ë‹ˆë‹¤!`, 'success');

        // ì„¸ì…˜ ì €ì¥ ì™„ë£Œ í›„ ì•½ê°„ì˜ ë”œë ˆì´ë¥¼ ì£¼ê³  í™”ë©´ ì „í™˜
        // (ë¸Œë¼ìš°ì €ê°€ sessionStorageë¥¼ ì™„ì „íˆ ì»¤ë°‹í•  ì‹œê°„ í™•ë³´)
        setTimeout(() => {
          navigateTo('teacher-dashboard');
        }, 50);
      } else {
        // ë¡œê·¸ì¸ ì‹¤íŒ¨
        if (result.status === 'pending') {
          navigateTo('teacher-login', { mode: 'pending', email: result.email });
        } else if (result.error && result.error.includes('ë“±ë¡ë˜ì§€ ì•Šì€')) {
          navigateTo('teacher-login', { mode: 'not-registered', email: result.email });
        } else {
          // ì¼ë°˜ ì˜¤ë¥˜
          if (statusDiv) statusDiv.style.display = 'none';
          if (errorDiv) {
            errorDiv.textContent = result.error || 'ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
            errorDiv.style.display = 'block';
          }
          if (actionsDiv) actionsDiv.style.display = 'block';
        }
      }
    } catch (error) {
      console.error('Google ë¡œê·¸ì¸ ì˜¤ë¥˜:', error);
      if (statusDiv) statusDiv.style.display = 'none';
      if (errorDiv) {
        errorDiv.textContent = 'ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
        errorDiv.style.display = 'block';
      }
      if (actionsDiv) actionsDiv.style.display = 'block';
    }
  }

  /**
   * Google ë¡œê·¸ì¸ ì¬ì‹œë„
   */
  function retryGoogleLogin() {
    navigateTo('teacher-login', { mode: 'login' });
  }

  /**
   * í•™ìƒ ë¡œê·¸ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°
   */
  function backToStudentLogin() {
    AppState.isTeacher = false;
    navigateTo('login');
  }

  /**
   * êµì‚¬ ë¡œê·¸ì¸ í™”ë©´ í‘œì‹œ (ì„¸ì…˜ í™•ì¸)
   */
  async function checkAndShowTeacherLogin() {
    showLoading('í™•ì¸ ì¤‘...');

    try {
      // ì„¸ì…˜ì— ì €ì¥ëœ í† í°ì´ ìˆìœ¼ë©´ ê²€ì¦
      const savedToken = sessionStorage.getItem('teacherToken');
      if (savedToken) {
        const verifyResult = await callApi('verifyTeacherSession', {
          teacherToken: savedToken
        });

        if (verifyResult.success && verifyResult.valid) {
          AppState.teacherToken = savedToken;
          AppState.teacherEmail = sessionStorage.getItem('teacherEmail');
          AppState.teacherRole = sessionStorage.getItem('teacherRole');
          AppState.isTeacher = true;

          navigateTo('teacher-dashboard');
          return;
        } else {
          // í† í° ë¬´íš¨ - ì‚­ì œ
          sessionStorage.removeItem('teacherToken');
          sessionStorage.removeItem('teacherEmail');
          sessionStorage.removeItem('teacherRole');
        }
      }

      // Google OAuth ë¡œê·¸ì¸ ì‹œë„
      navigateTo('teacher-login', { mode: 'login' });

    } catch (error) {
      console.error('êµì‚¬ ë¡œê·¸ì¸ í™•ì¸ ì‹¤íŒ¨:', error);
      showToast('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
      navigateTo('teacher-login', { mode: 'login' });
    } finally {
      hideLoading();
    }
  }
</script>
