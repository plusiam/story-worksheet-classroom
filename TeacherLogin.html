<script>
  /* ============================================
     êµì‚¬ ë¡œê·¸ì¸ í™”ë©´ (ë‹¤ì¤‘ êµì‚¬ ì§€ì›)
     ============================================ */

  /**
   * êµì‚¬ ë¡œê·¸ì¸ í™”ë©´ ë Œë”ë§
   */
  function renderTeacherLogin(container, data = {}) {
    const settings = AppState.settings || {};
    const isFirstSetup = data.isFirstSetup;
    const hasPin = data.hasPin;
    const mode = data.mode || 'login'; // 'login', 'register', 'pending'

    container.innerHTML = `
      <div class="container-narrow fade-in" role="main" aria-label="êµì‚¬ ë¡œê·¸ì¸ í˜ì´ì§€">
        <!-- í—¤ë” -->
        <header class="card card-rainbow-top" style="margin-bottom: 24px; padding-top: 30px;" role="banner">
          <div class="text-center">
            <h1 class="title-handwriting" style="color: var(--primary); font-size: 1.8rem;">
              ğŸ“š ìŠ¤í† ë¦¬ í•™ìŠµì§€
            </h1>
            <p style="color: var(--text-light); margin-top: 8px;">
              <span class="badge" style="background: var(--primary); color: white;" role="status">ì„ ìƒë‹˜ ëª¨ë“œ</span>
            </p>
          </div>
        </header>

        <div class="card slide-up" role="region" aria-label="êµì‚¬ ë¡œê·¸ì¸ ì˜ì—­">
          ${renderTeacherAuthContent(mode, isFirstSetup, hasPin, settings)}
        </div>

        <nav class="text-center mt-3" aria-label="í˜ì´ì§€ ë‚´ë¹„ê²Œì´ì…˜">
          <a href="javascript:void(0)" onclick="backToStudentLogin()"
             style="color: var(--text-light); font-size: 0.85rem;"
             role="button" aria-label="í•™ìƒ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ëŒì•„ê°€ê¸°">
            â† í•™ìƒ ë¡œê·¸ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°
          </a>
        </nav>
      </div>
    `;

    // ì…ë ¥ ì„¤ì •
    setTimeout(() => {
      if (mode === 'login') {
        setupTeacherEmailLogin();
      } else if (mode === 'register') {
        setupTeacherRegister();
      }
    }, 100);
  }

  /**
   * êµì‚¬ ì¸ì¦ ì½˜í…ì¸  ë Œë”ë§
   */
  function renderTeacherAuthContent(mode, isFirstSetup, hasPin, settings) {
    if (mode === 'pending') {
      return renderPendingApproval();
    }

    if (mode === 'register') {
      return renderRegisterForm();
    }

    // ê¸°ë³¸: ë¡œê·¸ì¸ í¼
    return renderEmailLoginForm(settings);
  }

  /**
   * ì´ë©”ì¼/ë¹„ë°€ë²ˆí˜¸ ë¡œê·¸ì¸ í¼
   */
  function renderEmailLoginForm(settings) {
    return `
      <div class="text-center" role="form" aria-labelledby="login-title">
        <div style="font-size: 3rem; margin-bottom: 16px;" aria-hidden="true">ğŸ‘©â€ğŸ«</div>
        <h2 id="login-title">êµì‚¬ ë¡œê·¸ì¸</h2>
        <p style="color: var(--text-light); margin-bottom: 24px;" id="login-description">
          ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”
        </p>

        <form id="teacher-login-form" onsubmit="submitTeacherEmailLogin(event)">
          <div class="form-group" style="text-align: left;">
            <label class="form-label" for="teacher-email">ì´ë©”ì¼</label>
            <input type="email" id="teacher-email" class="form-input"
                   placeholder="example@school.edu" required
                   style="font-size: 1rem; padding: 12px;">
          </div>

          <div class="form-group" style="text-align: left;">
            <label class="form-label" for="teacher-password">ë¹„ë°€ë²ˆí˜¸</label>
            <input type="password" id="teacher-password" class="form-input"
                   placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" required minlength="6"
                   style="font-size: 1rem; padding: 12px;">
          </div>

          <div id="login-error" class="alert alert-error" style="display: none;" role="alert" aria-live="assertive"></div>

          <button type="submit" class="btn btn-primary btn-lg btn-block mt-3">
            ë¡œê·¸ì¸
          </button>
        </form>

        <div style="margin-top: 24px; padding-top: 24px; border-top: 1px solid var(--border);">
          <p style="color: var(--text-light); font-size: 0.9rem; margin-bottom: 12px;">
            ê³„ì •ì´ ì—†ìœ¼ì‹ ê°€ìš”?
          </p>
          <button class="btn btn-outline btn-block" onclick="showTeacherRegister()">
            êµì‚¬ ê³„ì • ì‹ ì²­í•˜ê¸°
          </button>
        </div>

        <p class="mt-3" style="color: var(--text-light); font-size: 0.8rem;">
          ğŸ’¡ ì²« êµì‚¬ëŠ” ìë™ìœ¼ë¡œ ê´€ë¦¬ìê°€ ë©ë‹ˆë‹¤.<br>
          ì´í›„ êµì‚¬ëŠ” ê´€ë¦¬ì ìŠ¹ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.
        </p>
      </div>
    `;
  }

  /**
   * êµì‚¬ íšŒì›ê°€ì… í¼
   */
  function renderRegisterForm() {
    return `
      <div class="text-center" role="form" aria-labelledby="register-title">
        <div style="font-size: 3rem; margin-bottom: 16px;" aria-hidden="true">âœ¨</div>
        <h2 id="register-title">êµì‚¬ ê³„ì • ì‹ ì²­</h2>
        <p style="color: var(--text-light); margin-bottom: 24px;" id="register-description">
          ê³„ì • ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”
        </p>

        <form id="teacher-register-form" onsubmit="submitTeacherRegister(event)">
          <div class="form-group" style="text-align: left;">
            <label class="form-label" for="register-email">ì´ë©”ì¼ *</label>
            <input type="email" id="register-email" class="form-input"
                   placeholder="example@school.edu" required
                   style="font-size: 1rem; padding: 12px;">
          </div>

          <div class="form-group" style="text-align: left;">
            <label class="form-label" for="register-name">ì´ë¦„ *</label>
            <input type="text" id="register-name" class="form-input"
                   placeholder="í™ê¸¸ë™" required
                   style="font-size: 1rem; padding: 12px;">
          </div>

          <div class="form-group" style="text-align: left;">
            <label class="form-label" for="register-password">ë¹„ë°€ë²ˆí˜¸ *</label>
            <input type="password" id="register-password" class="form-input"
                   placeholder="6ìë¦¬ ì´ìƒ" required minlength="6"
                   style="font-size: 1rem; padding: 12px;">
            <small style="color: var(--text-light);">ì˜ë¬¸, ìˆ«ì í¬í•¨ 6ìë¦¬ ì´ìƒ</small>
          </div>

          <div class="form-group" style="text-align: left;">
            <label class="form-label" for="register-password-confirm">ë¹„ë°€ë²ˆí˜¸ í™•ì¸ *</label>
            <input type="password" id="register-password-confirm" class="form-input"
                   placeholder="ë¹„ë°€ë²ˆí˜¸ ë‹¤ì‹œ ì…ë ¥" required minlength="6"
                   style="font-size: 1rem; padding: 12px;">
          </div>

          <div id="register-error" class="alert alert-error" style="display: none;" role="alert" aria-live="assertive"></div>

          <button type="submit" class="btn btn-primary btn-lg btn-block mt-3">
            ê³„ì • ì‹ ì²­í•˜ê¸°
          </button>
        </form>

        <div style="margin-top: 20px;">
          <button class="btn btn-link" onclick="showTeacherLogin()"
                  style="color: var(--text-light);">
            â† ë¡œê·¸ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°
          </button>
        </div>

        <div class="card" style="background: var(--info-light); margin-top: 16px; text-align: left;">
          <p style="font-size: 0.85rem; color: var(--info-dark); margin: 0;">
            â„¹ï¸ <strong>ì•ˆë‚´</strong><br>
            â€¢ ì²« ë²ˆì§¸ ê°€ì…ìëŠ” ìë™ìœ¼ë¡œ ê´€ë¦¬ìê°€ ë©ë‹ˆë‹¤.<br>
            â€¢ ì´í›„ ê°€ì…ìëŠ” ê´€ë¦¬ìì˜ ìŠ¹ì¸ í›„ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.
          </p>
        </div>
      </div>
    `;
  }

  /**
   * ìŠ¹ì¸ ëŒ€ê¸° í™”ë©´
   */
  function renderPendingApproval() {
    return `
      <div class="text-center" role="status" aria-labelledby="pending-title">
        <div style="font-size: 3rem; margin-bottom: 16px;" aria-hidden="true">â³</div>
        <h2 id="pending-title">ìŠ¹ì¸ ëŒ€ê¸° ì¤‘</h2>
        <p style="color: var(--text-light); margin-bottom: 24px;">
          ê³„ì • ìŠ¹ì¸ì„ ê¸°ë‹¤ë¦¬ê³  ìˆìŠµë‹ˆë‹¤.<br>
          ê´€ë¦¬ìê°€ ìŠ¹ì¸í•˜ë©´ ë¡œê·¸ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        </p>

        <div class="card" style="background: var(--warning-light); text-align: left;">
          <p style="font-size: 0.9rem; color: var(--warning-dark); margin: 0;">
            ğŸ”” <strong>ìŠ¹ì¸ ì ˆì°¨</strong><br>
            ê´€ë¦¬ìì—ê²Œ ìŠ¹ì¸ ìš”ì²­ì´ ì „ë‹¬ë˜ì—ˆìŠµë‹ˆë‹¤.<br>
            ìŠ¹ì¸ ì™„ë£Œ ì‹œ ë“±ë¡í•˜ì‹  ì´ë©”ì¼ë¡œ ë¡œê·¸ì¸í•˜ì„¸ìš”.
          </p>
        </div>

        <button class="btn btn-outline btn-block mt-3" onclick="showTeacherLogin()">
          ë¡œê·¸ì¸ í™”ë©´ìœ¼ë¡œ
        </button>
      </div>
    `;
  }

  /**
   * ì´ë©”ì¼ ë¡œê·¸ì¸ í¼ ì„¤ì •
   */
  function setupTeacherEmailLogin() {
    const emailInput = document.getElementById('teacher-email');
    if (emailInput) {
      emailInput.focus();
    }
  }

  /**
   * íšŒì›ê°€ì… í¼ ì„¤ì •
   */
  function setupTeacherRegister() {
    const emailInput = document.getElementById('register-email');
    if (emailInput) {
      emailInput.focus();
    }
  }

  /**
   * ì´ë©”ì¼ ë¡œê·¸ì¸ ì œì¶œ
   */
  async function submitTeacherEmailLogin(event) {
    event.preventDefault();

    const email = document.getElementById('teacher-email').value.trim();
    const password = document.getElementById('teacher-password').value;
    const errorDiv = document.getElementById('login-error');

    if (!email || !password) {
      errorDiv.textContent = 'ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.';
      errorDiv.style.display = 'block';
      return;
    }

    errorDiv.style.display = 'none';
    showLoading('ë¡œê·¸ì¸ ì¤‘...');

    try {
      const result = await callApi('loginTeacherWithEmail', {
        email: email,
        password: password
      });

      if (result.success) {
        // ìŠ¹ì¸ ëŒ€ê¸° ì¤‘ì¸ ê²½ìš°
        if (result.status === 'pending') {
          hideLoading();
          navigateTo('teacher-login', { mode: 'pending' });
          return;
        }

        // ê±°ë¶€ëœ ê²½ìš°
        if (result.status === 'rejected') {
          errorDiv.innerHTML = `
            <strong>ê³„ì •ì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤.</strong><br>
            ${result.rejectionReason || 'ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.'}
          `;
          errorDiv.style.display = 'block';
          hideLoading();
          return;
        }

        // ì •ì§€ëœ ê²½ìš°
        if (result.status === 'suspended') {
          errorDiv.textContent = 'ê³„ì •ì´ ì •ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.';
          errorDiv.style.display = 'block';
          hideLoading();
          return;
        }

        // ì •ìƒ ë¡œê·¸ì¸
        AppState.teacherToken = result.teacherToken;
        AppState.teacherEmail = result.email;
        AppState.teacherName = result.name;
        AppState.teacherRole = result.role;
        AppState.isTeacher = true;

        sessionStorage.setItem('teacherToken', result.teacherToken);
        sessionStorage.setItem('teacherEmail', result.email);
        sessionStorage.setItem('teacherRole', result.role);

        showToast(`${result.name || 'ì„ ìƒë‹˜'}, í™˜ì˜í•©ë‹ˆë‹¤!`, 'success');

        // ê´€ë¦¬ìë©´ ëŒ€ì‹œë³´ë“œë¡œ, ì•„ë‹ˆë©´ í•™ìƒ ê´€ë¦¬ë¡œ
        navigateTo('teacher-dashboard');
      } else {
        errorDiv.textContent = result.error || 'ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
        errorDiv.style.display = 'block';
      }
    } catch (error) {
      console.error('ë¡œê·¸ì¸ ì˜¤ë¥˜:', error);
      errorDiv.textContent = 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
      errorDiv.style.display = 'block';
    } finally {
      hideLoading();
    }
  }

  /**
   * êµì‚¬ íšŒì›ê°€ì… ì œì¶œ
   */
  async function submitTeacherRegister(event) {
    event.preventDefault();

    const email = document.getElementById('register-email').value.trim();
    const name = document.getElementById('register-name').value.trim();
    const password = document.getElementById('register-password').value;
    const passwordConfirm = document.getElementById('register-password-confirm').value;
    const errorDiv = document.getElementById('register-error');

    // ìœ íš¨ì„± ê²€ì‚¬
    if (!email || !name || !password) {
      errorDiv.textContent = 'ëª¨ë“  í•„ìˆ˜ í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.';
      errorDiv.style.display = 'block';
      return;
    }

    if (password.length < 6) {
      errorDiv.textContent = 'ë¹„ë°€ë²ˆí˜¸ëŠ” 6ìë¦¬ ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.';
      errorDiv.style.display = 'block';
      return;
    }

    if (password !== passwordConfirm) {
      errorDiv.textContent = 'ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.';
      errorDiv.style.display = 'block';
      return;
    }

    // ì´ë©”ì¼ í˜•ì‹ ê²€ì‚¬
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) {
      errorDiv.textContent = 'ì˜¬ë°”ë¥¸ ì´ë©”ì¼ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤.';
      errorDiv.style.display = 'block';
      return;
    }

    errorDiv.style.display = 'none';
    showLoading('ê³„ì • ì‹ ì²­ ì¤‘...');

    try {
      const result = await callApi('registerTeacher', {
        email: email,
        name: name,
        password: password
      });

      if (result.success) {
        if (result.isFirstTeacher) {
          // ì²« êµì‚¬ - ë°”ë¡œ ê´€ë¦¬ìë¡œ ë¡œê·¸ì¸
          showToast('ğŸ‰ ê´€ë¦¬ì ê³„ì •ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');

          // ìë™ ë¡œê·¸ì¸
          const loginResult = await callApi('loginTeacherWithEmail', {
            email: email,
            password: password
          });

          if (loginResult.success) {
            AppState.teacherToken = loginResult.teacherToken;
            AppState.teacherEmail = loginResult.email;
            AppState.teacherName = loginResult.name;
            AppState.teacherRole = loginResult.role;
            AppState.isTeacher = true;

            sessionStorage.setItem('teacherToken', loginResult.teacherToken);
            sessionStorage.setItem('teacherEmail', loginResult.email);
            sessionStorage.setItem('teacherRole', loginResult.role);

            navigateTo('teacher-dashboard');
          }
        } else {
          // ì¼ë°˜ êµì‚¬ - ìŠ¹ì¸ ëŒ€ê¸°
          showToast('ê³„ì • ì‹ ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
          navigateTo('teacher-login', { mode: 'pending' });
        }
      } else {
        errorDiv.textContent = result.error || 'ê³„ì • ì‹ ì²­ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
        errorDiv.style.display = 'block';
      }
    } catch (error) {
      console.error('íšŒì›ê°€ì… ì˜¤ë¥˜:', error);
      errorDiv.textContent = 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
      errorDiv.style.display = 'block';
    } finally {
      hideLoading();
    }
  }

  /**
   * ë¡œê·¸ì¸ í™”ë©´ í‘œì‹œ
   */
  function showTeacherLogin() {
    navigateTo('teacher-login', { mode: 'login' });
  }

  /**
   * íšŒì›ê°€ì… í™”ë©´ í‘œì‹œ
   */
  function showTeacherRegister() {
    navigateTo('teacher-login', { mode: 'register' });
  }

  /**
   * í•™ìƒ ë¡œê·¸ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°
   */
  function backToStudentLogin() {
    AppState.isTeacher = false;
    navigateTo('login');
  }

  /**
   * êµì‚¬ ë¡œê·¸ì¸ í™”ë©´ í‘œì‹œ (ì¡°ê±´ í™•ì¸)
   */
  async function checkAndShowTeacherLogin() {
    showLoading('í™•ì¸ ì¤‘...');

    try {
      // ì„¸ì…˜ì— ì €ì¥ëœ í† í°ì´ ìˆìœ¼ë©´ ê²€ì¦
      const savedToken = sessionStorage.getItem('teacherToken');
      if (savedToken) {
        const verifyResult = await callApi('verifyTeacherSession', {
          teacherToken: savedToken
        });

        if (verifyResult.success && verifyResult.valid) {
          AppState.teacherToken = savedToken;
          AppState.teacherEmail = verifyResult.email;
          AppState.teacherName = verifyResult.name;
          AppState.teacherRole = verifyResult.role;
          AppState.isTeacher = true;

          navigateTo('teacher-dashboard');
          return;
        } else {
          // í† í° ë¬´íš¨ - ì‚­ì œ
          sessionStorage.removeItem('teacherToken');
          sessionStorage.removeItem('teacherEmail');
          sessionStorage.removeItem('teacherRole');
        }
      }

      // ë¡œê·¸ì¸ í™”ë©´ í‘œì‹œ
      navigateTo('teacher-login', { mode: 'login' });

    } catch (error) {
      console.error('êµì‚¬ ë¡œê·¸ì¸ í™•ì¸ ì‹¤íŒ¨:', error);
      showToast('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
      navigateTo('teacher-login', { mode: 'login' });
    } finally {
      hideLoading();
    }
  }

  // ============================================
  // ë ˆê±°ì‹œ í˜¸í™˜ (ê¸°ì¡´ PIN ë°©ì‹ - ì‚­ì œ ì˜ˆì •)
  // ============================================

  /**
   * @deprecated ì´ë©”ì¼ ë¡œê·¸ì¸ìœ¼ë¡œ ëŒ€ì²´ë¨
   */
  function renderFirstSetupPrompt() {
    return renderRegisterForm();
  }

  /**
   * @deprecated ì´ë©”ì¼ ë¡œê·¸ì¸ìœ¼ë¡œ ëŒ€ì²´ë¨
   */
  function renderLoginForm(hasPin, settings) {
    return renderEmailLoginForm(settings);
  }

  /**
   * @deprecated
   */
  function setupTeacherPinInput() {
    // PIN ë°©ì‹ ë” ì´ìƒ ì‚¬ìš© ì•ˆí•¨
  }

  /**
   * @deprecated
   */
  function getTeacherPinValue(containerId) {
    return '';
  }

  /**
   * @deprecated
   */
  async function submitNewTeacherPin() {
    showToast('PIN ë°©ì‹ì€ ë” ì´ìƒ ì§€ì›ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì´ë©”ì¼ë¡œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.', 'info');
  }

  /**
   * @deprecated
   */
  async function submitTeacherLogin() {
    showToast('PIN ë°©ì‹ì€ ë” ì´ìƒ ì§€ì›ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì´ë©”ì¼ë¡œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.', 'info');
  }

  /**
   * @deprecated
   */
  function clearTeacherPinInput(containerId) {
    // ë” ì´ìƒ ì‚¬ìš© ì•ˆí•¨
  }
</script>
