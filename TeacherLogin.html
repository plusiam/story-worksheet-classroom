<script>
  /* ============================================
     êµì‚¬ ë¡œê·¸ì¸ í™”ë©´
     ============================================ */

  /**
   * êµì‚¬ ë¡œê·¸ì¸ í™”ë©´ ë Œë”ë§
   */
  function renderTeacherLogin(container, data = {}) {
    const settings = AppState.settings || {};
    const isFirstSetup = data.isFirstSetup;
    const hasPin = data.hasPin;

    container.innerHTML = `
      <div class="container-narrow fade-in" role="main" aria-label="êµì‚¬ ë¡œê·¸ì¸ í˜ì´ì§€">
        <!-- í—¤ë” -->
        <header class="card card-rainbow-top" style="margin-bottom: 24px; padding-top: 30px;" role="banner">
          <div class="text-center">
            <h1 class="title-handwriting" style="color: var(--primary); font-size: 1.8rem;">
              ğŸ“š ìŠ¤í† ë¦¬ í•™ìŠµì§€
            </h1>
            <p style="color: var(--text-light); margin-top: 8px;">
              <span class="badge" style="background: var(--primary); color: white;" role="status">ì„ ìƒë‹˜ ëª¨ë“œ</span>
            </p>
          </div>
        </header>

        <div class="card slide-up" role="region" aria-label="êµì‚¬ ë¡œê·¸ì¸ ì˜ì—­">
          ${isFirstSetup ? renderFirstSetupPrompt() : renderLoginForm(hasPin, settings)}
        </div>

        <nav class="text-center mt-3" aria-label="í˜ì´ì§€ ë‚´ë¹„ê²Œì´ì…˜">
          <a href="javascript:void(0)" onclick="backToStudentLogin()"
             style="color: var(--text-light); font-size: 0.85rem;"
             role="button" aria-label="í•™ìƒ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ëŒì•„ê°€ê¸°">
            â† í•™ìƒ ë¡œê·¸ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°
          </a>
        </nav>
      </div>
    `;

    // PIN ì…ë ¥ ì„¤ì •
    if (!isFirstSetup && hasPin) {
      setTimeout(() => setupTeacherPinInput(), 100);
    }
  }

  /**
   * ì²« ì„¤ì • ì•ˆë‚´
   */
  function renderFirstSetupPrompt() {
    return `
      <div class="text-center" role="region" aria-labelledby="welcome-title">
        <div style="font-size: 3rem; margin-bottom: 16px;" aria-hidden="true">ğŸ‘‹</div>
        <h2 id="welcome-title">ì²˜ìŒ ì˜¤ì…¨êµ°ìš”!</h2>
        <p style="color: var(--text-light); margin-bottom: 24px;" id="welcome-description">
          ìŠ¤í† ë¦¬ í•™ìŠµì§€ë¥¼ ì²˜ìŒ ì‚¬ìš©í•˜ì‹œë„¤ìš”.<br>
          ê°„ë‹¨í•œ ì„¤ì •ì„ ì™„ë£Œí•´ì£¼ì„¸ìš”.
        </p>

        <div class="card" style="background: var(--warning-light); text-align: left; margin-bottom: 24px;"
             role="alert" aria-label="ë³´ì•ˆ ì•ˆë‚´">
          <h4 style="color: var(--warning-dark); margin-bottom: 8px;">ğŸ” ë³´ì•ˆ ì•ˆë‚´</h4>
          <p style="font-size: 0.9rem; color: var(--text);">
            ì„¤ì • ê³¼ì •ì—ì„œ <strong>êµì‚¬ PIN</strong>ì„ ë§Œë“¤ê²Œ ë©ë‹ˆë‹¤.<br>
            ì´ PINì€ ì„ ìƒë‹˜ë§Œ ì•Œê³  ê³„ì…”ì•¼ í•©ë‹ˆë‹¤.
          </p>
        </div>

        <button class="btn btn-primary btn-lg btn-block" onclick="navigateTo('teacher-setup')"
                aria-describedby="welcome-description">
          ì„¤ì • ì‹œì‘í•˜ê¸° â†’
        </button>
      </div>
    `;
  }

  /**
   * êµì‚¬ ë¡œê·¸ì¸ í¼
   */
  function renderLoginForm(hasPin, settings) {
    const teacherName = settings.teacherName || '';

    if (!hasPin) {
      // PINì´ ì•„ì§ ì„¤ì •ë˜ì§€ ì•ŠìŒ (ë§ˆì´ê·¸ë ˆì´ì…˜ í•„ìš”)
      return `
        <div class="text-center" role="form" aria-labelledby="pin-setup-title">
          <div style="font-size: 3rem; margin-bottom: 16px;" aria-hidden="true">ğŸ”</div>
          <h2 id="pin-setup-title">êµì‚¬ PIN ì„¤ì • í•„ìš”</h2>
          <p style="color: var(--text-light); margin-bottom: 24px;" id="pin-setup-description">
            ë³´ì•ˆ ê°•í™”ë¥¼ ìœ„í•´ êµì‚¬ PINì„ ì„¤ì •í•´ì£¼ì„¸ìš”.<br>
            ë‹¤ë¥¸ ì‚¬ëŒì´ êµì‚¬ ëª¨ë“œì— ì ‘ê·¼í•˜ëŠ” ê²ƒì„ ë°©ì§€í•©ë‹ˆë‹¤.
          </p>

          <div class="form-group">
            <label class="form-label" for="new-pin-1" id="new-pin-label">ìƒˆ PIN (4~6ìë¦¬ ìˆ«ì)</label>
            <div id="new-teacher-pin" class="pin-input-container pin-4" role="group" aria-labelledby="new-pin-label">
              <input type="tel" class="pin-input" maxlength="1" pattern="[0-9]" inputmode="numeric"
                     id="new-pin-1" aria-label="PIN ì²« ë²ˆì§¸ ìë¦¬">
              <input type="tel" class="pin-input" maxlength="1" pattern="[0-9]" inputmode="numeric"
                     aria-label="PIN ë‘ ë²ˆì§¸ ìë¦¬">
              <input type="tel" class="pin-input" maxlength="1" pattern="[0-9]" inputmode="numeric"
                     aria-label="PIN ì„¸ ë²ˆì§¸ ìë¦¬">
              <input type="tel" class="pin-input" maxlength="1" pattern="[0-9]" inputmode="numeric"
                     aria-label="PIN ë„¤ ë²ˆì§¸ ìë¦¬">
            </div>
          </div>

          <button class="btn btn-primary btn-lg btn-block mt-3" onclick="submitNewTeacherPin()"
                  aria-describedby="pin-setup-description">
            PIN ì„¤ì •í•˜ê¸°
          </button>
        </div>
      `;
    }

    // PINì´ ìˆìœ¼ë©´ ë¡œê·¸ì¸ í¼
    return `
      <div class="text-center" role="form" aria-labelledby="login-title">
        <div style="font-size: 3rem; margin-bottom: 16px;" aria-hidden="true">ğŸ‘©â€ğŸ«</div>
        <h2 id="login-title">${teacherName ? escapeHtml(teacherName) + ' ì„ ìƒë‹˜' : 'ì„ ìƒë‹˜'}</h2>
        <p style="color: var(--text-light); margin-bottom: 24px;" id="login-description">
          êµì‚¬ PINì„ ì…ë ¥í•´ì£¼ì„¸ìš”
        </p>

        <div class="form-group">
          <label class="form-label" for="teacher-pin-1" id="teacher-pin-label">êµì‚¬ PIN</label>
          <div id="teacher-pin" class="pin-input-container pin-4" role="group" aria-labelledby="teacher-pin-label">
            <input type="tel" class="pin-input" maxlength="1" pattern="[0-9]" inputmode="numeric"
                   id="teacher-pin-1" aria-label="PIN ì²« ë²ˆì§¸ ìë¦¬">
            <input type="tel" class="pin-input" maxlength="1" pattern="[0-9]" inputmode="numeric"
                   aria-label="PIN ë‘ ë²ˆì§¸ ìë¦¬">
            <input type="tel" class="pin-input" maxlength="1" pattern="[0-9]" inputmode="numeric"
                   aria-label="PIN ì„¸ ë²ˆì§¸ ìë¦¬">
            <input type="tel" class="pin-input" maxlength="1" pattern="[0-9]" inputmode="numeric"
                   aria-label="PIN ë„¤ ë²ˆì§¸ ìë¦¬">
          </div>
        </div>

        <div id="login-error" class="alert alert-error" style="display: none;" role="alert" aria-live="assertive"></div>

        <button class="btn btn-primary btn-lg btn-block mt-3" onclick="submitTeacherLogin()"
                aria-describedby="login-description">
          ë¡œê·¸ì¸
        </button>

        <p class="mt-3" style="color: var(--text-light); font-size: 0.85rem;" aria-describedby="pin-reset-help">
          PINì„ ìŠìœ¼ì…¨ë‚˜ìš”? ìŠ¤í”„ë ˆë“œì‹œíŠ¸ SETTINGS ì‹œíŠ¸ì—ì„œ<br>
          <code>teacherPinHash</code> í–‰ì„ ì‚­ì œí•˜ë©´ ì¬ì„¤ì •ë©ë‹ˆë‹¤.
        </p>
      </div>
    `;
  }

  /**
   * êµì‚¬ PIN ì…ë ¥ ì„¤ì •
   */
  function setupTeacherPinInput() {
    const container = document.getElementById('teacher-pin') || document.getElementById('new-teacher-pin');
    if (!container) return;

    const inputs = container.querySelectorAll('.pin-input');

    inputs.forEach((input, index) => {
      // ìˆ«ìë§Œ ì…ë ¥
      input.addEventListener('input', (e) => {
        e.target.value = e.target.value.replace(/[^0-9]/g, '');
        if (e.target.value && index < inputs.length - 1) {
          inputs[index + 1].focus();
        }
      });

      // ë°±ìŠ¤í˜ì´ìŠ¤ë¡œ ì´ì „ ì¹¸ ì´ë™
      input.addEventListener('keydown', (e) => {
        if (e.key === 'Backspace' && !e.target.value && index > 0) {
          inputs[index - 1].focus();
        }
        // ì—”í„°ë¡œ ì œì¶œ
        if (e.key === 'Enter') {
          const btn = document.querySelector('button[onclick*="submitTeacher"]');
          if (btn) btn.click();
        }
      });
    });

    // ì²« ë²ˆì§¸ ì…ë ¥ì— í¬ì»¤ìŠ¤
    inputs[0]?.focus();
  }

  /**
   * êµì‚¬ PIN ê°’ ê°€ì ¸ì˜¤ê¸°
   */
  function getTeacherPinValue(containerId) {
    const container = document.getElementById(containerId);
    if (!container) return '';

    const inputs = container.querySelectorAll('.pin-input');
    return Array.from(inputs).map(input => input.value).join('');
  }

  /**
   * ìƒˆ êµì‚¬ PIN ì„¤ì • ì œì¶œ
   */
  async function submitNewTeacherPin() {
    const pin = getTeacherPinValue('new-teacher-pin');

    if (pin.length < 4) {
      showToast('PINì€ 4ìë¦¬ ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
      return;
    }

    showLoading('PIN ì„¤ì • ì¤‘...');

    try {
      const result = await callApi('setTeacherPin', { pin: pin });

      if (result.success) {
        showToast('êµì‚¬ PINì´ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
        // ë‹¤ì‹œ ë¡œê·¸ì¸ í™”ë©´ìœ¼ë¡œ
        checkAndShowTeacherLogin();
      } else {
        showToast(result.error || 'PIN ì„¤ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
      }
    } catch (error) {
      showToast('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
    } finally {
      hideLoading();
    }
  }

  /**
   * êµì‚¬ ë¡œê·¸ì¸ ì œì¶œ
   */
  async function submitTeacherLogin() {
    const pin = getTeacherPinValue('teacher-pin');
    const errorDiv = document.getElementById('login-error');

    if (pin.length < 4) {
      errorDiv.textContent = 'PINì„ ì…ë ¥í•´ì£¼ì„¸ìš”.';
      errorDiv.style.display = 'block';
      return;
    }

    errorDiv.style.display = 'none';
    showLoading('ë¡œê·¸ì¸ ì¤‘...');

    try {
      const result = await callApi('loginTeacher', { pin: pin });

      if (result.success) {
        // êµì‚¬ í† í° ì €ì¥
        AppState.teacherToken = result.teacherToken;
        AppState.isTeacher = true;
        sessionStorage.setItem('teacherToken', result.teacherToken);

        showToast(`${result.teacherName || 'ì„ ìƒë‹˜'}, í™˜ì˜í•©ë‹ˆë‹¤!`, 'success');
        navigateTo('teacher-dashboard');
      } else {
        errorDiv.textContent = result.error || 'ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
        errorDiv.style.display = 'block';
        // PIN ì…ë ¥ ì´ˆê¸°í™”
        clearTeacherPinInput('teacher-pin');
      }
    } catch (error) {
      errorDiv.textContent = 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
      errorDiv.style.display = 'block';
    } finally {
      hideLoading();
    }
  }

  /**
   * PIN ì…ë ¥ ì´ˆê¸°í™”
   */
  function clearTeacherPinInput(containerId) {
    const container = document.getElementById(containerId);
    if (!container) return;

    const inputs = container.querySelectorAll('.pin-input');
    inputs.forEach(input => input.value = '');
    inputs[0]?.focus();
  }

  /**
   * í•™ìƒ ë¡œê·¸ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°
   */
  function backToStudentLogin() {
    AppState.isTeacher = false;
    navigateTo('login');
  }

  /**
   * êµì‚¬ ë¡œê·¸ì¸ í™”ë©´ í‘œì‹œ (ì¡°ê±´ í™•ì¸)
   */
  async function checkAndShowTeacherLogin() {
    showLoading('í™•ì¸ ì¤‘...');

    try {
      // ë¨¼ì € Google ê³„ì • ê¶Œí•œ í™•ì¸
      const googleAuth = await callApi('checkGoogleAuth');

      if (googleAuth.isAuthorized) {
        // Google ê³„ì •ìœ¼ë¡œ ì¸ì¦ë¨ - ë°”ë¡œ ëŒ€ì‹œë³´ë“œë¡œ
        AppState.isTeacher = true;
        const firstSetup = await callApi('isFirstSetup');

        if (firstSetup.isFirstSetup) {
          navigateTo('teacher-setup');
        } else {
          navigateTo('teacher-dashboard');
        }
        return;
      }

      // Google ê³„ì •ì´ ì•„ë‹ˆë©´ PIN í™•ì¸
      const [firstSetup, hasPin] = await Promise.all([
        callApi('isFirstSetup'),
        callApi('hasTeacherPin')
      ]);

      navigateTo('teacher-login', {
        isFirstSetup: firstSetup.isFirstSetup,
        hasPin: hasPin.hasPin
      });

    } catch (error) {
      console.error('êµì‚¬ ë¡œê·¸ì¸ í™•ì¸ ì‹¤íŒ¨:', error);
      showToast('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
      navigateTo('login');
    } finally {
      hideLoading();
    }
  }
</script>
