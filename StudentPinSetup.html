<script>
  /* ============================================
     í•™ìƒ PIN ì„¤ì • í™”ë©´
     ============================================ */

  let pinSetupData = {};

  function renderStudentPinSetup(container, data) {
    pinSetupData = data || {};
    const settings = AppState.settings || {};

    container.innerHTML = `
      <div class="container-narrow fade-in">
        ${renderStudentHeader()}

        <div class="card slide-up">
          <div class="text-center mb-3">
            <div style="font-size: 4rem; margin-bottom: 16px;">ğŸ”</div>
            <h2>ğŸ‘‹ ${escapeHtml(pinSetupData.name || '')}(${pinSetupData.number || ''}ë²ˆ) í•™ìƒ, ë°˜ê°€ì›Œìš”!</h2>
            <p style="color: var(--text-light); margin-top: 8px;">
              ì²˜ìŒ ì˜¤ì…¨ë„¤ìš”!<br>
              ì•ìœ¼ë¡œ ì‚¬ìš©í•  PINì„ ë§Œë“¤ì–´ì£¼ì„¸ìš”.
            </p>
          </div>

          <div class="alert alert-info">
            <span>ğŸ’¡</span>
            <div>
              <strong>PINì´ë€?</strong>
              <p style="margin: 4px 0 0 0; font-size: 0.9rem;">
                ë‹¤ìŒì— ë¡œê·¸ì¸í•  ë•Œ ì‚¬ìš©í•˜ëŠ” ìˆ«ì ë¹„ë°€ë²ˆí˜¸ì˜ˆìš”.<br>
                ìŠì–´ë²„ë¦¬ì§€ ì•Šë„ë¡ ê¸°ì–µí•´ì£¼ì„¸ìš”!
              </p>
            </div>
          </div>

          <form id="pin-setup-form" onsubmit="submitPinSetup(event)">
            ${renderPinInput('setup-pin', 'PIN ë§Œë“¤ê¸°')}

            <div style="margin-top: 24px;">
              ${renderPinInput('setup-pin-confirm', 'PIN í™•ì¸')}
            </div>

            <div id="pin-error" class="alert alert-error mt-2" style="display: none;"></div>

            <button type="submit" class="btn btn-primary btn-lg btn-block mt-3">
              ì‹œì‘í•˜ê¸° ğŸš€
            </button>
          </form>

          <div class="text-center mt-3">
            <a href="#" onclick="navigateTo('login')" style="color: var(--text-light); font-size: 0.85rem;">
              â† ë‹¤ì‹œ ì…ë ¥í•˜ê¸°
            </a>
          </div>
        </div>
      </div>
    `;

    // PIN ì…ë ¥ ì„¤ì •
    setTimeout(() => {
      setupPinInput('setup-pin');
      setupPinInput('setup-pin-confirm');
    }, 100);
  }

  /**
   * PIN ì„¤ì • ì œì¶œ
   */
  async function submitPinSetup(event) {
    event.preventDefault();

    const pin = getPinValue('setup-pin');
    const pinConfirm = getPinValue('setup-pin-confirm');
    const errorDiv = document.getElementById('pin-error');

    // ìœ íš¨ì„± ê²€ì‚¬
    const pinError = validatePin(pin);
    if (pinError) {
      errorDiv.textContent = pinError;
      errorDiv.style.display = 'block';
      clearPinInput('setup-pin');
      return;
    }

    // PIN í™•ì¸
    if (pin !== pinConfirm) {
      errorDiv.textContent = 'PINì´ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì…ë ¥í•´ì£¼ì„¸ìš”.';
      errorDiv.style.display = 'block';
      clearPinInput('setup-pin-confirm');
      return;
    }

    // ë„ˆë¬´ ë‹¨ìˆœí•œ PIN ê²½ê³ 
    if (isSimplePin(pin)) {
      showConfirm(
        'ì„ íƒí•œ PINì´ ë„ˆë¬´ ë‹¨ìˆœí•©ë‹ˆë‹¤ (ì˜ˆ: 123456, 111111). ê·¸ë˜ë„ ì‚¬ìš©í•˜ì‹œê² ìŠµë‹ˆê¹Œ?',
        () => {
          // í™•ì¸: PIN ì„¤ì • ì§„í–‰
          handlePinSetup(pinSetupData.name, pinSetupData.number, pin);
        },
        () => {
          // ì·¨ì†Œ: PIN í•„ë“œ í´ë¦¬ì–´í•˜ê³  ë‹¤ì‹œ ì…ë ¥í•˜ë„ë¡
          clearPinInput('setup-pin');
          clearPinInput('setup-pin-confirm');
          // ì²« ë²ˆì§¸ PIN ì…ë ¥ í•„ë“œì— í¬ì»¤ìŠ¤
          const firstInput = document.querySelector('#setup-pin input');
          if (firstInput) firstInput.focus();
        }
      );
      return;
    }

    errorDiv.style.display = 'none';
    await handlePinSetup(pinSetupData.name, pinSetupData.number, pin);
  }

  /**
   * ë‹¨ìˆœí•œ PIN ì²´í¬
   */
  function isSimplePin(pin) {
    const simplePins = [
      '000000', '111111', '222222', '333333', '444444',
      '555555', '666666', '777777', '888888', '999999',
      '123456', '654321', '012345', '123123'
    ];

    return simplePins.includes(pin);
  }
</script>
