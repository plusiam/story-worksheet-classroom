<script>
  /* ============================================
     ë˜ë¦¬ AI ì„¤ì • í™”ë©´ (êµì‚¬ìš©)
     ============================================ */

  let aiSettingsData = {
    aiEnabled: false,
    aiApiKey: '',
    dailyLimitPerStudent: 10,
    maxMessagesPerSession: 20,
    maxSessionsPerWork: 3,
    allowedHours: 'always'
  };

  /**
   * ë˜ë¦¬ ì„¤ì • í™”ë©´ ë Œë”ë§
   */
  async function renderTtoriSettings(container) {
    // í˜„ì¬ ì„¤ì • ë¡œë“œ
    try {
      const result = await callApi('getAiSettings');
      if (result.success) {
        aiSettingsData = result.data;
      }
    } catch (error) {
      console.error('AI ì„¤ì • ë¡œë“œ ì‹¤íŒ¨:', error);
    }

    container.innerHTML = `
      <div class="container fade-in">
        ${renderTeacherHeader('AI ë„ìš°ë¯¸ ì„¤ì •', 'ttori-settings')}

        <!-- ì•ˆë‚´ ì¹´ë“œ -->
        <div class="card mb-3" style="background: linear-gradient(135deg, #fff9e6 0%, #fff3cd 100%); border-left: 4px solid #FFD93D;">
          <div class="flex gap-3 items-start">
            <span style="font-size: 2.5rem;">ğŸ¤</span>
            <div>
              <h3 style="margin: 0 0 8px 0;">ë˜ë¦¬ AI ë„ìš°ë¯¸</h3>
              <p style="margin: 0; color: var(--text-light);">
                "ë˜ë¦¬"ëŠ” í•™ìƒë“¤ì´ ìŠ¤í† ë¦¬ë¥¼ ë§Œë“¤ ë•Œ ë„ì›€ì„ ì£¼ëŠ” AI ë„ìš°ë¯¸ì˜ˆìš”.<br>
                <strong>ì„¤ì •í•˜ì§€ ì•Šì•„ë„ ëª¨ë“  í•µì‹¬ ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</strong>
              </p>
            </div>
          </div>
        </div>

        <!-- AI í™œì„±í™” í† ê¸€ -->
        <div class="card mb-3">
          <div class="flex justify-between items-center">
            <div>
              <h4 style="margin: 0;">AI ë„ìš°ë¯¸ ì‚¬ìš©</h4>
              <p style="margin: 4px 0 0 0; color: var(--text-light); font-size: 0.9rem;">
                í•™ìƒë“¤ì´ ë˜ë¦¬ì—ê²Œ ë„ì›€ì„ ìš”ì²­í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
              </p>
            </div>
            <label class="toggle-switch">
              <input type="checkbox" id="ai-enabled" ${aiSettingsData.aiEnabled ? 'checked' : ''} onchange="toggleAiEnabled()">
              <span class="toggle-slider"></span>
            </label>
          </div>
        </div>

        <!-- API í‚¤ ì„¤ì • (AI í™œì„±í™” ì‹œì—ë§Œ í‘œì‹œ) -->
        <div id="ai-settings-detail" style="display: ${aiSettingsData.aiEnabled ? 'block' : 'none'};">
          <!-- API í‚¤ ì…ë ¥ -->
          <div class="card mb-3">
            <h4 style="margin: 0 0 16px 0;">ğŸ”‘ Google AI API í‚¤</h4>

            <div class="form-group">
              <div class="flex gap-2">
                <input type="password" id="ai-api-key" class="form-input" style="flex: 1;"
                       placeholder="API í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
                       value="${escapeHtml(aiSettingsData.aiApiKey || '')}">
                <button class="btn btn-outline" onclick="toggleApiKeyVisibility()">ğŸ‘ï¸</button>
                <button class="btn btn-primary" onclick="testApiKey()">í…ŒìŠ¤íŠ¸</button>
              </div>
              <div id="api-key-status" class="mt-2"></div>
            </div>

            <!-- API í‚¤ ë°œê¸‰ ì•ˆë‚´ -->
            <div style="background: var(--bg); padding: 16px; border-radius: 8px; margin-top: 16px;">
              <h5 style="margin: 0 0 12px 0;">ğŸ“– API í‚¤ ë°œê¸‰ ë°©ë²• (3ë¶„ì´ë©´ ì™„ë£Œ!)</h5>

              <ol style="margin: 0; padding-left: 20px; color: var(--text-light);">
                <li style="margin-bottom: 8px;">
                  <a href="https://aistudio.google.com/apikey" target="_blank" style="color: var(--primary); font-weight: 500;">
                    ğŸ‘‰ Google AI Studio ì ‘ì†
                  </a>
                </li>
                <li style="margin-bottom: 8px;">
                  "API í‚¤ ë§Œë“¤ê¸°" ë²„íŠ¼ í´ë¦­
                </li>
                <li>
                  ìƒì„±ëœ í‚¤ë¥¼ ë³µì‚¬í•´ì„œ ìœ„ì— ë¶™ì—¬ë„£ê¸°
                </li>
              </ol>

              <div style="margin-top: 12px; padding: 8px 12px; background: #e8f5e9; border-radius: 6px;">
                <strong>ğŸ’° ì˜ˆìƒ ë¹„ìš©:</strong> í•™ê¸‰ë‹¹ ì›” 100ì› ë¯¸ë§Œ (ê±°ì˜ ë¬´ë£Œ!)
              </div>
            </div>
          </div>

          <!-- ë‚¨ìš© ë°©ì§€ ì„¤ì • -->
          <div class="card mb-3">
            <h4 style="margin: 0 0 16px 0;">âš™ï¸ ì‚¬ìš©ëŸ‰ ì œí•œ ì„¤ì •</h4>

            <div class="form-group">
              <label class="form-label">í•™ìƒë‹¹ ì¼ì¼ ëŒ€í™” íšŸìˆ˜</label>
              <select id="ai-daily-limit" class="form-input" onchange="updateAiSetting('dailyLimitPerStudent', this.value)">
                <option value="5" ${aiSettingsData.dailyLimitPerStudent == 5 ? 'selected' : ''}>5íšŒ</option>
                <option value="10" ${aiSettingsData.dailyLimitPerStudent == 10 ? 'selected' : ''}>10íšŒ (ê¶Œì¥)</option>
                <option value="20" ${aiSettingsData.dailyLimitPerStudent == 20 ? 'selected' : ''}>20íšŒ</option>
                <option value="30" ${aiSettingsData.dailyLimitPerStudent == 30 ? 'selected' : ''}>30íšŒ</option>
                <option value="50" ${aiSettingsData.dailyLimitPerStudent == 50 ? 'selected' : ''}>50íšŒ</option>
              </select>
            </div>

            <div class="form-group">
              <label class="form-label">AI ì‚¬ìš© ê°€ëŠ¥ ì‹œê°„</label>
              <select id="ai-allowed-hours" class="form-input" onchange="updateAiSetting('allowedHours', this.value)">
                <option value="always" ${aiSettingsData.allowedHours === 'always' ? 'selected' : ''}>í•­ìƒ í—ˆìš©</option>
                <option value="school" ${aiSettingsData.allowedHours === 'school' ? 'selected' : ''}>ìˆ˜ì—… ì‹œê°„ë§Œ (09:00~15:00)</option>
              </select>
            </div>

            <div class="form-group">
              <label class="form-label">ëŒ€í™”ë‹¹ ìµœëŒ€ ë©”ì‹œì§€ ìˆ˜</label>
              <select id="ai-max-messages" class="form-input" onchange="updateAiSetting('maxMessagesPerSession', this.value)">
                <option value="10" ${aiSettingsData.maxMessagesPerSession == 10 ? 'selected' : ''}>10ê°œ</option>
                <option value="20" ${aiSettingsData.maxMessagesPerSession == 20 ? 'selected' : ''}>20ê°œ (ê¶Œì¥)</option>
                <option value="30" ${aiSettingsData.maxMessagesPerSession == 30 ? 'selected' : ''}>30ê°œ</option>
                <option value="50" ${aiSettingsData.maxMessagesPerSession == 50 ? 'selected' : ''}>50ê°œ</option>
              </select>
            </div>
          </div>

          <!-- ì‚¬ìš©ëŸ‰ í†µê³„ -->
          <div class="card mb-3">
            <div class="flex justify-between items-center mb-2">
              <h4 style="margin: 0;">ğŸ“Š ì‚¬ìš©ëŸ‰ í†µê³„</h4>
              <button class="btn btn-sm btn-ghost" onclick="refreshAiUsageStats()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
            </div>
            <div id="ai-usage-stats">
              <p style="color: var(--text-light); text-align: center; padding: 20px;">
                í†µê³„ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
              </p>
            </div>
          </div>
        </div>

        <!-- ì €ì¥ ë²„íŠ¼ -->
        <div class="flex gap-2 justify-end">
          <button class="btn btn-ghost" onclick="navigateTo('teacher-dashboard')">
            â† ëŒì•„ê°€ê¸°
          </button>
          <button class="btn btn-primary" onclick="saveAiSettings()">
            ğŸ’¾ ì„¤ì • ì €ì¥
          </button>
        </div>
      </div>

      <style>
        .toggle-switch {
          position: relative;
          display: inline-block;
          width: 56px;
          height: 30px;
        }

        .toggle-switch input {
          opacity: 0;
          width: 0;
          height: 0;
        }

        .toggle-slider {
          position: absolute;
          cursor: pointer;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background-color: #ccc;
          transition: 0.3s;
          border-radius: 30px;
        }

        .toggle-slider:before {
          position: absolute;
          content: "";
          height: 22px;
          width: 22px;
          left: 4px;
          bottom: 4px;
          background-color: white;
          transition: 0.3s;
          border-radius: 50%;
        }

        input:checked + .toggle-slider {
          background-color: #FFD93D;
        }

        input:checked + .toggle-slider:before {
          transform: translateX(26px);
        }

        .usage-stat-card {
          background: var(--bg);
          padding: 16px;
          border-radius: 8px;
          text-align: center;
        }

        .usage-stat-value {
          font-size: 2rem;
          font-weight: 700;
          color: var(--primary);
        }

        .usage-stat-label {
          font-size: 0.85rem;
          color: var(--text-light);
        }
      </style>
    `;

    // ì‚¬ìš©ëŸ‰ í†µê³„ ë¡œë“œ
    if (aiSettingsData.aiEnabled) {
      refreshAiUsageStats();
    }
  }

  /**
   * AI í™œì„±í™” í† ê¸€
   */
  function toggleAiEnabled() {
    const enabled = document.getElementById('ai-enabled').checked;
    aiSettingsData.aiEnabled = enabled;

    const detailSection = document.getElementById('ai-settings-detail');
    if (detailSection) {
      detailSection.style.display = enabled ? 'block' : 'none';
    }

    if (enabled) {
      refreshAiUsageStats();
    }
  }

  /**
   * API í‚¤ í‘œì‹œ/ìˆ¨ê¹€ í† ê¸€
   */
  function toggleApiKeyVisibility() {
    const input = document.getElementById('ai-api-key');
    if (input.type === 'password') {
      input.type = 'text';
    } else {
      input.type = 'password';
    }
  }

  /**
   * API í‚¤ í…ŒìŠ¤íŠ¸
   */
  async function testApiKey() {
    const apiKey = document.getElementById('ai-api-key').value.trim();
    const statusDiv = document.getElementById('api-key-status');

    if (!apiKey) {
      statusDiv.innerHTML = '<span style="color: var(--error);">âŒ API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</span>';
      return;
    }

    statusDiv.innerHTML = '<span style="color: var(--text-light);">ğŸ”„ í…ŒìŠ¤íŠ¸ ì¤‘...</span>';

    try {
      const result = await callApi('testAiApiKey', { apiKey: apiKey });

      if (result.success) {
        statusDiv.innerHTML = '<span style="color: var(--success);">âœ… API í‚¤ê°€ ìœ íš¨í•©ë‹ˆë‹¤!</span>';
        aiSettingsData.aiApiKey = apiKey;
      } else {
        statusDiv.innerHTML = `<span style="color: var(--error);">âŒ ${result.error || 'API í‚¤ê°€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.'}</span>`;
      }
    } catch (error) {
      statusDiv.innerHTML = '<span style="color: var(--error);">âŒ í…ŒìŠ¤íŠ¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</span>';
    }
  }

  /**
   * AI ì„¤ì • ê°’ ì—…ë°ì´íŠ¸
   */
  function updateAiSetting(key, value) {
    aiSettingsData[key] = isNaN(value) ? value : parseInt(value);
  }

  /**
   * AI ì„¤ì • ì €ì¥
   */
  async function saveAiSettings() {
    // API í‚¤ ê°’ ì—…ë°ì´íŠ¸
    aiSettingsData.aiApiKey = document.getElementById('ai-api-key')?.value.trim() || '';

    try {
      showLoading('ì €ì¥ ì¤‘...');

      const result = await callApi('saveAiSettings', { settings: aiSettingsData });

      if (result.success) {
        showToast('ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
      } else {
        showToast(result.error || 'ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
      }
    } catch (error) {
      showToast('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
    }
  }

  /**
   * ì‚¬ìš©ëŸ‰ í†µê³„ ìƒˆë¡œê³ ì¹¨
   */
  async function refreshAiUsageStats() {
    const container = document.getElementById('ai-usage-stats');
    if (!container) return;

    try {
      const result = await callApi('getAiUsageStats');

      if (result.success) {
        const stats = result.data;

        container.innerHTML = `
          <div class="flex gap-3" style="flex-wrap: wrap;">
            <div class="usage-stat-card" style="flex: 1; min-width: 100px;">
              <div class="usage-stat-value">${stats.todayUsage}</div>
              <div class="usage-stat-label">ì˜¤ëŠ˜ ì‚¬ìš©</div>
            </div>
            <div class="usage-stat-card" style="flex: 1; min-width: 100px;">
              <div class="usage-stat-value">${stats.totalUsage}</div>
              <div class="usage-stat-label">ì´ ì‚¬ìš©</div>
            </div>
            <div class="usage-stat-card" style="flex: 1; min-width: 100px;">
              <div class="usage-stat-value">${stats.students.length}</div>
              <div class="usage-stat-label">ì‚¬ìš© í•™ìƒ</div>
            </div>
          </div>

          ${stats.students.length > 0 ? `
            <div style="margin-top: 16px;">
              <h5 style="margin: 0 0 8px 0;">í•™ìƒë³„ ì‚¬ìš©ëŸ‰ (ì˜¤ëŠ˜)</h5>
              <div style="max-height: 200px; overflow-y: auto;">
                ${stats.students.slice(0, 10).map(s => `
                  <div class="flex justify-between items-center" style="padding: 8px; background: var(--bg); border-radius: 6px; margin-bottom: 4px;">
                    <span>${escapeHtml(s.name)}</span>
                    <span style="font-weight: 600;">${s.today}íšŒ</span>
                  </div>
                `).join('')}
              </div>
            </div>
          ` : ''}
        `;
      } else {
        container.innerHTML = '<p style="color: var(--error);">í†µê³„ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</p>';
      }
    } catch (error) {
      container.innerHTML = '<p style="color: var(--error);">í†µê³„ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</p>';
    }
  }
</script>
