<script>
  /* ============================================
     êµì‚¬ ëŒ€ì‹œë³´ë“œ
     ============================================ */

  let dashboardData = {};

  async function renderTeacherDashboard(container) {
    try {
      // ë°ì´í„° ë¡œë“œ
      const [systemInfo, students] = await Promise.all([
        callApi('getSystemInfo'),
        callApi('getStudents')
      ]);

      dashboardData = {
        systemInfo: systemInfo,
        students: students.data || []
      };
    } catch (error) {
      console.error('ëŒ€ì‹œë³´ë“œ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
      dashboardData = { systemInfo: {}, students: [] };
    }

    const { systemInfo, students } = dashboardData;

    container.innerHTML = `
      <div class="container fade-in">
        ${renderTeacherHeader('', 'dashboard')}

        <!-- í†µê³„ ì¹´ë“œ -->
        <div class="flex gap-2 mb-3" style="flex-wrap: wrap;">
          ${renderStatCard('ğŸ‘¨â€ğŸ“', 'ì „ì²´ í•™ìƒ', systemInfo.totalStudents || 0, 'primary')}
          ${renderStatCard('âœ…', 'í™œì„± í•™ìƒ', systemInfo.activeStudents || 0, 'secondary')}
          ${renderStatCard('â³', 'PIN ëŒ€ê¸°', systemInfo.pendingStudents || 0, 'warning')}
        </div>

        <!-- ë¹ ë¥¸ ì•¡ì…˜ -->
        <div class="card mb-3">
          <h3 style="margin-bottom: 16px;">âš¡ ë¹ ë¥¸ ì‹¤í–‰</h3>
          <div class="flex gap-2" style="flex-wrap: wrap;">
            <button class="btn btn-primary" onclick="showAddStudentModal()">
              ğŸ‘¨â€ğŸ“ í•™ìƒ ë“±ë¡
            </button>
            <button class="btn btn-outline" onclick="showImportStudentsModal()">
              ğŸ“‹ ëª…ë‹¨ ì¼ê´„ ë“±ë¡
            </button>
            <button class="btn btn-outline" onclick="navigateTo('teacher-qr')">
              ğŸ“± QR ì½”ë“œ
            </button>
            <button class="btn btn-outline" onclick="copyClassUrl()">
              ğŸ”— URL ë³µì‚¬
            </button>
          </div>
        </div>

        <!-- í•™ìƒ ëª©ë¡ -->
        <div class="card">
          <div class="flex justify-between items-center mb-2">
            <h3>ğŸ‘¨â€ğŸ“ í•™ìƒ ëª©ë¡</h3>
            <button class="btn btn-sm btn-ghost" onclick="refreshStudentList()">
              ğŸ”„ ìƒˆë¡œê³ ì¹¨
            </button>
          </div>

          <div id="student-list-container">
            ${renderStudentTable(students)}
          </div>
        </div>

        <!-- ì ‘ì† URL ì •ë³´ -->
        <div class="card mt-3" style="background: var(--primary-light);">
          <h4 style="margin-bottom: 8px;">ğŸ”— í•™ìƒ ì ‘ì† URL</h4>
          <div class="flex gap-2 items-center" style="flex-wrap: wrap;">
            <code style="background: white; padding: 8px 12px; border-radius: 8px; font-size: 0.85rem; word-break: break-all; flex: 1;">
              ${escapeHtml(systemInfo.webAppUrl || 'ë¡œë”© ì¤‘...')}
            </code>
            <button class="btn btn-sm btn-primary" onclick="copyClassUrl()">ë³µì‚¬</button>
          </div>
          <p style="color: var(--text-light); font-size: 0.85rem; margin-top: 8px;">
            ì´ URLì„ í•™ìƒë“¤ì—ê²Œ ê³µìœ í•˜ì„¸ìš”. QR ì½”ë“œë„ ì œê³µë©ë‹ˆë‹¤.
          </p>
        </div>
      </div>
    `;
  }

  /**
   * í•™ìƒ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
   */
  async function refreshStudentList() {
    try {
      const result = await callApi('getStudents');

      if (result.success) {
        dashboardData.students = result.data || [];
        const container = document.getElementById('student-list-container');
        container.innerHTML = renderStudentTable(dashboardData.students);
        showToast('ìƒˆë¡œê³ ì¹¨ ì™„ë£Œ!', 'success');
      }
    } catch (error) {
      showToast('ìƒˆë¡œê³ ì¹¨ ì‹¤íŒ¨', 'error');
    }
  }

  /**
   * ë°˜ URL ë³µì‚¬
   */
  function copyClassUrl() {
    const url = dashboardData.systemInfo?.webAppUrl;
    if (url) {
      copyToClipboard(url);
    } else {
      showToast('URLì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.', 'error');
    }
  }

  /**
   * í•™ìƒ ë“±ë¡ ëª¨ë‹¬
   */
  function showAddStudentModal() {
    showModal({
      title: 'ğŸ‘¨â€ğŸ“ í•™ìƒ ë“±ë¡',
      content: `
        <form id="add-student-form" onsubmit="submitAddStudent(event)">
          <div class="form-group">
            <label class="form-label" for="new-student-name">ì´ë¦„ *</label>
            <input type="text" id="new-student-name" class="form-input" placeholder="ì˜ˆ: í™ê¸¸ë™" required>
          </div>

          <div class="form-group">
            <label class="form-label" for="new-student-number">ë²ˆí˜¸ *</label>
            <input type="number" id="new-student-number" class="form-input" placeholder="ì˜ˆ: 15" min="1" max="100" required>
          </div>

          <div class="form-group">
            <label class="form-label" for="new-student-pin">PIN (ì„ íƒ)</label>
            <input type="text" id="new-student-pin" class="form-input" placeholder="ë¹„ì›Œë‘ë©´ í•™ìƒì´ ì§ì ‘ ì„¤ì •" maxlength="6" pattern="[0-9]{6}">
            <p class="form-helper">6ìë¦¬ ìˆ«ì. ë¹„ì›Œë‘ë©´ í•™ìƒì´ ì²« ì ‘ì† ì‹œ ì„¤ì •í•©ë‹ˆë‹¤.</p>
          </div>

          <div id="add-student-error" class="alert alert-error" style="display: none;"></div>
        </form>
      `,
      buttons: [
        { text: 'ì·¨ì†Œ', class: 'btn-outline' },
        { text: 'ë“±ë¡', class: 'btn-primary', onclick: 'submitAddStudent(event)' }
      ]
    });
  }

  /**
   * í•™ìƒ ë“±ë¡ ì œì¶œ
   */
  async function submitAddStudent(event) {
    if (event) event.preventDefault();

    const name = document.getElementById('new-student-name').value.trim();
    const number = parseInt(document.getElementById('new-student-number').value, 10);
    const pin = document.getElementById('new-student-pin').value.trim() || null;
    const errorDiv = document.getElementById('add-student-error');

    try {
      const result = await callApi('registerStudent', { name, number, pin });

      if (result.success) {
        closeModal();
        showToast(`${name} í•™ìƒì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!`, 'success');
        refreshStudentList();
      } else {
        errorDiv.textContent = result.error;
        errorDiv.style.display = 'block';
      }
    } catch (error) {
      errorDiv.textContent = 'ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
      errorDiv.style.display = 'block';
    }
  }

  /**
   * í•™ìƒ ì¼ê´„ ë“±ë¡ ëª¨ë‹¬
   */
  function showImportStudentsModal() {
    showModal({
      title: 'ğŸ“‹ ëª…ë‹¨ ì¼ê´„ ë“±ë¡',
      content: `
        <div class="alert alert-info mb-2">
          <span>ğŸ’¡</span>
          <div>CSV í˜•ì‹ìœ¼ë¡œ í•™ìƒ ëª…ë‹¨ì„ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.<br>
          í˜•ì‹: ì´ë¦„,ë²ˆí˜¸ (í•œ ì¤„ì— í•œ ëª…)</div>
        </div>

        <div class="form-group">
          <label class="form-label">í•™ìƒ ëª…ë‹¨</label>
          <textarea id="import-csv" class="form-input" rows="8"
                    placeholder="ì˜ˆì‹œ:
í™ê¸¸ë™,1
ê¹€ì„œì—°,2
ë°•ì§€í›ˆ,3"></textarea>
        </div>

        <div class="form-group">
          <label class="form-label">PIN ì„¤ì • ë°©ì‹</label>
          <select id="import-pin-mode" class="form-input">
            <option value="student">í•™ìƒì´ ì§ì ‘ ì„¤ì • (ê¶Œì¥)</option>
            <option value="default">ë²ˆí˜¸ë¥¼ 6ìë¦¬ë¡œ (ì˜ˆ: 1 â†’ 000001)</option>
          </select>
        </div>

        <div id="import-error" class="alert alert-error" style="display: none;"></div>
      `,
      buttons: [
        { text: 'ì·¨ì†Œ', class: 'btn-outline' },
        { text: 'ë“±ë¡', class: 'btn-primary', onclick: 'submitImportStudents()' }
      ]
    });
  }

  /**
   * í•™ìƒ ì¼ê´„ ë“±ë¡ ì œì¶œ
   */
  async function submitImportStudents() {
    const csvData = document.getElementById('import-csv').value.trim();
    const pinMode = document.getElementById('import-pin-mode').value;
    const errorDiv = document.getElementById('import-error');

    if (!csvData) {
      errorDiv.textContent = 'í•™ìƒ ëª…ë‹¨ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.';
      errorDiv.style.display = 'block';
      return;
    }

    try {
      const result = await callApi('importStudents', { csvData, pinMode });

      if (result.success) {
        closeModal();

        let message = `${result.added}ëª… ë“±ë¡ ì™„ë£Œ!`;
        if (result.skipped > 0) {
          message += ` (${result.skipped}ëª… ê±´ë„ˆëœ€)`;
        }

        showToast(message, result.skipped > 0 ? 'warning' : 'success');

        if (result.errors && result.errors.length > 0) {
          console.log('ë“±ë¡ ì˜¤ë¥˜:', result.errors);
        }

        refreshStudentList();
      } else {
        errorDiv.textContent = result.error;
        errorDiv.style.display = 'block';
      }
    } catch (error) {
      errorDiv.textContent = 'ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
      errorDiv.style.display = 'block';
    }
  }

  /**
   * PIN ì¬ì„¤ì • ëª¨ë‹¬
   */
  function showResetPinModal(name, number) {
    showModal({
      title: 'ğŸ”‘ PIN ì¬ì„¤ì •',
      content: `
        <p style="margin-bottom: 16px;">
          <strong>${escapeHtml(name)} (${number}ë²ˆ)</strong> í•™ìƒì˜ PINì„ ì¬ì„¤ì •í•©ë‹ˆë‹¤.
        </p>

        <div class="form-group">
          <label class="form-label">ìƒˆ PIN (ìˆ«ì 6ìë¦¬)</label>
          <input type="text" id="reset-pin-value" class="form-input" maxlength="6" pattern="[0-9]{6}" placeholder="000000">
        </div>

        <div id="reset-pin-error" class="alert alert-error" style="display: none;"></div>
      `,
      buttons: [
        { text: 'ì·¨ì†Œ', class: 'btn-outline' },
        { text: 'ì¬ì„¤ì •', class: 'btn-primary', onclick: `submitResetPin('${escapeHtml(name)}', ${number})` }
      ]
    });
  }

  /**
   * PIN ì¬ì„¤ì • ì œì¶œ
   */
  async function submitResetPin(name, number) {
    const newPin = document.getElementById('reset-pin-value').value.trim();
    const errorDiv = document.getElementById('reset-pin-error');

    if (!/^\d{6}$/.test(newPin)) {
      errorDiv.textContent = 'PINì€ ìˆ«ì 6ìë¦¬ì—¬ì•¼ í•©ë‹ˆë‹¤.';
      errorDiv.style.display = 'block';
      return;
    }

    try {
      const result = await callApi('resetPin', { name, number, newPin });

      if (result.success) {
        closeModal();
        showToast('PINì´ ì¬ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
        refreshStudentList();
      } else {
        errorDiv.textContent = result.error;
        errorDiv.style.display = 'block';
      }
    } catch (error) {
      errorDiv.textContent = 'ì¬ì„¤ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
      errorDiv.style.display = 'block';
    }
  }

  /**
   * í•™ìƒ ë©”ë‰´ ëª¨ë‹¬
   */
  function showStudentMenu(name, number, status) {
    const isActive = status === 'active';

    showModal({
      title: `${escapeHtml(name)} (${number}ë²ˆ)`,
      content: `
        <div class="flex flex-col gap-2">
          <button class="btn btn-outline btn-block" onclick="closeModal(); showResetPinModal('${escapeHtml(name)}', ${number});">
            ğŸ”‘ PIN ì¬ì„¤ì •
          </button>
          <button class="btn btn-outline btn-block" onclick="regenerateStudentToken('${escapeHtml(name)}', ${number})">
            ğŸ”„ QR í† í° ì¬ë°œê¸‰
          </button>
          <button class="btn btn-outline btn-block" onclick="toggleStudentStatus('${escapeHtml(name)}', ${number}, '${status}')">
            ${isActive ? 'ğŸš« ë¹„í™œì„±í™”' : 'âœ… í™œì„±í™”'}
          </button>
          <hr style="margin: 8px 0; border: none; border-top: 1px solid var(--border);">
          <button class="btn btn-danger btn-block" onclick="confirmDeleteStudent('${escapeHtml(name)}', ${number})">
            ğŸ—‘ï¸ í•™ìƒ ì‚­ì œ
          </button>
        </div>
      `
    });
  }

  /**
   * QR í† í° ì¬ë°œê¸‰
   */
  async function regenerateStudentToken(name, number) {
    closeModal();

    showConfirm(
      'ìƒˆ QR í† í°ì„ ë°œê¸‰í•˜ë©´ ê¸°ì¡´ QR ì½”ë“œê°€ ë¬´íš¨í™”ë©ë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?',
      async () => {
        try {
          const result = await callApi('regenerateToken', { name, number });

          if (result.success) {
            showToast('ìƒˆ QR í† í°ì´ ë°œê¸‰ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            refreshStudentList();
          } else {
            showToast(result.error || 'í† í° ì¬ë°œê¸‰ ì‹¤íŒ¨', 'error');
          }
        } catch (error) {
          showToast('í† í° ì¬ë°œê¸‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
        }
      }
    );
  }

  /**
   * í•™ìƒ ìƒíƒœ í† ê¸€
   */
  async function toggleStudentStatus(name, number, currentStatus) {
    closeModal();

    const newStatus = currentStatus === 'active' ? 'inactive' : 'active';
    const action = newStatus === 'active' ? 'í™œì„±í™”' : 'ë¹„í™œì„±í™”';

    try {
      const result = await callApi('updateStudentStatus', { name, number, status: newStatus });

      if (result.success) {
        showToast(`í•™ìƒì´ ${action}ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
        refreshStudentList();
      } else {
        showToast(result.error || `${action} ì‹¤íŒ¨`, 'error');
      }
    } catch (error) {
      showToast(`${action} ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.`, 'error');
    }
  }

  /**
   * í•™ìƒ ì‚­ì œ í™•ì¸
   */
  function confirmDeleteStudent(name, number) {
    closeModal();

    showConfirm(
      `ì •ë§ ${name} í•™ìƒì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`,
      async () => {
        try {
          const result = await callApi('deleteStudent', { name, number });

          if (result.success) {
            showToast('í•™ìƒì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            refreshStudentList();
          } else {
            showToast(result.error || 'ì‚­ì œ ì‹¤íŒ¨', 'error');
          }
        } catch (error) {
          showToast('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
        }
      }
    );
  }

  /**
   * í•™ìƒë³„ QR ë‹¤ìš´ë¡œë“œ
   */
  async function downloadStudentQR(name, number, token) {
    const webAppUrl = dashboardData.systemInfo?.webAppUrl;
    if (!webAppUrl || !token) {
      showToast('QR ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
      return;
    }

    const qrUrl = `${webAppUrl}?token=${token}`;

    try {
      const dataUrl = await QRCode.toDataURL(qrUrl, {
        width: 300,
        margin: 2,
        color: { dark: '#2C3E50', light: '#FFFFFF' }
      });

      // ë‹¤ìš´ë¡œë“œ
      const link = document.createElement('a');
      link.download = `QR_${name}_${number}ë²ˆ.png`;
      link.href = dataUrl;
      link.click();

      showToast('QR ì½”ë“œê°€ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
    } catch (error) {
      showToast('QR ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
    }
  }

  /* ============================================
     êµì‚¬ í•™ìƒ ê´€ë¦¬ (ë³„ë„ í˜ì´ì§€)
     ============================================ */

  async function renderTeacherStudents(container) {
    // ëŒ€ì‹œë³´ë“œì™€ ë™ì¼í•œ ë°ì´í„° ì‚¬ìš©
    await renderTeacherDashboard(container);
  }

  /* ============================================
     êµì‚¬ QR ê´€ë¦¬
     ============================================ */

  async function renderTeacherQR(container) {
    const systemInfo = dashboardData.systemInfo || await callApi('getSystemInfo');
    const students = dashboardData.students || (await callApi('getStudents')).data || [];

    container.innerHTML = `
      <div class="container fade-in">
        ${renderTeacherHeader('QR ì½”ë“œ ê´€ë¦¬', 'qr')}

        <!-- ë°˜ ì „ì²´ QR -->
        <div class="card mb-3">
          <h3 style="margin-bottom: 16px;">ğŸ“± ë°˜ ì „ì²´ QR ì½”ë“œ</h3>
          <p style="color: var(--text-light); margin-bottom: 16px;">
            ì´ QRì„ êµì‹¤ì— ë¶™ì—¬ë‘ë©´ í•™ìƒë“¤ì´ ìŠ¤ìº”í•˜ì—¬ ì ‘ì†í•  ìˆ˜ ìˆì–´ìš”.
          </p>

          <div class="flex gap-3" style="flex-wrap: wrap; align-items: flex-start;">
            <div id="class-qr" style="background: white; padding: 16px; border-radius: 12px; box-shadow: var(--shadow-sm);">
              <!-- QR ì½”ë“œê°€ ì—¬ê¸°ì— ë Œë”ë§ë¨ -->
            </div>
            <div style="flex: 1; min-width: 200px;">
              <p style="margin-bottom: 8px;"><strong>ì ‘ì† URL:</strong></p>
              <code style="display: block; background: var(--bg); padding: 12px; border-radius: 8px; word-break: break-all; font-size: 0.85rem;">
                ${escapeHtml(systemInfo.webAppUrl || '')}
              </code>
              <div class="flex gap-2 mt-2">
                <button class="btn btn-sm btn-primary" onclick="downloadClassQR()">
                  QR ë‹¤ìš´ë¡œë“œ
                </button>
                <button class="btn btn-sm btn-outline" onclick="copyClassUrl()">
                  URL ë³µì‚¬
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- í•™ìƒë³„ QR -->
        <div class="card">
          <div class="flex justify-between items-center mb-2">
            <h3>ğŸ‘¨â€ğŸ“ í•™ìƒë³„ QR ì½”ë“œ</h3>
            <button class="btn btn-sm btn-primary" onclick="downloadAllStudentQRs()">
              ğŸ“¥ ì „ì²´ ë‹¤ìš´ë¡œë“œ (PDF)
            </button>
          </div>
          <p style="color: var(--text-light); margin-bottom: 16px;">
            í•™ìƒë³„ QR ì½”ë“œë¥¼ ì¶œë ¥í•˜ì—¬ ë°°í¬í•˜ë©´ PIN ì—†ì´ ë°”ë¡œ ì ‘ì†í•  ìˆ˜ ìˆì–´ìš”.
          </p>

          ${students.length === 0 ? renderEmptyState('ğŸ‘¨â€ğŸ“', 'ë“±ë¡ëœ í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤', 'í•™ìƒì„ ë¨¼ì € ë“±ë¡í•´ì£¼ì„¸ìš”.') : `
            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 16px;">
              ${students.filter(s => s.status === 'active').map(student => `
                <div class="card" style="padding: 12px; text-align: center;">
                  <div id="student-qr-${student.number}" style="margin-bottom: 8px;"></div>
                  <p style="font-weight: 600;">${escapeHtml(student.name)}</p>
                  <p style="color: var(--text-light); font-size: 0.85rem;">${student.number}ë²ˆ</p>
                  <button class="btn btn-sm btn-ghost mt-1" onclick="downloadStudentQR('${escapeHtml(student.name)}', ${student.number}, '${student.token}')">
                    ë‹¤ìš´ë¡œë“œ
                  </button>
                </div>
              `).join('')}
            </div>
          `}
        </div>
      </div>
    `;

    // QR ì½”ë“œ ìƒì„±
    if (systemInfo.webAppUrl) {
      generateQRCode(systemInfo.webAppUrl, 'class-qr', 200);

      // í•™ìƒë³„ QR ìƒì„±
      students.filter(s => s.status === 'active').forEach(student => {
        const qrUrl = `${systemInfo.webAppUrl}?token=${student.token}`;
        generateQRCode(qrUrl, `student-qr-${student.number}`, 120);
      });
    }
  }

  /**
   * ë°˜ QR ë‹¤ìš´ë¡œë“œ
   */
  async function downloadClassQR() {
    const webAppUrl = dashboardData.systemInfo?.webAppUrl;
    if (!webAppUrl) {
      showToast('URLì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
      return;
    }

    try {
      const dataUrl = await QRCode.toDataURL(webAppUrl, {
        width: 400,
        margin: 2,
        color: { dark: '#2C3E50', light: '#FFFFFF' }
      });

      const link = document.createElement('a');
      link.download = 'QR_ë°˜ì „ì²´.png';
      link.href = dataUrl;
      link.click();

      showToast('QR ì½”ë“œê°€ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
    } catch (error) {
      showToast('QR ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
    }
  }

  /**
   * ì „ì²´ í•™ìƒ QR ë‹¤ìš´ë¡œë“œ (ê°„ë‹¨ ë²„ì „ - ê°œë³„ ë‹¤ìš´ë¡œë“œ)
   */
  async function downloadAllStudentQRs() {
    const students = dashboardData.students || [];
    const activeStudents = students.filter(s => s.status === 'active');

    if (activeStudents.length === 0) {
      showToast('ë‹¤ìš´ë¡œë“œí•  í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤.', 'warning');
      return;
    }

    showToast(`${activeStudents.length}ê°œì˜ QR ì½”ë“œë¥¼ ë‹¤ìš´ë¡œë“œí•©ë‹ˆë‹¤...`, 'info');

    for (const student of activeStudents) {
      await downloadStudentQR(student.name, student.number, student.token);
      await new Promise(resolve => setTimeout(resolve, 500)); // ë”œë ˆì´
    }
  }

  /* ============================================
     êµì‚¬ ì„¤ì •
     ============================================ */

  async function renderTeacherSettings(container) {
    const settings = AppState.settings || await callApi('getSettings');

    container.innerHTML = `
      <div class="container fade-in">
        ${renderTeacherHeader('ì„¤ì •', 'settings')}

        <div class="card">
          <h3 style="margin-bottom: 20px;">âš™ï¸ ê¸°ë³¸ ì„¤ì •</h3>

          <form id="settings-form" onsubmit="saveSettingsForm(event)">
            <div class="form-group">
              <label class="form-label">ì„ ìƒë‹˜ ì„±í•¨</label>
              <input type="text" id="setting-teacherName" class="form-input" value="${escapeHtml(settings.teacherName || '')}">
            </div>

            <div class="form-group">
              <label class="form-label">í•™êµ ì´ë¦„</label>
              <input type="text" id="setting-schoolName" class="form-input" value="${escapeHtml(settings.schoolName || '')}">
            </div>

            <div class="form-group">
              <label class="form-label">í•™ê¸‰</label>
              <input type="text" id="setting-className" class="form-input" value="${escapeHtml(settings.className || '')}">
            </div>

            <div class="form-group">
              <label class="form-label">í™˜ì˜ ë©”ì‹œì§€</label>
              <textarea id="setting-welcomeMessage" class="form-input" rows="2">${escapeHtml(settings.welcomeMessage || '')}</textarea>
            </div>

            <button type="submit" class="btn btn-primary">
              ì €ì¥í•˜ê¸°
            </button>
          </form>
        </div>

        <div class="card mt-3">
          <h3 style="margin-bottom: 16px;">ğŸ“Š ì‹œìŠ¤í…œ ì •ë³´</h3>
          <table class="table">
            <tr><td>ë²„ì „</td><td>${escapeHtml(settings.version || VERSION)}</td></tr>
            <tr><td>ìƒì„±ì¼</td><td>${formatDate(settings.createdAt)}</td></tr>
          </table>
        </div>
      </div>
    `;
  }

  /**
   * ì„¤ì • ì €ì¥
   */
  async function saveSettingsForm(event) {
    event.preventDefault();

    const newSettings = {
      teacherName: document.getElementById('setting-teacherName').value.trim(),
      schoolName: document.getElementById('setting-schoolName').value.trim(),
      className: document.getElementById('setting-className').value.trim(),
      welcomeMessage: document.getElementById('setting-welcomeMessage').value.trim()
    };

    try {
      const result = await callApi('saveSettings', { settings: newSettings });

      if (result.success) {
        AppState.settings = { ...AppState.settings, ...newSettings };
        showToast('ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
      } else {
        showToast(result.error || 'ì €ì¥ ì‹¤íŒ¨', 'error');
      }
    } catch (error) {
      showToast('ì„¤ì • ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
    }
  }
</script>
