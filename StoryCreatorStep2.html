<script>
  /* ============================================
     ìŠ¤í† ë¦¬ í¬ë¦¬ì—ì´í„° - STEP 2: ì¥ë©´ í™•ì¥í•˜ê¸°
     - Step 1ì˜ 4ì»·ì„ ê¸°ë°˜ìœ¼ë¡œ ì¥ë©´ ì¶”ê°€/ì‚­ì œ/ìˆœì„œë³€ê²½
     ============================================ */

  // ìƒìˆ˜ ì •ì˜
  const MAX_SCENES_LIMIT = 20;
  const AUTO_SAVE_INTERVAL_MS = 30000;

  let step2Data = {
    studentName: '',
    studentNumber: 0,
    originalPanels: [],  // Step 1ì—ì„œ ê°€ì ¸ì˜¨ ì›ë³¸ 4ì»·
    scenes: [],          // í™•ì¥ëœ ì¥ë©´ë“¤
    title: ''
  };

  // ë“œë˜ê·¸ ìƒíƒœ
  let draggedSceneIndex = null;

  // ì €ì¥ ì¤‘ í”Œë˜ê·¸ (Race Condition ë°©ì§€)
  let isSaving = false;

  async function renderStoryCreatorStep2(container, data) {
    step2Data.studentName = data?.studentName || AppState.currentUser?.name;
    step2Data.studentNumber = data?.studentNumber || AppState.currentUser?.number;

    // Step 1 ë°ì´í„° ë¡œë“œ
    try {
      showLoading('Step 1 ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...');
      const step1Result = await callApi('getWork', {
        studentName: step2Data.studentName,
        studentNumber: step2Data.studentNumber,
        step: 1
      });

      if (step1Result.success && step1Result.data) {
        step2Data.originalPanels = step1Result.data.workData?.panels || [];
        step2Data.title = step1Result.data.workData?.title || '';
      } else {
        hideLoading();
        showToast('Step 1 ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € Step 1ì„ ì™„ë£Œí•´ì£¼ì„¸ìš”.', 'error');
        navigateTo('student-main');
        return;
      }
    } catch (error) {
      console.error('Step 1 ë¡œë“œ ì‹¤íŒ¨:', error);
      hideLoading();
      showToast('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨', 'error');
      navigateTo('student-main');
      return;
    } finally {
      hideLoading();
    }

    // ê¸°ì¡´ Step 2 ë°ì´í„°ê°€ ìˆëŠ”ì§€ í™•ì¸
    if (data?.existingWork?.workData?.scenes) {
      step2Data.scenes = data.existingWork.workData.scenes;
    } else {
      // Step 1 íŒ¨ë„ì„ ê¸°ë³¸ ì¥ë©´ìœ¼ë¡œ ë³€í™˜
      step2Data.scenes = step2Data.originalPanels.map((panel, index) => ({
        id: generateSceneId(),
        originalPanelId: panel.id,
        stageName: panel.stageName,
        description: panel.description,
        dialogue: panel.dialogue,
        isOriginal: true,  // Step 1ì—ì„œ ì˜¨ ê¸°ë³¸ ì¥ë©´
        order: index + 1
      }));
    }

    renderStep2UI(container);
  }

  function generateSceneId() {
    return 'scene_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
  }

  function renderStep2UI(container) {
    container.innerHTML = `
      <div class="container fade-in">
        ${renderStudentHeader('STEP 2: ì¥ë©´ í™•ì¥í•˜ê¸°')}

        <!-- ì•ˆë‚´ ì¹´ë“œ -->
        <div class="card mb-3" style="background: linear-gradient(135deg, #e8f4fd 0%, #f0f7ff 100%);">
          <div class="flex items-center gap-3">
            <span style="font-size: 2rem;">ğŸ¬</span>
            <div>
              <h3 style="margin: 0 0 4px 0;">Step 1ì˜ ì´ì•¼ê¸°ë¥¼ ë” í’ì„±í•˜ê²Œ!</h3>
              <p style="margin: 0; color: var(--text-light); font-size: 0.9rem;">
                ì¥ë©´ ì‚¬ì´ì— ìƒˆë¡œìš´ ì¥ë©´ì„ ì¶”ê°€í•˜ê±°ë‚˜ ìˆœì„œë¥¼ ë°”ê¿”ë³´ì„¸ìš”.
              </p>
            </div>
          </div>
        </div>

        <!-- ì œëª© -->
        <div class="card mb-3">
          <div class="flex justify-between items-center">
            <div style="flex: 1;">
              <h3 style="margin: 0 0 8px 0;">ğŸ“– ${escapeHtml(step2Data.title)}</h3>
              <span class="badge" id="scene-count-badge" style="background: var(--primary-light); color: var(--primary);">
                ì´ ${step2Data.scenes.length}ê°œ ì¥ë©´
              </span>
              <span class="badge" style="background: #f0f0f0; color: var(--text-muted); margin-left: 4px;">
                ìµœëŒ€ ${MAX_SCENES_LIMIT}ê°œ
              </span>
            </div>
            <div class="flex gap-2">
              <button class="btn btn-outline" id="btn-save-step2" onclick="saveStep2(false)">
                ğŸ’¾ ì €ì¥í•˜ê¸°
              </button>
              <button class="btn btn-primary" id="btn-submit-step2" onclick="saveStep2(true)">
                ğŸ“® ì œì¶œí•˜ê¸°
              </button>
            </div>
          </div>
        </div>

        <!-- ì¥ë©´ ëª©ë¡ -->
        <div id="scenes-container" class="scenes-container">
          ${renderScenesList()}
        </div>

        <!-- í•˜ë‹¨ ë²„íŠ¼ -->
        <div class="flex justify-between mt-3">
          <button class="btn btn-ghost" onclick="confirmExitStep2()">
            â† ëŒì•„ê°€ê¸°
          </button>
          <button class="btn btn-outline" onclick="previewStep2()">
            ğŸ‘ï¸ ë¯¸ë¦¬ë³´ê¸°
          </button>
        </div>
      </div>

      <style>
        .scenes-container {
          display: flex;
          flex-direction: column;
          gap: 8px;
        }

        .scene-card {
          background: var(--card);
          border-radius: var(--radius);
          box-shadow: var(--shadow);
          transition: all 0.2s;
          border: 2px solid transparent;
        }

        .scene-card.dragging {
          opacity: 0.5;
          border-color: var(--primary);
        }

        .scene-card.drag-over {
          border-color: var(--primary);
          transform: scale(1.02);
        }

        .scene-card.original {
          border-left: 4px solid var(--primary);
        }

        .scene-card.added {
          border-left: 4px solid var(--success);
        }

        .scene-header {
          display: flex;
          align-items: center;
          gap: 12px;
          padding: 16px;
          cursor: grab;
          background: var(--bg);
          border-radius: var(--radius) var(--radius) 0 0;
        }

        .scene-header:active {
          cursor: grabbing;
        }

        .scene-drag-handle {
          color: var(--text-muted);
          font-size: 1.2rem;
          padding: 4px;
          border-radius: 4px;
          transition: background 0.2s;
        }

        .scene-drag-handle:hover {
          background: var(--primary-light);
          color: var(--primary);
        }

        .scene-number {
          width: 32px;
          height: 32px;
          background: var(--primary);
          color: white;
          border-radius: 50%;
          display: flex;
          align-items: center;
          justify-content: center;
          font-weight: 700;
          font-size: 0.9rem;
        }

        .scene-badge {
          font-size: 0.75rem;
          padding: 2px 8px;
          border-radius: 12px;
        }

        .scene-badge.original {
          background: var(--primary-light);
          color: var(--primary);
        }

        .scene-badge.added {
          background: #dcfce7;
          color: #16a34a;
        }

        .scene-actions {
          margin-left: auto;
          display: flex;
          gap: 8px;
        }

        .scene-body {
          padding: 16px;
        }

        .scene-textarea {
          width: 100%;
          min-height: 80px;
          padding: 12px;
          border: 2px solid var(--border);
          border-radius: var(--radius-sm);
          font-family: inherit;
          font-size: 0.95rem;
          resize: vertical;
          transition: var(--transition);
        }

        .scene-textarea:focus {
          outline: none;
          border-color: var(--primary);
        }

        /* ë¹ˆ ì¥ë©´ í•˜ì´ë¼ì´íŠ¸ */
        .scene-textarea.error {
          border-color: var(--danger);
          background: #fef2f2;
          animation: shake 0.3s ease-in-out;
        }

        @keyframes shake {
          0%, 100% { transform: translateX(0); }
          25% { transform: translateX(-4px); }
          75% { transform: translateX(4px); }
        }

        /* ì¥ë©´ ì¶”ê°€ ë²„íŠ¼ */
        .add-scene-btn {
          display: flex;
          align-items: center;
          justify-content: center;
          gap: 8px;
          padding: 12px;
          border: 2px dashed var(--border);
          border-radius: var(--radius);
          background: transparent;
          color: var(--text-light);
          cursor: pointer;
          transition: all 0.2s;
          width: 100%;
        }

        .add-scene-btn:hover {
          border-color: var(--primary);
          color: var(--primary);
          background: var(--primary-light);
        }

        .add-scene-btn:disabled {
          opacity: 0.4;
          cursor: not-allowed;
          border-color: var(--border);
          color: var(--text-muted);
          background: transparent;
        }

        /* ìˆœì„œ ë³€ê²½ ë²„íŠ¼ */
        .move-btn {
          padding: 4px 8px;
          background: var(--bg);
          border: 1px solid var(--border);
          border-radius: 4px;
          cursor: pointer;
          font-size: 0.9rem;
        }

        .move-btn:hover {
          background: var(--primary-light);
          border-color: var(--primary);
        }

        .move-btn:disabled {
          opacity: 0.3;
          cursor: not-allowed;
        }

        /* ì¥ë©´ ì´ë¦„ ì…ë ¥ í•„ë“œ */
        .scene-title-input {
          font-weight: 600;
          font-size: 1rem;
          border: 1px solid transparent;
          background: transparent;
          padding: 4px 8px;
          border-radius: 4px;
          width: 150px;
        }

        .scene-title-input:hover {
          border-color: var(--border);
          background: var(--bg);
        }

        .scene-title-input:focus {
          outline: none;
          border-color: var(--primary);
          background: white;
        }
      </style>
    `;

    setupDragAndDrop();
    startAutoSaveStep2();
  }

  function renderScenesList() {
    let html = '';
    const canAddMore = step2Data.scenes.length < MAX_SCENES_LIMIT;

    step2Data.scenes.forEach((scene, index) => {
      html += `
        <!-- ì¥ë©´ ìœ„ì— ì¶”ê°€ ë²„íŠ¼ -->
        ${index === 0 ? `
          <button class="add-scene-btn" onclick="addSceneAt(0)" ${!canAddMore ? 'disabled' : ''}>
            â• ë§¨ ì•ì— ì¥ë©´ ì¶”ê°€ ${!canAddMore ? '(ìµœëŒ€ ê°œìˆ˜ ë„ë‹¬)' : ''}
          </button>
        ` : ''}

        <div class="scene-card ${scene.isOriginal ? 'original' : 'added'}"
             data-scene-index="${index}"
             data-scene-id="${scene.id}"
             draggable="true">
          <div class="scene-header" title="ë“œë˜ê·¸í•˜ì—¬ ìˆœì„œ ë³€ê²½">
            <span class="scene-drag-handle">â‹®â‹®</span>
            <div class="scene-number">${index + 1}</div>
            <div>
              ${scene.isOriginal ? `
                <strong>${escapeHtml(scene.stageName)}</strong>
              ` : `
                <input type="text"
                       class="scene-title-input"
                       value="${escapeHtml(scene.stageName)}"
                       placeholder="ì¥ë©´ ì´ë¦„"
                       onchange="updateSceneTitle('${scene.id}', this.value)"
                       onclick="event.stopPropagation()">
              `}
              <span class="scene-badge ${scene.isOriginal ? 'original' : 'added'}">
                ${scene.isOriginal ? 'ê¸°ë³¸' : 'ì¶”ê°€'}
              </span>
            </div>
            <div class="scene-actions">
              <button class="move-btn" onclick="moveScene(${index}, -1)" ${index === 0 ? 'disabled' : ''} title="ìœ„ë¡œ">
                â†‘
              </button>
              <button class="move-btn" onclick="moveScene(${index}, 1)" ${index === step2Data.scenes.length - 1 ? 'disabled' : ''} title="ì•„ë˜ë¡œ">
                â†“
              </button>
              ${!scene.isOriginal ? `
                <button class="btn btn-sm btn-ghost" onclick="deleteScene(${index})" title="ì‚­ì œ" style="color: var(--danger);">
                  ğŸ—‘ï¸
                </button>
              ` : ''}
            </div>
          </div>
          <div class="scene-body">
            <div class="form-group mb-2">
              <label class="form-label">ì¥ë©´ ì„¤ëª…</label>
              <textarea class="scene-textarea"
                        id="scene-desc-${scene.id}"
                        placeholder="ì´ ì¥ë©´ì—ì„œ ë¬´ìŠ¨ ì¼ì´ ì¼ì–´ë‚˜ë‚˜ìš”?"
                        onchange="updateSceneById('${scene.id}', 'description', this.value)">${escapeHtml(scene.description || '')}</textarea>
            </div>
            <div class="form-group">
              <label class="form-label">ëŒ€ì‚¬ (ì„ íƒ)</label>
              <textarea class="scene-textarea"
                        id="scene-dialogue-${scene.id}"
                        style="min-height: 50px;"
                        placeholder="ë“±ì¥ì¸ë¬¼ì˜ ëŒ€ì‚¬"
                        onchange="updateSceneById('${scene.id}', 'dialogue', this.value)">${escapeHtml(scene.dialogue || '')}</textarea>
            </div>
          </div>
        </div>

        <!-- ì¥ë©´ ì‚¬ì´ì— ì¶”ê°€ ë²„íŠ¼ -->
        <button class="add-scene-btn" onclick="addSceneAt(${index + 1})" ${!canAddMore ? 'disabled' : ''}>
          â• ì—¬ê¸°ì— ì¥ë©´ ì¶”ê°€ ${!canAddMore ? '(ìµœëŒ€ ê°œìˆ˜ ë„ë‹¬)' : ''}
        </button>
      `;
    });

    return html;
  }

  /**
   * ì¥ë©´ ì¶”ê°€ - ìë™ ë²ˆí˜¸ ë¶€ì—¬
   */
  function addSceneAt(index) {
    // ì¥ë©´ ìˆ˜ ì œí•œ ì²´í¬
    if (step2Data.scenes.length >= MAX_SCENES_LIMIT) {
      showToast(`ì¥ë©´ì€ ìµœëŒ€ ${MAX_SCENES_LIMIT}ê°œê¹Œì§€ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`, 'warning');
      return;
    }

    // í˜„ì¬ ë°ì´í„° ì €ì¥
    collectSceneData();

    // ì¶”ê°€ëœ ì¥ë©´ ê°œìˆ˜ ê³„ì‚°í•˜ì—¬ ìë™ ë²ˆí˜¸ ë¶€ì—¬
    const addedScenesCount = step2Data.scenes.filter(s => !s.isOriginal).length + 1;

    const newScene = {
      id: generateSceneId(),
      originalPanelId: null,
      stageName: `ì¶”ê°€ ì¥ë©´ ${addedScenesCount}`,
      description: '',
      dialogue: '',
      isOriginal: false,
      order: index + 1
    };

    step2Data.scenes.splice(index, 0, newScene);
    updateSceneOrders();
    refreshScenesList();
    showToast('ìƒˆ ì¥ë©´ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');

    // ìƒˆ ì¥ë©´ì˜ ì„¤ëª… ì…ë ¥ë€ìœ¼ë¡œ í¬ì»¤ìŠ¤
    setTimeout(() => {
      const newTextarea = document.getElementById(`scene-desc-${newScene.id}`);
      if (newTextarea) {
        newTextarea.focus();
        newTextarea.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
    }, 100);
  }

  /**
   * ì¥ë©´ ì‚­ì œ
   */
  function deleteScene(index) {
    const scene = step2Data.scenes[index];
    if (scene.isOriginal) {
      showToast('ê¸°ë³¸ ì¥ë©´ì€ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'warning');
      return;
    }

    showConfirm('ì´ ì¥ë©´ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?', () => {
      collectSceneData();
      step2Data.scenes.splice(index, 1);
      updateSceneOrders();
      refreshScenesList();
      showToast('ì¥ë©´ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
    });
  }

  /**
   * ì¥ë©´ ì´ë™ (ë²„íŠ¼ í´ë¦­)
   */
  function moveScene(index, direction) {
    const newIndex = index + direction;
    if (newIndex < 0 || newIndex >= step2Data.scenes.length) return;

    collectSceneData();

    // ìœ„ì¹˜ êµí™˜ (ì¸ì ‘í•œ ìš”ì†Œ ìŠ¤ì™‘)
    const temp = step2Data.scenes[index];
    step2Data.scenes[index] = step2Data.scenes[newIndex];
    step2Data.scenes[newIndex] = temp;

    updateSceneOrders();
    refreshScenesList();
  }

  /**
   * ì¥ë©´ ìˆœì„œ ì—…ë°ì´íŠ¸
   */
  function updateSceneOrders() {
    step2Data.scenes.forEach((scene, index) => {
      scene.order = index + 1;
    });
  }

  /**
   * ì¥ë©´ ì œëª© ì—…ë°ì´íŠ¸ (ID ê¸°ë°˜)
   */
  function updateSceneTitle(sceneId, value) {
    const scene = step2Data.scenes.find(s => s.id === sceneId);
    if (scene && !scene.isOriginal) {
      scene.stageName = value;
    }
  }

  /**
   * ì¥ë©´ ë°ì´í„° ì—…ë°ì´íŠ¸ (ID ê¸°ë°˜)
   */
  function updateSceneById(sceneId, field, value) {
    const scene = step2Data.scenes.find(s => s.id === sceneId);
    if (scene) {
      const allowedFields = ['description', 'dialogue', 'stageName'];
      if (allowedFields.includes(field)) {
        scene[field] = value;
      }
    }
  }

  /**
   * ëª¨ë“  ì¥ë©´ ë°ì´í„° ìˆ˜ì§‘ (ID ê¸°ë°˜ìœ¼ë¡œ ìˆ˜ì •)
   */
  function collectSceneData() {
    step2Data.scenes.forEach((scene) => {
      // scene.id ê¸°ë°˜ìœ¼ë¡œ DOM ìš”ì†Œ ì°¾ê¸° (ì¸ë±ìŠ¤ ë¶ˆì¼ì¹˜ ë²„ê·¸ ìˆ˜ì •)
      const descEl = document.getElementById(`scene-desc-${scene.id}`);
      const dialogueEl = document.getElementById(`scene-dialogue-${scene.id}`);

      // DOM ìš”ì†Œê°€ ìˆìœ¼ë©´ ê°’ ì—…ë°ì´íŠ¸
      if (descEl) {
        scene.description = descEl.value;
      }
      if (dialogueEl) {
        scene.dialogue = dialogueEl.value;
      }
    });
  }

  /**
   * ì¥ë©´ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
   */
  function refreshScenesList() {
    const container = document.getElementById('scenes-container');
    if (container) {
      container.innerHTML = renderScenesList();
      setupDragAndDrop();
    }

    // ì¥ë©´ ìˆ˜ ë°°ì§€ ì—…ë°ì´íŠ¸
    const badge = document.getElementById('scene-count-badge');
    if (badge) {
      badge.textContent = `ì´ ${step2Data.scenes.length}ê°œ ì¥ë©´`;
    }
  }

  /**
   * ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì„¤ì •
   */
  function setupDragAndDrop() {
    const cards = document.querySelectorAll('.scene-card');

    cards.forEach(card => {
      card.addEventListener('dragstart', handleDragStart);
      card.addEventListener('dragend', handleDragEnd);
      card.addEventListener('dragover', handleDragOver);
      card.addEventListener('dragleave', handleDragLeave);
      card.addEventListener('drop', handleDrop);
    });
  }

  function handleDragStart(e) {
    const sceneIndex = e.target.dataset.sceneIndex;
    if (sceneIndex === undefined) return;

    draggedSceneIndex = parseInt(sceneIndex);
    e.target.classList.add('dragging');
    collectSceneData();
  }

  function handleDragEnd(e) {
    e.target.classList.remove('dragging');
    document.querySelectorAll('.scene-card').forEach(card => {
      card.classList.remove('drag-over');
    });
    // ë“œë˜ê·¸ ìƒíƒœ ì´ˆê¸°í™”
    draggedSceneIndex = null;
  }

  function handleDragOver(e) {
    e.preventDefault();
    const card = e.target.closest('.scene-card');
    if (card && draggedSceneIndex !== null && parseInt(card.dataset.sceneIndex) !== draggedSceneIndex) {
      card.classList.add('drag-over');
    }
  }

  function handleDragLeave(e) {
    const card = e.target.closest('.scene-card');
    if (card) {
      card.classList.remove('drag-over');
    }
  }

  function handleDrop(e) {
    e.preventDefault();
    const card = e.target.closest('.scene-card');
    if (!card || draggedSceneIndex === null) return;

    const targetIndex = parseInt(card.dataset.sceneIndex);
    if (targetIndex === draggedSceneIndex) return;

    // ë“œë˜ê·¸ ì¸ë±ìŠ¤ ë²„ê·¸ ìˆ˜ì •: ì‚­ì œ í›„ ì¸ë±ìŠ¤ ë³´ì •
    const draggedScene = step2Data.scenes[draggedSceneIndex];
    step2Data.scenes.splice(draggedSceneIndex, 1);

    // fromIndex < targetIndexì¼ ë•Œ ì¸ë±ìŠ¤ ë³´ì •
    const adjustedTargetIndex = draggedSceneIndex < targetIndex
      ? targetIndex - 1
      : targetIndex;
    step2Data.scenes.splice(adjustedTargetIndex, 0, draggedScene);

    updateSceneOrders();
    refreshScenesList();
    showToast('ì¥ë©´ ìˆœì„œê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');

    // ë“œë˜ê·¸ ìƒíƒœ ì´ˆê¸°í™”
    draggedSceneIndex = null;
  }

  /**
   * Step 2 ì €ì¥ - ë¹ˆ ì¥ë©´ í•˜ì´ë¼ì´íŠ¸ ì¶”ê°€, ë²„íŠ¼ ìƒíƒœ ë³€í™”
   */
  async function saveStep2(isComplete = false) {
    // Race Condition ë°©ì§€: ì €ì¥ ì¤‘ì´ë©´ ë¬´ì‹œ
    if (isSaving) return;

    const saveBtn = document.getElementById('btn-save-step2');
    const submitBtn = document.getElementById('btn-submit-step2');

    collectSceneData();

    if (isComplete) {
      const emptyScenes = step2Data.scenes.filter(s => {
        const desc = s.description || '';
        return !desc.trim();
      });

      if (emptyScenes.length > 0) {
        // ë¹ˆ ì¥ë©´ í•˜ì´ë¼ì´íŠ¸ í‘œì‹œ
        emptyScenes.forEach(scene => {
          const textarea = document.getElementById(`scene-desc-${scene.id}`);
          if (textarea) {
            textarea.classList.add('error');
            // 3ì´ˆ í›„ ì—ëŸ¬ ìŠ¤íƒ€ì¼ ì œê±°
            setTimeout(() => textarea.classList.remove('error'), 3000);
          }
        });

        // ì²« ë²ˆì§¸ ë¹ˆ ì¥ë©´ìœ¼ë¡œ ìŠ¤í¬ë¡¤
        const firstEmptyTextarea = document.getElementById(`scene-desc-${emptyScenes[0].id}`);
        if (firstEmptyTextarea) {
          firstEmptyTextarea.scrollIntoView({ behavior: 'smooth', block: 'center' });
          firstEmptyTextarea.focus();
        }

        showToast(`${emptyScenes.length}ê°œ ì¥ë©´ì˜ ì„¤ëª…ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤. ëª¨ë“  ì¥ë©´ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!`, 'warning');
        return;
      }
    }

    isSaving = true;

    try {
      // ë²„íŠ¼ ìƒíƒœ ë³€ê²½: ì €ì¥/ì œì¶œ ì¤‘
      if (isComplete) {
        if (submitBtn) {
          submitBtn.disabled = true;
          submitBtn.innerHTML = 'â³ ì œì¶œ ì¤‘...';
        }
      } else {
        if (saveBtn) {
          saveBtn.disabled = true;
          saveBtn.innerHTML = 'â³ ì €ì¥ ì¤‘...';
        }
      }

      const result = await callApi('saveWork', {
        studentName: step2Data.studentName,
        studentNumber: step2Data.studentNumber,
        step: 2,
        workData: {
          title: step2Data.title,
          scenes: step2Data.scenes,
          originalPanelsCount: step2Data.originalPanels.length,
          totalScenesCount: step2Data.scenes.length,
          isComplete: isComplete,
          status: isComplete ? 'submitted' : 'draft'
        }
      });

      if (result.success) {
        if (isComplete) {
          // ì œì¶œ ì™„ë£Œ ìƒíƒœ
          if (submitBtn) {
            submitBtn.innerHTML = 'âœ… ì œì¶œ ì™„ë£Œ!';
            submitBtn.style.background = 'var(--success)';
          }
          showToast('Step 2ê°€ ì œì¶œë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ‰', 'success');
          stopAutoSaveStep2();
          setTimeout(() => navigateTo('student-main'), 1000);
        } else {
          // ì €ì¥ ì™„ë£Œ ìƒíƒœ (2ì´ˆ í›„ ì›ë˜ëŒ€ë¡œ)
          if (saveBtn) {
            saveBtn.innerHTML = 'âœ“ ì €ì¥ë¨!';
            saveBtn.style.color = 'var(--success)';
            saveBtn.style.borderColor = 'var(--success)';
            setTimeout(() => {
              saveBtn.innerHTML = 'ğŸ’¾ ì €ì¥í•˜ê¸°';
              saveBtn.style.color = '';
              saveBtn.style.borderColor = '';
              saveBtn.disabled = false;
            }, 2000);
          }
          showToast('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
        }
      } else {
        // ì‹¤íŒ¨ ì‹œ ì›ë˜ ìƒíƒœë¡œ ë³µê·€
        if (saveBtn) {
          saveBtn.innerHTML = 'ğŸ’¾ ì €ì¥í•˜ê¸°';
          saveBtn.disabled = false;
        }
        if (submitBtn) {
          submitBtn.innerHTML = 'ğŸ“® ì œì¶œí•˜ê¸°';
          submitBtn.disabled = false;
          submitBtn.style.background = '';
        }
        showToast(result.error || 'ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
      }
    } catch (error) {
      console.error('ì €ì¥ ì˜¤ë¥˜:', error);
      // ì˜¤ë¥˜ ì‹œ ì›ë˜ ìƒíƒœë¡œ ë³µê·€
      if (saveBtn) {
        saveBtn.innerHTML = 'ğŸ’¾ ì €ì¥í•˜ê¸°';
        saveBtn.disabled = false;
      }
      if (submitBtn) {
        submitBtn.innerHTML = 'ğŸ“® ì œì¶œí•˜ê¸°';
        submitBtn.disabled = false;
        submitBtn.style.background = '';
      }
      showToast('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
    } finally {
      hideLoading();
      isSaving = false;
    }
  }

  /**
   * ìë™ ì €ì¥
   */
  let autoSaveStep2Interval = null;

  function startAutoSaveStep2() {
    stopAutoSaveStep2();
    autoSaveStep2Interval = setInterval(() => {
      saveStep2(false);
    }, AUTO_SAVE_INTERVAL_MS);
  }

  function stopAutoSaveStep2() {
    if (autoSaveStep2Interval) {
      clearInterval(autoSaveStep2Interval);
      autoSaveStep2Interval = null;
    }
  }

  /**
   * ë‚˜ê°€ê¸° í™•ì¸
   */
  function confirmExitStep2() {
    showConfirm('ì €ì¥í•˜ì§€ ì•Šì€ ë‚´ìš©ì´ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë‚˜ê°€ì‹œê² ìŠµë‹ˆê¹Œ?', () => {
      stopAutoSaveStep2();
      navigateTo('student-main');
    });
  }

  /**
   * ë¯¸ë¦¬ë³´ê¸°
   */
  function previewStep2() {
    collectSceneData();

    showModal({
      title: `ğŸ‘ï¸ ë¯¸ë¦¬ë³´ê¸°: ${escapeHtml(step2Data.title)} (${step2Data.scenes.length}ì¥ë©´)`,
      content: `
        <div style="max-height: 400px; overflow-y: auto;">
          ${step2Data.scenes.map((scene, index) => `
            <div style="padding: 12px; margin-bottom: 8px; background: var(--bg); border-radius: 8px; border-left: 3px solid ${scene.isOriginal ? 'var(--primary)' : 'var(--success)'};">
              <div style="font-weight: 600; margin-bottom: 4px;">
                ${index + 1}. ${escapeHtml(scene.stageName)}
                <span style="font-size: 0.75rem; color: var(--text-muted);">
                  (${scene.isOriginal ? 'ê¸°ë³¸' : 'ì¶”ê°€'})
                </span>
              </div>
              <p style="margin: 0; font-size: 0.9rem;">${escapeHtml(scene.description) || '<span style="color: var(--text-muted);">(ì„¤ëª… ì—†ìŒ)</span>'}</p>
              ${scene.dialogue ? `<p style="margin-top: 4px; font-style: italic; color: var(--primary);">"${escapeHtml(scene.dialogue)}"</p>` : ''}
            </div>
          `).join('')}
        </div>
      `,
      buttons: [{ text: 'ë‹«ê¸°', class: 'btn-primary' }]
    });
  }
</script>
