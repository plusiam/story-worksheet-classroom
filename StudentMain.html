<script>
  /* ============================================
     í•™ìƒ ë©”ì¸ í™”ë©´
     ============================================ */

  let studentWorks = null;

  async function renderStudentMain(container) {
    const user = AppState.currentUser;

    if (!user) {
      navigateTo('login');
      return;
    }

    // í•™ìƒ ì‘í’ˆ ì •ë³´ ë¡œë“œ
    try {
      const result = await callApi('getStudentWorks', {
        studentName: user.name,
        studentNumber: user.number
      });

      if (result.success) {
        studentWorks = result.data;
      }
    } catch (error) {
      console.error('ì‘í’ˆ ë¡œë“œ ì‹¤íŒ¨:', error);
    }

    container.innerHTML = `
      <div class="container fade-in">
        ${renderStudentHeader()}

        ${renderWelcomeCard()}

        <h2 style="margin-bottom: 16px;">ğŸ“ ë‚˜ì˜ í•™ìŠµ ë‹¨ê³„</h2>

        <div class="flex flex-col gap-2" style="max-width: 600px;">
          ${renderStepCard(
            1,
            '4ì»· ìŠ¤í† ë¦¬ ë§Œë“¤ê¸°',
            'ë°œë‹¨-ì „ê°œ-ì ˆì •-ê²°ë§ì˜ ê¸°ë³¸ êµ¬ì¡°ë¡œ ì´ì•¼ê¸°ë¥¼ ë§Œë“¤ì–´ìš”',
            'ğŸ“–',
            true,
            false
          )}

          ${renderStepCard(
            2,
            'ì¥ë©´ í™•ì¥í•˜ê¸°',
            'ê° ì¥ë©´ì„ ë” ìì„¸í•˜ê²Œ ë¬˜ì‚¬í•˜ê³  ëŒ€í™”ë¥¼ ì¶”ê°€í•´ìš”',
            'ğŸ¬',
            false,
            !hasCompletedStep(1)
          )}

          ${renderStepCard(
            3,
            'ë‚´ ê·¸ë¦¼ìœ¼ë¡œ ì™„ì„±í•˜ê¸°',
            'ì§ì ‘ ê·¸ë¦° ê·¸ë¦¼ì´ë‚˜ ì‚¬ì§„ìœ¼ë¡œ ìŠ¤í† ë¦¬ë³´ë“œë¥¼ ì™„ì„±í•´ìš”',
            'ğŸ¨',
            false,
            !hasCompletedStep(2)
          )}
        </div>

        ${renderMyWorksSection()}

        <div style="margin-top: 32px; text-align: center;">
          <button class="btn btn-ghost" onclick="logout()">
            ë¡œê·¸ì•„ì›ƒ
          </button>
        </div>
      </div>
    `;
  }

  /**
   * ë‹¨ê³„ ì™„ë£Œ ì—¬ë¶€ í™•ì¸
   */
  function hasCompletedStep(step) {
    if (!studentWorks) return false;
    const work = studentWorks[`step${step}`];
    return work && work.isComplete;
  }

  /**
   * ë‹¨ê³„ ì‹œì‘
   */
  function startStep(step) {
    const user = AppState.currentUser;

    // ì´ì „ ë‹¨ê³„ ì™„ë£Œ í™•ì¸ (STEP 1ì€ ë°”ë¡œ ì‹œì‘ ê°€ëŠ¥)
    if (step > 1 && !hasCompletedStep(step - 1)) {
      showToast(`ë¨¼ì € STEP ${step - 1}ì„ ì™„ë£Œí•´ì£¼ì„¸ìš”!`, 'warning');
      return;
    }

    // Stepë³„ ë‹¤ë¥¸ ë¼ìš°íŠ¸ë¡œ ì´ë™
    const routeMap = {
      1: 'story-creator',
      2: 'story-creator-step2',
      3: 'story-creator-step3'
    };

    const route = routeMap[step] || 'story-creator';

    navigateTo(route, {
      step: step,
      studentName: user.name,
      studentNumber: user.number,
      existingWork: studentWorks ? studentWorks[`step${step}`] : null
    });
  }

  /**
   * ë‚´ ì‘í’ˆ ì„¹ì…˜ ë Œë”ë§
   */
  function renderMyWorksSection() {
    const works = [];

    if (studentWorks) {
      for (let step = 1; step <= 3; step++) {
        const work = studentWorks[`step${step}`];
        if (work) {
          works.push({
            step: step,
            title: work.workData?.title || `STEP ${step} ì‘í’ˆ`,
            updatedAt: work.updatedAt,
            isComplete: work.isComplete,
            status: work.status
          });
        }
      }
    }

    if (works.length === 0) {
      return `
        <div style="margin-top: 32px;">
          <h2 style="margin-bottom: 16px;">ğŸ“‚ ë‚˜ì˜ ì‘í’ˆ</h2>
          ${renderEmptyState(
            'ğŸ“',
            'ì•„ì§ ì‘í’ˆì´ ì—†ì–´ìš”',
            'STEP 1ë¶€í„° ì‹œì‘í•´ë³´ì„¸ìš”!'
          )}
        </div>
      `;
    }

    return `
      <div style="margin-top: 32px;">
        <h2 style="margin-bottom: 16px;">ğŸ“‚ ë‚˜ì˜ ì‘í’ˆ</h2>
        <div class="flex flex-col gap-2">
          ${works.map(work => `
            <div class="card" style="padding: 16px;">
              <div class="flex justify-between items-center">
                <div>
                  <span style="color: var(--text-light); font-size: 0.85rem;">STEP ${work.step}</span>
                  <h4 style="margin: 4px 0;">${escapeHtml(work.title)}</h4>
                  <span style="color: var(--text-muted); font-size: 0.8rem;">
                    ìµœê·¼ ìˆ˜ì •: ${work.updatedAt || 'ì•Œ ìˆ˜ ì—†ìŒ'}
                  </span>
                </div>
                <div class="flex items-center gap-2">
                  ${renderWorkStatusBadge(work.status, work.isComplete)}
                  <button class="btn btn-sm btn-primary" onclick="startStep(${work.step})">
                    ${work.isComplete ? 'ë³´ê¸°' : 'ê³„ì†í•˜ê¸°'}
                  </button>
                </div>
              </div>
            </div>
          `).join('')}
        </div>
      </div>
    `;
  }
</script>
