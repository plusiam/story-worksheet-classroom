<script>
  /* ============================================
     ë¼ìš°í„° - í•™ê¸‰ ëª¨ë“œ ì „ìš©
     ============================================ */

  const routes = {
    'landing': renderLandingPage,
    'login': renderStudentLogin,
    'pin-setup': renderStudentPinSetup,
    'student-main': renderStudentMain,
    'story-creator': renderStoryCreator,
    'teacher-login': renderTeacherLogin,
    'teacher-setup': renderTeacherSetupWizard,
    'teacher-dashboard': renderTeacherDashboard,
    'teacher-students': renderTeacherStudents,
    'teacher-qr': renderTeacherQR,
    'teacher-settings': renderTeacherSettings
  };

  /* ============================================
     ì•± ì´ˆê¸°í™”
     ============================================ */
  async function initApp(params) {
    try {
      // êµì‚¬/ê´€ë¦¬ì ëª¨ë“œ ë¨¼ì € í™•ì¸
      if (params.mode === 'teacher' || params.mode === 'admin') {
        // ì„¤ì • ë¨¼ì € ë¡œë“œ
        try {
          const settings = await callApi('getSettings');
          AppState.settings = settings;
        } catch (e) {
          console.log('ì„¤ì • ë¡œë“œ ì‹¤íŒ¨:', e);
        }

        // êµì‚¬ ì¸ì¦ í™•ì¸ í›„ ì ì ˆí•œ í™”ë©´ìœ¼ë¡œ ì´ë™
        await handleTeacherModeEntry();
        return;
      }

      // ì²« ì„¤ì • ì—¬ë¶€ í™•ì¸
      const firstSetupResult = await callApi('isFirstSetup');

      // ì²« ì„¤ì •ì¸ ê²½ìš° ëœë”© í˜ì´ì§€ë¡œ
      if (firstSetupResult.isFirstSetup) {
        navigateTo('landing');
        return;
      }

      // ì‹œìŠ¤í…œ ì •ë³´ ë° ì„¤ì • ë¡œë“œ
      const [systemInfo, settings] = await Promise.all([
        callApi('getSystemInfo'),
        callApi('getSettings')
      ]);

      AppState.settings = settings;

      // URL íŒŒë¼ë¯¸í„° ì²˜ë¦¬
      if (params.token) {
        // QR í† í°ìœ¼ë¡œ ì ‘ì†
        await handleTokenLogin(params.token);
        return;
      }

      // ê¸°ì¡´ ì„¸ì…˜ í™•ì¸
      const session = loadSession();
      if (session && session.name && session.number) {
        AppState.currentUser = session;
        navigateTo('student-main');
        return;
      }

      // ê¸°ë³¸: í•™ìƒ ë¡œê·¸ì¸ í™”ë©´
      navigateTo('login');

    } catch (error) {
      console.error('ì•± ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
      showToast('ì‹œìŠ¤í…œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
      // ì˜¤ë¥˜ ì‹œ ëœë”© í˜ì´ì§€ë¡œ (ì²« ì„¤ì •ì¸ ê²½ìš°ì¼ ìˆ˜ ìˆìŒ)
      navigateTo('landing');
    } finally {
      hideLoading();
    }
  }

  /* ============================================
     ë„¤ë¹„ê²Œì´ì…˜
     ============================================ */
  function navigateTo(route, data = {}) {
    AppState.currentRoute = route;

    const app = document.getElementById('app');
    const renderFn = routes[route];

    if (renderFn) {
      app.innerHTML = '';
      renderFn(app, data);

      // ìŠ¤í¬ë¡¤ ë§¨ ìœ„ë¡œ
      window.scrollTo(0, 0);
    } else {
      console.error('Unknown route:', route);
      navigateTo('login');
    }
  }

  /* ============================================
     í† í° ë¡œê·¸ì¸ ì²˜ë¦¬
     ============================================ */
  async function handleTokenLogin(token) {
    try {
      showLoading('QR ì½”ë“œ í™•ì¸ ì¤‘...');

      const result = await callApi('loginByToken', { token });

      if (result.success) {
        AppState.currentUser = {
          name: result.name,
          number: result.number,
          token: result.token
        };
        saveSession(AppState.currentUser);
        showToast(`${result.name} í•™ìƒ, í™˜ì˜í•©ë‹ˆë‹¤! ğŸ‰`, 'success');
        navigateTo('student-main');
      } else {
        showToast(result.error || 'QR ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
        navigateTo('login');
      }
    } catch (error) {
      console.error('í† í° ë¡œê·¸ì¸ ì‹¤íŒ¨:', error);
      showToast('QR ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
      navigateTo('login');
    }
  }

  /* ============================================
     ë¡œê·¸ì•„ì›ƒ
     ============================================ */
  function logout() {
    showConfirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?', () => {
      AppState.currentUser = null;
      AppState.isTeacher = false;
      clearSession();
      showToast('ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
      navigateTo('login');
    });
  }

  /* ============================================
     í•™ìƒ ë¡œê·¸ì¸ ì²˜ë¦¬
     ============================================ */
  async function handleStudentLogin(name, number, pin) {
    try {
      clearAllErrors();

      // ìœ íš¨ì„± ê²€ì‚¬
      const nameError = validateRequired(name, 'ì´ë¦„');
      if (nameError) {
        showFieldError('login-name', nameError);
        return;
      }

      const numberError = validateNumber(number, 1, 100, 'ë²ˆí˜¸');
      if (numberError) {
        showFieldError('login-number', numberError);
        return;
      }

      const pinError = validatePin(pin);
      if (pinError) {
        showFieldError('login-pin', pinError);
        return;
      }

      showLoading('ë¡œê·¸ì¸ ì¤‘...');

      const result = await callApi('login', {
        name: name.trim(),
        number: parseInt(number, 10),
        pin: pin
      });

      if (result.success) {
        AppState.currentUser = {
          name: result.name,
          number: result.number,
          token: result.token
        };
        saveSession(AppState.currentUser);
        showToast(`${result.name} í•™ìƒ, í™˜ì˜í•©ë‹ˆë‹¤! ğŸ‰`, 'success');
        navigateTo('student-main');
      } else if (result.needSetPin) {
        // PIN ì„¤ì • í•„ìš”
        navigateTo('pin-setup', {
          name: result.name,
          number: result.number
        });
      } else {
        showToast(result.error || 'ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
      }
    } catch (error) {
      console.error('ë¡œê·¸ì¸ ì˜¤ë¥˜:', error);
      showToast('ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
    }
  }

  /* ============================================
     í•™ìƒ ìƒíƒœ í™•ì¸ (ì´ë¦„+ë²ˆí˜¸ë§Œ)
     ============================================ */
  async function checkStudent(name, number) {
    try {
      clearAllErrors();

      const nameError = validateRequired(name, 'ì´ë¦„');
      if (nameError) {
        showFieldError('login-name', nameError);
        return null;
      }

      const numberError = validateNumber(number, 1, 100, 'ë²ˆí˜¸');
      if (numberError) {
        showFieldError('login-number', numberError);
        return null;
      }

      const result = await callApi('checkStudent', {
        name: name.trim(),
        number: parseInt(number, 10)
      });

      return result;
    } catch (error) {
      console.error('í•™ìƒ í™•ì¸ ì˜¤ë¥˜:', error);
      return { success: false, error: 'í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.' };
    }
  }

  /* ============================================
     PIN ì„¤ì • ì²˜ë¦¬
     ============================================ */
  async function handlePinSetup(name, number, pin) {
    try {
      const pinError = validatePin(pin);
      if (pinError) {
        showToast(pinError, 'error');
        return;
      }

      showLoading('PIN ì„¤ì • ì¤‘...');

      const result = await callApi('setPin', {
        name: name,
        number: number,
        pin: pin
      });

      if (result.success) {
        AppState.currentUser = {
          name: result.name,
          number: result.number,
          token: result.token
        };
        saveSession(AppState.currentUser);
        showToast('PINì´ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ‰', 'success');
        navigateTo('student-main');
      } else {
        showToast(result.error || 'PIN ì„¤ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
      }
    } catch (error) {
      console.error('PIN ì„¤ì • ì˜¤ë¥˜:', error);
      showToast('PIN ì„¤ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
    }
  }

  /* ============================================
     êµì‚¬ ëª¨ë“œ ì§„ì… ì²˜ë¦¬
     ============================================ */
  async function handleTeacherModeEntry() {
    try {
      // 1. ì €ì¥ëœ êµì‚¬ í† í° í™•ì¸
      const savedToken = sessionStorage.getItem('teacherToken');

      // 2. êµì‚¬ ì¸ì¦ í™•ì¸ (PIN ì„¸ì…˜ ë˜ëŠ” Google ê³„ì •)
      const authResult = await callApi('checkTeacherAuth', { teacherToken: savedToken });

      if (authResult.isAuthorized) {
        // ì¸ì¦ë¨ - êµì‚¬ ëª¨ë“œ í™œì„±í™”
        AppState.isTeacher = true;
        if (savedToken) {
          AppState.teacherToken = savedToken;
        }

        // ì²« ì„¤ì • ì—¬ë¶€ í™•ì¸
        const firstSetup = await callApi('isFirstSetup');
        if (firstSetup.isFirstSetup) {
          navigateTo('teacher-setup');
        } else {
          navigateTo('teacher-dashboard');
        }
        return;
      }

      // 3. ì¸ì¦ ì•ˆë¨ - ë¡œê·¸ì¸ í™”ë©´ìœ¼ë¡œ
      const [firstSetup, hasPin] = await Promise.all([
        callApi('isFirstSetup'),
        callApi('hasTeacherPin')
      ]);

      navigateTo('teacher-login', {
        isFirstSetup: firstSetup.isFirstSetup,
        hasPin: hasPin.hasPin
      });

    } catch (error) {
      console.error('êµì‚¬ ëª¨ë“œ ì§„ì… ì˜¤ë¥˜:', error);
      // ì˜¤ë¥˜ ì‹œì—ë„ ë¡œê·¸ì¸ í™”ë©´ìœ¼ë¡œ
      navigateTo('teacher-login', { isFirstSetup: true, hasPin: false });
    } finally {
      hideLoading();
    }
  }

  /* ============================================
     êµì‚¬ ì´ˆê¸° ì„¤ì • ì™„ë£Œ
     ============================================ */
  async function completeTeacherSetup(setupData) {
    try {
      showLoading('ì„¤ì • ì €ì¥ ì¤‘...');

      // ì‹œìŠ¤í…œ ì´ˆê¸°í™” (ì‹œíŠ¸ ìƒì„±)
      await callApi('initialize');

      // í•™ê¸‰ ëª¨ë“œë¡œ ê³ ì •
      setupData.systemMode = 'classroom';

      // ì„¤ì • ì €ì¥
      const result = await callApi('saveSettings', { settings: setupData });

      if (result.success) {
        AppState.settings = { ...AppState.settings, ...setupData };
        showToast('ì„¤ì •ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ‰', 'success');
        navigateTo('teacher-dashboard');
      } else {
        showToast(result.error || 'ì„¤ì • ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
      }
    } catch (error) {
      console.error('ì„¤ì • ì €ì¥ ì˜¤ë¥˜:', error);
      showToast('ì„¤ì • ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
    }
  }
</script>
