<script>
  /* ============================================
     ê³µí†µ ì»´í¬ë„ŒíŠ¸
     ============================================ */

  /**
   * ë‚ ì§œ í˜•ì‹ì¸ì§€ ì²´í¬ (ì˜ëª» ì €ì¥ëœ ë°ì´í„° í•„í„°ë§)
   */
  function isDateString(str) {
    if (!str || typeof str !== 'string') return false;
    // ISO ë‚ ì§œ í˜•ì‹ ì²´í¬: 2026-04-01T15:00:00.000Z
    return /^\d{4}-\d{2}-\d{2}T/.test(str);
  }

  /**
   * ì„¤ì •ê°’ ì•ˆì „í•˜ê²Œ ê°€ì ¸ì˜¤ê¸° (ë‚ ì§œ í˜•ì‹ì´ë©´ ë¹ˆ ë¬¸ìì—´ ë°˜í™˜)
   */
  function safeSettingValue(value) {
    if (!value) return '';
    if (isDateString(value)) return '';  // ì˜ëª» ì €ì¥ëœ ë‚ ì§œê°’ í•„í„°ë§
    return value;
  }

  /**
   * í—¤ë” ì»´í¬ë„ŒíŠ¸ (í•™ìƒìš©)
   */
  function renderStudentHeader(title = '') {
    const settings = AppState.settings || {};
    const user = AppState.currentUser;
    const teacherName = settings.teacherName ? `${escapeHtml(settings.teacherName)} ì„ ìƒë‹˜ì˜ ` : '';
    const schoolName = safeSettingValue(settings.schoolName);
    const className = safeSettingValue(settings.className);

    return `
      <header class="card card-rainbow-top" style="margin-bottom: 24px; padding-top: 30px;">
        <div class="flex justify-between items-center">
          <div>
            <h1 class="title-handwriting" style="color: var(--primary);">
              ${teacherName}ìŠ¤í† ë¦¬ í•™ìŠµì§€
            </h1>
            ${schoolName || className ? `
              <p style="color: var(--text-light); margin-top: 4px;">
                ${escapeHtml(schoolName)} ${escapeHtml(className)}
              </p>
            ` : ''}
          </div>
          ${user ? `
            <div class="flex items-center gap-2">
              <span class="badge badge-active">${escapeHtml(user.name)} (${user.number}ë²ˆ)</span>
              <button class="btn btn-sm btn-ghost" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
          ` : ''}
        </div>
        ${title ? `<h2 style="margin-top: 16px;">${escapeHtml(title)}</h2>` : ''}
      </header>
    `;
  }

  /**
   * í—¤ë” ì»´í¬ë„ŒíŠ¸ (êµì‚¬ìš©)
   */
  function renderTeacherHeader(title = '', activeTab = 'dashboard') {
    const settings = AppState.settings || {};
    const teacherName = settings.teacherName ? `${escapeHtml(settings.teacherName)} ì„ ìƒë‹˜ì˜ ` : '';
    const schoolName = safeSettingValue(settings.schoolName);
    const className = safeSettingValue(settings.className);

    const tabs = [
      { id: 'dashboard', label: 'ëŒ€ì‹œë³´ë“œ', icon: 'ğŸ“Š', route: 'teacher-dashboard' },
      { id: 'students', label: 'í•™ìƒ ê´€ë¦¬', icon: 'ğŸ‘¨â€ğŸ“', route: 'teacher-students' },
      { id: 'qr', label: 'QR ì½”ë“œ', icon: 'ğŸ“±', route: 'teacher-qr' },
      { id: 'settings', label: 'ì„¤ì •', icon: 'âš™ï¸', route: 'teacher-settings' }
    ];

    return `
      <header class="card card-rainbow-top" style="margin-bottom: 24px; padding-top: 30px;">
        <div class="flex justify-between items-center mb-2">
          <div>
            <h1 class="title-handwriting" style="color: var(--primary);">
              ${teacherName}ìŠ¤í† ë¦¬ í•™ìŠµì§€
            </h1>
            <p style="color: var(--text-light); margin-top: 4px;">
              <span class="badge" style="background: var(--primary); color: white; font-size: 0.75rem;">ì„ ìƒë‹˜ ëª¨ë“œ</span>
              ${schoolName || className ? `
                ${escapeHtml(schoolName)} ${escapeHtml(className)}
              ` : ''}
            </p>
          </div>
          <div class="flex gap-1">
            <button class="btn btn-sm btn-ghost" onclick="backToStudentMode()">
              ğŸ‘ï¸ í•™ìƒ í™”ë©´
            </button>
            <button class="btn btn-sm btn-outline" onclick="teacherLogout()" style="color: var(--error);">
              ğŸšª ë¡œê·¸ì•„ì›ƒ
            </button>
          </div>
        </div>

        <nav class="flex gap-1" style="margin-top: 16px; flex-wrap: wrap;">
          ${tabs.map(tab => `
            <button class="btn btn-sm ${activeTab === tab.id ? 'btn-primary' : 'btn-ghost'}"
                    onclick="navigateTo('${tab.route}')">
              ${tab.icon} ${tab.label}
            </button>
          `).join('')}
        </nav>

        ${title ? `<h2 style="margin-top: 20px;">${escapeHtml(title)}</h2>` : ''}
      </header>
    `;
  }

  /**
   * í•™ìƒ ëª¨ë“œë¡œ ëŒì•„ê°€ê¸° (ë¯¸ë¦¬ë³´ê¸°)
   * êµì‚¬ í† í°ì€ ìœ ì§€í•˜ë©´ì„œ í•™ìƒ í™”ë©´ë§Œ ë¯¸ë¦¬ë³´ê¸°
   */
  function backToStudentMode() {
    // êµì‚¬ í† í°ì€ ìœ ì§€ (ë‚˜ì¤‘ì— ë‹¤ì‹œ êµì‚¬ ëª¨ë“œë¡œ ëŒì•„ê°ˆ ìˆ˜ ìˆë„ë¡)
    AppState.isTeacher = false;

    // ì‹œìŠ¤í…œ ëª¨ë“œì— ë”°ë¼ ì ì ˆí•œ í™”ë©´ìœ¼ë¡œ ì´ë™
    const systemMode = AppState.settings?.systemMode || 'classroom';
    if (systemMode === 'personal') {
      navigateTo('personal-main');
    } else {
      navigateTo('login');
    }
  }

  /**
   * êµì‚¬ ë¡œê·¸ì•„ì›ƒ (ì„¤ì • ì´ˆê¸°í™”)
   */
  function teacherLogout() {
    showConfirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\\në‹¤ë¥¸ ì„ ìƒë‹˜ì´ ì´ ì»´í“¨í„°ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.', async () => {
      // ì„œë²„ ì„¸ì…˜ ë¬´íš¨í™”
      try {
        await callApi('logoutTeacher');
      } catch (e) {
        console.log('ì„œë²„ ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨:', e);
      }

      // ëª¨ë“  ì„¸ì…˜ ì™„ì „ ì´ˆê¸°í™” (í•™ìƒ + êµì‚¬)
      clearAllSessions();
      AppState.settings = {};

      showToast('ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
      navigateTo('login');
    });
  }

  /**
   * ë¹ˆ ìƒíƒœ ì»´í¬ë„ŒíŠ¸
   */
  function renderEmptyState(icon, title, description, actionHtml = '') {
    return `
      <div class="empty-state">
        <div class="empty-state-icon">${icon}</div>
        <h3>${escapeHtml(title)}</h3>
        <p>${escapeHtml(description)}</p>
        ${actionHtml}
      </div>
    `;
  }

  /**
   * í†µê³„ ì¹´ë“œ ì»´í¬ë„ŒíŠ¸
   */
  function renderStatCard(icon, label, value, color = 'primary') {
    return `
      <div class="card" style="text-align: center; flex: 1; min-width: 120px;">
        <div style="font-size: 2rem; margin-bottom: 8px;">${icon}</div>
        <div style="font-size: 2rem; font-weight: 700; color: var(--${color});">${value}</div>
        <div style="color: var(--text-light); font-size: 0.9rem;">${escapeHtml(label)}</div>
      </div>
    `;
  }

  /**
   * ì§„í–‰ ë‹¨ê³„ í‘œì‹œ ì»´í¬ë„ŒíŠ¸
   */
  function renderProgressSteps(currentStep, totalSteps) {
    let html = '<div class="progress-steps">';

    for (let i = 1; i <= totalSteps; i++) {
      const isActive = i === currentStep;
      const isCompleted = i < currentStep;

      html += `
        <div class="progress-step">
          <div class="progress-dot ${isActive ? 'active' : ''} ${isCompleted ? 'completed' : ''}">
            ${isCompleted ? 'âœ“' : i}
          </div>
          ${i < totalSteps ? `<div class="progress-line ${isCompleted ? 'completed' : ''}"></div>` : ''}
        </div>
      `;
    }

    html += '</div>';
    return html;
  }

  /**
   * í•™ìƒ ìƒíƒœ ë°°ì§€
   */
  function renderStatusBadge(status) {
    const statusMap = {
      'active': { class: 'badge-active', label: 'í™œì„±' },
      'pending': { class: 'badge-pending', label: 'PIN ëŒ€ê¸°' },
      'inactive': { class: 'badge-inactive', label: 'ë¹„í™œì„±' }
    };

    const config = statusMap[status] || statusMap['inactive'];
    return `<span class="badge ${config.class}">${config.label}</span>`;
  }

  /**
   * ì‘í’ˆ ìƒíƒœ ë°°ì§€
   */
  function renderWorkStatusBadge(status, isComplete) {
    if (isComplete) {
      return '<span class="badge badge-active">ì™„ë£Œ</span>';
    }

    const statusMap = {
      'draft': { class: 'badge-pending', label: 'ì‘ì„± ì¤‘' },
      'submitted': { class: 'badge-active', label: 'ì œì¶œë¨' },
      'published': { class: 'badge-active', label: 'ê³µê°œë¨' }
    };

    const config = statusMap[status] || statusMap['draft'];
    return `<span class="badge ${config.class}">${config.label}</span>`;
  }

  /**
   * í™˜ì˜ ë©”ì‹œì§€ ì¹´ë“œ
   */
  function renderWelcomeCard() {
    const settings = AppState.settings || {};
    const user = AppState.currentUser;

    return `
      <div class="card" style="background: linear-gradient(135deg, var(--primary-light), var(--secondary-light)); margin-bottom: 24px;">
        <h2 style="margin-bottom: 8px;">ğŸ‘‹ ì•ˆë…•, ${escapeHtml(user?.name || 'ì¹œêµ¬')}!</h2>
        <p style="color: var(--text-light);">
          ${escapeHtml(settings.welcomeMessage || 'ì˜¤ëŠ˜ë„ ë©‹ì§„ ì´ì•¼ê¸°ë¥¼ ë§Œë“¤ì–´ë³¼ê¹Œìš”? ğŸŒŸ')}
        </p>
      </div>
    `;
  }

  /**
   * í•™ìŠµ ë‹¨ê³„ ì¹´ë“œ
   */
  function renderStepCard(step, title, description, icon, isActive = false, isLocked = false) {
    const cardClass = isLocked ? 'opacity: 0.5;' : '';
    const cursorClass = isLocked ? 'cursor: not-allowed;' : 'cursor: pointer;';

    return `
      <div class="card ${isActive ? 'active-step' : ''}"
           style="${cardClass} ${cursorClass} transition: transform 0.2s;"
           onclick="${isLocked ? '' : `startStep(${step})`}"
           onmouseover="this.style.transform='translateY(-4px)'"
           onmouseout="this.style.transform='translateY(0)'">
        <div class="flex items-center gap-2 mb-2">
          <span style="font-size: 2rem;">${icon}</span>
          <div>
            <h3 style="margin: 0;">STEP ${step}</h3>
            <p style="font-weight: 600; margin: 0;">${escapeHtml(title)}</p>
          </div>
          ${isLocked ? '<span style="margin-left: auto;">ğŸ”’</span>' : ''}
        </div>
        <p style="color: var(--text-light); font-size: 0.9rem;">${escapeHtml(description)}</p>
      </div>
    `;
  }

  /**
   * í•™ìƒ ëª©ë¡ í…Œì´ë¸”
   */
  function renderStudentTable(students) {
    if (!students || students.length === 0) {
      return renderEmptyState(
        'ğŸ‘¨â€ğŸ“',
        'ë“±ë¡ëœ í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤',
        'í•™ìƒì„ ë“±ë¡í•´ì£¼ì„¸ìš”.',
        '<button class="btn btn-primary mt-2" onclick="showAddStudentModal()">í•™ìƒ ë“±ë¡í•˜ê¸°</button>'
      );
    }

    return `
      <div class="table-container">
        <table class="table">
          <thead>
            <tr>
              <th>ë²ˆí˜¸</th>
              <th>ì´ë¦„</th>
              <th>ìƒíƒœ</th>
              <th>ë§ˆì§€ë§‰ ì ‘ì†</th>
              <th class="hide-mobile">ë“±ë¡ì¼</th>
              <th>ì•¡ì…˜</th>
            </tr>
          </thead>
          <tbody>
            ${students.map(student => `
              <tr>
                <td>${student.number}</td>
                <td>${escapeHtml(student.name)}</td>
                <td>${renderStatusBadge(student.status)}</td>
                <td>${student.lastAccessRelative || 'ì—†ìŒ'}</td>
                <td class="hide-mobile">${formatDateShort(student.createdAt)}</td>
                <td>
                  <div class="flex gap-1">
                    <button class="btn btn-sm btn-ghost" title="QR ë‹¤ìš´ë¡œë“œ"
                            onclick="downloadStudentQR('${escapeHtml(student.name)}', ${student.number}, '${student.token}')">
                      ğŸ“±
                    </button>
                    <button class="btn btn-sm btn-ghost" title="PIN ì¬ì„¤ì •"
                            onclick="showResetPinModal('${escapeHtml(student.name)}', ${student.number})">
                      ğŸ”‘
                    </button>
                    <button class="btn btn-sm btn-ghost" title="ë”ë³´ê¸°"
                            onclick="showStudentMenu('${escapeHtml(student.name)}', ${student.number}, '${student.status}')">
                      â‹®
                    </button>
                  </div>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>
    `;
  }

  /**
   * PIN ì…ë ¥ ì»´í¬ë„ŒíŠ¸
   */
  function renderPinInput(id, label = 'PIN ì…ë ¥') {
    return `
      <div class="form-group">
        <label class="form-label">${escapeHtml(label)} (ìˆ«ì 6ìë¦¬)</label>
        <div id="${id}" class="pin-input-container">
          <input type="tel" class="pin-input" maxlength="1" pattern="[0-9]" inputmode="numeric">
          <input type="tel" class="pin-input" maxlength="1" pattern="[0-9]" inputmode="numeric">
          <input type="tel" class="pin-input" maxlength="1" pattern="[0-9]" inputmode="numeric">
          <input type="tel" class="pin-input" maxlength="1" pattern="[0-9]" inputmode="numeric">
          <input type="tel" class="pin-input" maxlength="1" pattern="[0-9]" inputmode="numeric">
          <input type="tel" class="pin-input" maxlength="1" pattern="[0-9]" inputmode="numeric">
        </div>
      </div>
    `;
  }
</script>
