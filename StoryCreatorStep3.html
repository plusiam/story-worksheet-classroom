<script>
  /* ============================================
     ìŠ¤í† ë¦¬ í¬ë¦¬ì—ì´í„° - STEP 3: ë‚´ ê·¸ë¦¼ìœ¼ë¡œ ì™„ì„±í•˜ê¸°
     - Step 2ì˜ ì¥ë©´ë“¤ì— ì´ë¯¸ì§€ë¥¼ ì¶”ê°€í•˜ì—¬ ìŠ¤í† ë¦¬ë³´ë“œ ì™„ì„±
     - AI ê·¸ë¦¼ íŒíŠ¸ ì œê³µ (ê¸°ì¡´ Gemini API í™œìš©)
     - ì´ë¯¸ì§€ ì—…ë¡œë“œ (ì¹´ë©”ë¼/ê°¤ëŸ¬ë¦¬)
     - ì´ë¯¸ì§€ í¬ë¡­/íšŒì „ ê¸°ëŠ¥
     - PDF ë‚´ë³´ë‚´ê¸°
     ============================================ */

  // ìƒìˆ˜ ì •ì˜
  const STEP3_AUTO_SAVE_INTERVAL_MS = 30000;
  const MAX_IMAGE_SIZE_MB = 5;
  const SUPPORTED_IMAGE_TYPES = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];

  let step3Data = {
    studentName: '',
    studentNumber: 0,
    title: '',
    scenes: [],        // Step 2ì—ì„œ ê°€ì ¸ì˜¨ ì¥ë©´ë“¤
    sceneImages: {},   // { sceneId: { imageData, uploadType, uploadedAt } }
    drawingGuides: {}  // { sceneId: { hints: {...}, userAdditions: [...], editedItems: {...} } }
  };

  // í˜„ì¬ ì„ íƒëœ ì¥ë©´
  let selectedSceneIndex = 0;

  // ì €ì¥ ì¤‘ í”Œë˜ê·¸
  let isSavingStep3 = false;

  // ì´ë¯¸ì§€ í¸ì§‘ ìƒíƒœ
  let imageEditState = {
    sceneId: null,
    originalImage: null,
    rotation: 0,
    cropData: null
  };

  async function renderStoryCreatorStep3(container, data) {
    step3Data.studentName = data?.studentName || AppState.currentUser?.name;
    step3Data.studentNumber = data?.studentNumber || AppState.currentUser?.number;

    // Step 2 ë°ì´í„° ë¡œë“œ
    try {
      showLoading('Step 2 ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...');
      const step2Result = await callApi('getWork', {
        studentName: step3Data.studentName,
        studentNumber: step3Data.studentNumber,
        step: 2
      });

      if (step2Result.success && step2Result.data) {
        step3Data.scenes = step2Result.data.workData?.scenes || [];
        step3Data.title = step2Result.data.workData?.title || '';
      } else {
        hideLoading();
        showToast('Step 2 ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € Step 2ë¥¼ ì™„ë£Œí•´ì£¼ì„¸ìš”.', 'error');
        navigateTo('student-main');
        return;
      }
    } catch (error) {
      console.error('Step 2 ë¡œë“œ ì‹¤íŒ¨:', error);
      hideLoading();
      showToast('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨', 'error');
      navigateTo('student-main');
      return;
    } finally {
      hideLoading();
    }

    // ê¸°ì¡´ Step 3 ë°ì´í„°ê°€ ìˆëŠ”ì§€ í™•ì¸
    if (data?.existingWork?.workData?.sceneImages) {
      step3Data.sceneImages = data.existingWork.workData.sceneImages;
    }

    // ê¸°ì¡´ ê·¸ë¦¼ ê°€ì´ë“œ ë°ì´í„° ë¡œë“œ
    if (data?.existingWork?.workData?.drawingGuides) {
      step3Data.drawingGuides = data.existingWork.workData.drawingGuides;
    } else {
      // localStorageì—ì„œ ë³µì› ì‹œë„
      step3Data.scenes.forEach(scene => {
        try {
          const storageKey = `drawingGuide_${step3Data.studentNumber}_${scene.id}`;
          const saved = localStorage.getItem(storageKey);
          if (saved) {
            step3Data.drawingGuides[scene.id] = JSON.parse(saved);
          }
        } catch (e) {
          console.warn('localStorage ë¡œë“œ ì‹¤íŒ¨:', e);
        }
      });
    }

    renderStep3UI(container);
  }

  function renderStep3UI(container) {
    const completedCount = Object.keys(step3Data.sceneImages).filter(
      id => step3Data.sceneImages[id]?.imageData
    ).length;
    const totalCount = step3Data.scenes.length;
    const progressPercent = totalCount > 0 ? Math.round((completedCount / totalCount) * 100) : 0;

    container.innerHTML = `
      <div class="container fade-in">
        ${renderStudentHeader('STEP 3: ë‚´ ê·¸ë¦¼ìœ¼ë¡œ ì™„ì„±í•˜ê¸°')}

        <!-- ì•ˆë‚´ ì¹´ë“œ -->
        <div class="card mb-3" style="background: linear-gradient(135deg, #fef3c7 0%, #fef9c3 100%);">
          <div class="flex items-center gap-3">
            <span style="font-size: 2rem;">ğŸ¨</span>
            <div>
              <h3 style="margin: 0 0 4px 0;">ì§ì ‘ ê·¸ë¦° ê·¸ë¦¼ì´ë‚˜ ì‚¬ì§„ìœ¼ë¡œ ì´ì•¼ê¸°ë¥¼ ì™„ì„±í•´ë³´ì„¸ìš”!</h3>
              <p style="margin: 0; color: var(--text-light); font-size: 0.9rem;">
                ê° ì¥ë©´ì— ì–´ìš¸ë¦¬ëŠ” ê·¸ë¦¼ì„ ê·¸ë¦¬ê±°ë‚˜ ì‚¬ì§„ì„ ì°ì–´ì„œ ì¶”ê°€í•  ìˆ˜ ìˆì–´ìš”.
              </p>
            </div>
          </div>
        </div>

        <!-- ì§„í–‰ ìƒí™© -->
        <div class="card mb-3">
          <div class="flex justify-between items-center mb-2">
            <div>
              <h3 style="margin: 0;">ğŸ“– ${escapeHtml(step3Data.title)}</h3>
              <span class="badge" style="background: var(--primary-light); color: var(--primary); margin-top: 4px;">
                ${completedCount}/${totalCount} ì¥ë©´ ì™„ì„±
              </span>
            </div>
            <div class="flex gap-2">
              <button class="btn btn-outline" id="btn-save-step3" onclick="saveStep3(false)">
                ğŸ’¾ ì €ì¥í•˜ê¸°
              </button>
              <button class="btn btn-primary" id="btn-submit-step3" onclick="saveStep3(true)">
                ğŸ“® ì œì¶œí•˜ê¸°
              </button>
            </div>
          </div>

          <!-- ì§„í–‰ë¥  ë°” -->
          <div class="progress-bar-container">
            <div class="progress-bar-fill" style="width: ${progressPercent}%;"></div>
          </div>
          <p style="text-align: center; font-size: 0.85rem; color: var(--text-muted); margin-top: 4px;">
            ì™„ì„±ë„ ${progressPercent}%
          </p>
        </div>

        <!-- ì¥ë©´ ì¸ë„¤ì¼ ë„¤ë¹„ê²Œì´ì…˜ -->
        <div class="scene-thumbnails mb-3" id="scene-thumbnails">
          ${renderSceneThumbnails()}
        </div>

        <!-- ì„ íƒëœ ì¥ë©´ í¸ì§‘ ì˜ì—­ -->
        <div class="card" id="scene-editor">
          ${renderSceneEditor()}
        </div>

        <!-- í•˜ë‹¨ ë²„íŠ¼ -->
        <div class="flex justify-between mt-3">
          <button class="btn btn-ghost" onclick="confirmExitStep3()">
            â† ëŒì•„ê°€ê¸°
          </button>
          <div class="flex gap-2">
            <button class="btn btn-outline" onclick="previewStoryboard()">
              ğŸ‘ï¸ ë¯¸ë¦¬ë³´ê¸°
            </button>
            <button class="btn btn-secondary" onclick="exportToPDF()">
              ğŸ“„ PDF ì €ì¥
            </button>
          </div>
        </div>
      </div>

      <!-- ìˆ¨ê²¨ì§„ íŒŒì¼ ì…ë ¥ -->
      <input type="file" id="image-file-input" accept="image/*" style="display: none;" onchange="handleFileSelect(event)">
      <input type="file" id="camera-input" accept="image/*" capture="environment" style="display: none;" onchange="handleFileSelect(event)">

      <style>
        .progress-bar-container {
          height: 8px;
          background: var(--border);
          border-radius: 4px;
          overflow: hidden;
        }

        .progress-bar-fill {
          height: 100%;
          background: linear-gradient(90deg, var(--primary), var(--success));
          border-radius: 4px;
          transition: width 0.3s ease;
        }

        .scene-thumbnails {
          display: flex;
          gap: 12px;
          overflow-x: auto;
          padding: 8px 4px;
          -webkit-overflow-scrolling: touch;
        }

        .scene-thumb {
          flex-shrink: 0;
          width: 100px;
          cursor: pointer;
          transition: transform 0.2s;
        }

        .scene-thumb:hover {
          transform: translateY(-4px);
        }

        .scene-thumb.active {
          transform: translateY(-4px);
        }

        .scene-thumb-inner {
          width: 100px;
          height: 80px;
          border-radius: 8px;
          border: 3px solid var(--border);
          background: var(--bg);
          display: flex;
          align-items: center;
          justify-content: center;
          overflow: hidden;
          position: relative;
        }

        .scene-thumb.active .scene-thumb-inner {
          border-color: var(--primary);
          box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        .scene-thumb.completed .scene-thumb-inner {
          border-color: var(--success);
        }

        .scene-thumb-inner img {
          width: 100%;
          height: 100%;
          object-fit: cover;
        }

        .scene-thumb-placeholder {
          font-size: 1.5rem;
          color: var(--text-muted);
        }

        .scene-thumb-label {
          text-align: center;
          font-size: 0.75rem;
          margin-top: 4px;
          color: var(--text-light);
          white-space: nowrap;
          overflow: hidden;
          text-overflow: ellipsis;
        }

        .scene-thumb-number {
          position: absolute;
          top: 4px;
          left: 4px;
          width: 20px;
          height: 20px;
          background: var(--primary);
          color: white;
          border-radius: 50%;
          font-size: 0.7rem;
          display: flex;
          align-items: center;
          justify-content: center;
          font-weight: 700;
        }

        .scene-thumb.completed .scene-thumb-number {
          background: var(--success);
        }

        /* P2: ê°€ì´ë“œ ì¸ë””ì¼€ì´í„° */
        .guide-indicator {
          position: absolute;
          bottom: 4px;
          right: 4px;
          width: 22px;
          height: 22px;
          background: white;
          border-radius: 50%;
          font-size: 0.75rem;
          display: flex;
          align-items: center;
          justify-content: center;
          box-shadow: 0 2px 6px rgba(0,0,0,0.15);
          border: 2px solid #10b981;
        }

        .scene-editor-content {
          display: grid;
          grid-template-columns: 1fr 1fr;
          gap: 24px;
        }

        @media (max-width: 768px) {
          .scene-editor-content {
            grid-template-columns: 1fr;
          }
        }

        .scene-image-area {
          background: var(--bg);
          border-radius: 12px;
          min-height: 300px;
          display: flex;
          flex-direction: column;
          align-items: center;
          justify-content: center;
          border: 3px dashed var(--border);
          position: relative;
          overflow: hidden;
        }

        .scene-image-area.has-image {
          border-style: solid;
          border-color: var(--success);
        }

        .scene-image-area img {
          max-width: 100%;
          max-height: 300px;
          object-fit: contain;
        }

        .image-upload-options {
          display: flex;
          gap: 12px;
          margin-top: 16px;
        }

        .upload-option-btn {
          display: flex;
          flex-direction: column;
          align-items: center;
          gap: 8px;
          padding: 16px 24px;
          background: white;
          border: 2px solid var(--border);
          border-radius: 12px;
          cursor: pointer;
          transition: all 0.2s;
        }

        .upload-option-btn:hover {
          border-color: var(--primary);
          background: var(--primary-light);
          transform: translateY(-2px);
        }

        .upload-option-btn .icon {
          font-size: 2rem;
        }

        .upload-option-btn .label {
          font-size: 0.9rem;
          font-weight: 500;
        }

        .scene-description-area {
          display: flex;
          flex-direction: column;
        }

        .scene-description-box {
          background: var(--bg);
          padding: 16px;
          border-radius: 8px;
          margin-bottom: 16px;
        }

        .scene-description-box h4 {
          margin: 0 0 8px 0;
          display: flex;
          align-items: center;
          gap: 8px;
        }

        .scene-description-box p {
          margin: 0;
          line-height: 1.6;
        }

        .scene-dialogue {
          font-style: italic;
          color: var(--primary);
          margin-top: 8px;
          padding-left: 12px;
          border-left: 3px solid var(--primary);
        }

        .hint-btn {
          display: flex;
          align-items: center;
          gap: 8px;
          padding: 12px 20px;
          background: linear-gradient(135deg, #fef3c7, #fef9c3);
          border: 2px solid #f59e0b;
          border-radius: 8px;
          cursor: pointer;
          transition: all 0.2s;
          margin-top: auto;
        }

        .hint-btn:hover {
          background: #fef3c7;
          transform: translateY(-2px);
          box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
        }

        .hint-btn:disabled {
          opacity: 0.5;
          cursor: not-allowed;
          transform: none;
        }

        .image-actions {
          position: absolute;
          bottom: 12px;
          right: 12px;
          display: flex;
          gap: 8px;
        }

        .image-action-btn {
          width: 36px;
          height: 36px;
          border-radius: 50%;
          background: white;
          border: 1px solid var(--border);
          cursor: pointer;
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 1rem;
          transition: all 0.2s;
          box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .image-action-btn:hover {
          background: var(--primary-light);
          border-color: var(--primary);
        }

        .image-action-btn.delete:hover {
          background: #fee2e2;
          border-color: var(--danger);
        }

        /* íŒíŠ¸ ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .hint-modal-content {
          max-height: 400px;
          overflow-y: auto;
        }

        .hint-section {
          background: var(--bg);
          padding: 16px;
          border-radius: 8px;
          margin-bottom: 12px;
        }

        .hint-section h4 {
          margin: 0 0 12px 0;
          display: flex;
          align-items: center;
          gap: 8px;
        }

        .hint-section ul {
          margin: 0;
          padding-left: 20px;
        }

        .hint-section li {
          margin-bottom: 8px;
          line-height: 1.5;
        }

        /* ì´ë¯¸ì§€ í¸ì§‘ ëª¨ë‹¬ */
        .image-edit-area {
          position: relative;
          background: #000;
          border-radius: 8px;
          overflow: hidden;
          display: flex;
          align-items: center;
          justify-content: center;
          min-height: 300px;
        }

        .image-edit-area img {
          max-width: 100%;
          max-height: 400px;
          transition: transform 0.3s;
        }

        .edit-controls {
          display: flex;
          justify-content: center;
          gap: 12px;
          margin-top: 16px;
        }

        .edit-control-btn {
          padding: 12px 20px;
          border-radius: 8px;
          border: 2px solid var(--border);
          background: white;
          cursor: pointer;
          display: flex;
          align-items: center;
          gap: 8px;
          transition: all 0.2s;
        }

        .edit-control-btn:hover {
          border-color: var(--primary);
          background: var(--primary-light);
        }
      </style>
    `;

    startAutoSaveStep3();
  }

  /**
   * ì¥ë©´ ì¸ë„¤ì¼ ë Œë”ë§
   */
  function renderSceneThumbnails() {
    return step3Data.scenes.map((scene, index) => {
      const imageData = step3Data.sceneImages[scene.id]?.imageData;
      const isActive = index === selectedSceneIndex;
      const isCompleted = !!imageData;

      // P2: ê°€ì´ë“œ ìƒíƒœ í™•ì¸
      const guide = step3Data.drawingGuides[scene.id];
      const hasGuide = !!guide;
      const hasUserIdeas = guide?.userAdditions?.length > 0;
      const hasEdits = guide?.editedItems && Object.keys(guide.editedItems).length > 0;

      return `
        <div class="scene-thumb ${isActive ? 'active' : ''} ${isCompleted ? 'completed' : ''}"
             onclick="selectScene(${index})">
          <div class="scene-thumb-inner">
            <span class="scene-thumb-number">${index + 1}</span>
            ${imageData ?
              `<img src="${imageData}" alt="ì¥ë©´ ${index + 1}">` :
              `<span class="scene-thumb-placeholder">+</span>`
            }
            ${hasGuide ? `
              <span class="guide-indicator" title="${hasUserIdeas ? 'ë‚´ ì•„ì´ë””ì–´ í¬í•¨' : (hasEdits ? 'ìˆ˜ì •ëœ ê°€ì´ë“œ' : 'ê°€ì´ë“œ ì €ì¥ë¨')}">
                ${hasUserIdeas ? 'ğŸ’­' : (hasEdits ? 'âœï¸' : 'ğŸ“')}
              </span>
            ` : ''}
          </div>
          <div class="scene-thumb-label">${escapeHtml(scene.stageName || `ì¥ë©´ ${index + 1}`)}</div>
        </div>
      `;
    }).join('');
  }

  /**
   * ì¥ë©´ í¸ì§‘ê¸° ë Œë”ë§
   */
  function renderSceneEditor() {
    if (step3Data.scenes.length === 0) {
      return `
        <div class="empty-state">
          <div class="empty-state-icon">ğŸ“­</div>
          <h3>ì¥ë©´ì´ ì—†ìŠµë‹ˆë‹¤</h3>
          <p>Step 2ì—ì„œ ì¥ë©´ì„ ë¨¼ì € ë§Œë“¤ì–´ì£¼ì„¸ìš”.</p>
        </div>
      `;
    }

    const scene = step3Data.scenes[selectedSceneIndex];
    const imageInfo = step3Data.sceneImages[scene.id];
    const hasImage = !!imageInfo?.imageData;

    return `
      <div class="scene-editor-header mb-3">
        <div class="flex items-center gap-3">
          <div class="scene-number" style="width: 40px; height: 40px; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 1.2rem;">
            ${selectedSceneIndex + 1}
          </div>
          <div>
            <h3 style="margin: 0;">${escapeHtml(scene.stageName || `ì¥ë©´ ${selectedSceneIndex + 1}`)}</h3>
            <span class="badge ${scene.isOriginal ? '' : 'badge-active'}" style="${scene.isOriginal ? 'background: var(--primary-light); color: var(--primary);' : ''}">
              ${scene.isOriginal ? 'ê¸°ë³¸ ì¥ë©´' : 'ì¶”ê°€ ì¥ë©´'}
            </span>
          </div>
        </div>
      </div>

      <div class="scene-editor-content">
        <!-- ì´ë¯¸ì§€ ì˜ì—­ -->
        <div class="scene-image-area ${hasImage ? 'has-image' : ''}" id="image-area-${scene.id}">
          ${hasImage ? `
            <img src="${imageInfo.imageData}" alt="ì¥ë©´ ì´ë¯¸ì§€" id="scene-image-${scene.id}">
            <div class="image-actions">
              <button class="image-action-btn" onclick="editImage('${scene.id}')" title="í¸ì§‘">
                âœï¸
              </button>
              <button class="image-action-btn" onclick="changeImage('${scene.id}')" title="ë³€ê²½">
                ğŸ”„
              </button>
              <button class="image-action-btn delete" onclick="deleteImage('${scene.id}')" title="ì‚­ì œ">
                ğŸ—‘ï¸
              </button>
            </div>
          ` : `
            <div style="text-align: center; padding: 20px;">
              <p style="font-size: 3rem; margin-bottom: 8px;">ğŸ–¼ï¸</p>
              <p style="color: var(--text-muted); margin-bottom: 16px;">ê·¸ë¦¼ì„ ì¶”ê°€í•´ì£¼ì„¸ìš”</p>

              <div class="image-upload-options">
                <button class="upload-option-btn" onclick="captureFromCamera('${scene.id}')">
                  <span class="icon">ğŸ“·</span>
                  <span class="label">ì´¬ì˜í•˜ê¸°</span>
                </button>
                <button class="upload-option-btn" onclick="selectFromGallery('${scene.id}')">
                  <span class="icon">ğŸ“</span>
                  <span class="label">ê°€ì ¸ì˜¤ê¸°</span>
                </button>
              </div>
            </div>
          `}
        </div>

        <!-- ì„¤ëª… ì˜ì—­ -->
        <div class="scene-description-area">
          <div class="scene-description-box">
            <h4>ğŸ“ ë‚´ê°€ ì“´ ì´ì•¼ê¸°</h4>
            <p>${escapeHtml(scene.description) || '<span style="color: var(--text-muted);">(ì„¤ëª… ì—†ìŒ)</span>'}</p>
            ${scene.dialogue ? `
              <div class="scene-dialogue">"${escapeHtml(scene.dialogue)}"</div>
            ` : ''}
          </div>

          ${renderHintButton(scene.id)}

          <!-- ì¥ë©´ ë„¤ë¹„ê²Œì´ì…˜ -->
          <div class="flex justify-between mt-3">
            <button class="btn btn-ghost" onclick="navigateScene(-1)" ${selectedSceneIndex === 0 ? 'disabled' : ''}>
              â† ì´ì „ ì¥ë©´
            </button>
            <button class="btn btn-ghost" onclick="navigateScene(1)" ${selectedSceneIndex === step3Data.scenes.length - 1 ? 'disabled' : ''}>
              ë‹¤ìŒ ì¥ë©´ â†’
            </button>
          </div>
        </div>
      </div>
    `;
  }

  /**
   * ì¥ë©´ ì„ íƒ
   */
  function selectScene(index) {
    if (index < 0 || index >= step3Data.scenes.length) return;
    selectedSceneIndex = index;

    // ì¸ë„¤ì¼ê³¼ í¸ì§‘ê¸° ì—…ë°ì´íŠ¸
    document.getElementById('scene-thumbnails').innerHTML = renderSceneThumbnails();
    document.getElementById('scene-editor').innerHTML = renderSceneEditor();
  }

  /**
   * ì¥ë©´ ë„¤ë¹„ê²Œì´ì…˜
   */
  function navigateScene(direction) {
    const newIndex = selectedSceneIndex + direction;
    if (newIndex >= 0 && newIndex < step3Data.scenes.length) {
      selectScene(newIndex);
    }
  }

  // í˜„ì¬ ì´ë¯¸ì§€ ì—…ë¡œë“œ ëŒ€ìƒ ì¥ë©´ ID
  let currentUploadSceneId = null;

  /**
   * ì¹´ë©”ë¼ë¡œ ì´¬ì˜
   */
  function captureFromCamera(sceneId) {
    currentUploadSceneId = sceneId;
    document.getElementById('camera-input').click();
  }

  /**
   * ê°¤ëŸ¬ë¦¬ì—ì„œ ì„ íƒ
   */
  function selectFromGallery(sceneId) {
    currentUploadSceneId = sceneId;
    document.getElementById('image-file-input').click();
  }

  /**
   * ì´ë¯¸ì§€ ë³€ê²½
   */
  function changeImage(sceneId) {
    selectFromGallery(sceneId);
  }

  /**
   * íŒŒì¼ ì„ íƒ ì²˜ë¦¬
   */
  function handleFileSelect(event) {
    const file = event.target.files[0];
    if (!file) return;

    // íŒŒì¼ íƒ€ì… ê²€ì¦
    if (!SUPPORTED_IMAGE_TYPES.includes(file.type)) {
      showToast('ì§€ì›í•˜ì§€ ì•ŠëŠ” ì´ë¯¸ì§€ í˜•ì‹ì…ë‹ˆë‹¤. (JPG, PNG, GIF, WebPë§Œ ê°€ëŠ¥)', 'error');
      return;
    }

    // íŒŒì¼ í¬ê¸° ê²€ì¦
    if (file.size > MAX_IMAGE_SIZE_MB * 1024 * 1024) {
      showToast(`ì´ë¯¸ì§€ í¬ê¸°ê°€ ë„ˆë¬´ í½ë‹ˆë‹¤. (ìµœëŒ€ ${MAX_IMAGE_SIZE_MB}MB)`, 'error');
      return;
    }

    const reader = new FileReader();
    reader.onload = function(e) {
      // ì´ë¯¸ì§€ ë¦¬ì‚¬ì´ì¦ˆ ì²˜ë¦¬
      resizeImage(e.target.result, 1200, 1200, (resizedData) => {
        saveImageToScene(currentUploadSceneId, resizedData, 'gallery');
      });
    };
    reader.readAsDataURL(file);

    // ì…ë ¥ ì´ˆê¸°í™”
    event.target.value = '';
  }

  /**
   * ì´ë¯¸ì§€ ë¦¬ì‚¬ì´ì¦ˆ
   */
  function resizeImage(dataUrl, maxWidth, maxHeight, callback) {
    const img = new Image();
    img.onload = function() {
      let width = img.width;
      let height = img.height;

      // í¬ê¸° ì¡°ì • í•„ìš” ì—¬ë¶€ í™•ì¸
      if (width <= maxWidth && height <= maxHeight) {
        callback(dataUrl);
        return;
      }

      // ë¹„ìœ¨ ìœ ì§€í•˜ë©° í¬ê¸° ì¡°ì •
      if (width > height) {
        if (width > maxWidth) {
          height = Math.round(height * maxWidth / width);
          width = maxWidth;
        }
      } else {
        if (height > maxHeight) {
          width = Math.round(width * maxHeight / height);
          height = maxHeight;
        }
      }

      const canvas = document.createElement('canvas');
      canvas.width = width;
      canvas.height = height;

      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0, width, height);

      callback(canvas.toDataURL('image/jpeg', 0.85));
    };
    img.src = dataUrl;
  }

  /**
   * ì´ë¯¸ì§€ ì €ì¥
   */
  function saveImageToScene(sceneId, imageData, uploadType) {
    step3Data.sceneImages[sceneId] = {
      imageData: imageData,
      uploadType: uploadType,
      uploadedAt: new Date().toISOString()
    };

    // UI ì—…ë°ì´íŠ¸
    document.getElementById('scene-thumbnails').innerHTML = renderSceneThumbnails();
    document.getElementById('scene-editor').innerHTML = renderSceneEditor();
    updateProgressUI();

    showToast('ì´ë¯¸ì§€ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ¨', 'success');
  }

  /**
   * ì´ë¯¸ì§€ ì‚­ì œ
   */
  function deleteImage(sceneId) {
    showConfirm('ì´ ì´ë¯¸ì§€ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?', () => {
      delete step3Data.sceneImages[sceneId];

      document.getElementById('scene-thumbnails').innerHTML = renderSceneThumbnails();
      document.getElementById('scene-editor').innerHTML = renderSceneEditor();
      updateProgressUI();

      showToast('ì´ë¯¸ì§€ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
    });
  }

  /**
   * ì´ë¯¸ì§€ í¸ì§‘ (íšŒì „)
   */
  function editImage(sceneId) {
    const imageInfo = step3Data.sceneImages[sceneId];
    if (!imageInfo) return;

    imageEditState = {
      sceneId: sceneId,
      originalImage: imageInfo.imageData,
      rotation: 0
    };

    showModal({
      title: 'ğŸ–¼ï¸ ì´ë¯¸ì§€ í¸ì§‘',
      content: `
        <div class="image-edit-area">
          <img src="${imageInfo.imageData}" id="edit-preview-image" style="transform: rotate(0deg);">
        </div>
        <div class="edit-controls">
          <button class="edit-control-btn" onclick="rotateEditImage(-90)">
            â†º ì™¼ìª½ íšŒì „
          </button>
          <button class="edit-control-btn" onclick="rotateEditImage(90)">
            â†» ì˜¤ë¥¸ìª½ íšŒì „
          </button>
        </div>
      `,
      buttons: [
        { text: 'ì·¨ì†Œ', class: 'btn-ghost', action: () => hideModal() },
        { text: 'ì ìš©', class: 'btn-primary', action: () => applyImageEdit() }
      ]
    });
  }

  /**
   * ì´ë¯¸ì§€ íšŒì „
   */
  function rotateEditImage(degrees) {
    imageEditState.rotation = (imageEditState.rotation + degrees) % 360;
    const previewImg = document.getElementById('edit-preview-image');
    if (previewImg) {
      previewImg.style.transform = `rotate(${imageEditState.rotation}deg)`;
    }
  }

  /**
   * ì´ë¯¸ì§€ í¸ì§‘ ì ìš©
   */
  function applyImageEdit() {
    if (!imageEditState.sceneId || imageEditState.rotation === 0) {
      hideModal();
      return;
    }

    const img = new Image();
    img.onload = function() {
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');

      // 90ë„ ë˜ëŠ” 270ë„ íšŒì „ ì‹œ ìº”ë²„ìŠ¤ í¬ê¸° ë³€ê²½
      if (Math.abs(imageEditState.rotation) === 90 || Math.abs(imageEditState.rotation) === 270) {
        canvas.width = img.height;
        canvas.height = img.width;
      } else {
        canvas.width = img.width;
        canvas.height = img.height;
      }

      // ìº”ë²„ìŠ¤ ì¤‘ì‹¬ìœ¼ë¡œ ì´ë™ í›„ íšŒì „
      ctx.translate(canvas.width / 2, canvas.height / 2);
      ctx.rotate(imageEditState.rotation * Math.PI / 180);
      ctx.drawImage(img, -img.width / 2, -img.height / 2);

      const rotatedData = canvas.toDataURL('image/jpeg', 0.85);
      step3Data.sceneImages[imageEditState.sceneId].imageData = rotatedData;

      // UI ì—…ë°ì´íŠ¸
      document.getElementById('scene-thumbnails').innerHTML = renderSceneThumbnails();
      document.getElementById('scene-editor').innerHTML = renderSceneEditor();

      hideModal();
      showToast('ì´ë¯¸ì§€ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
    };
    img.src = imageEditState.originalImage;
  }

  /**
   * ì§„í–‰ë¥  UI ì—…ë°ì´íŠ¸
   */
  function updateProgressUI() {
    const completedCount = Object.keys(step3Data.sceneImages).filter(
      id => step3Data.sceneImages[id]?.imageData
    ).length;
    const totalCount = step3Data.scenes.length;
    const progressPercent = totalCount > 0 ? Math.round((completedCount / totalCount) * 100) : 0;

    // ë°°ì§€ ì—…ë°ì´íŠ¸
    const badge = document.querySelector('.card .badge');
    if (badge && badge.textContent.includes('ì¥ë©´ ì™„ì„±')) {
      badge.textContent = `${completedCount}/${totalCount} ì¥ë©´ ì™„ì„±`;
    }

    // ì§„í–‰ë¥  ë°” ì—…ë°ì´íŠ¸
    const progressFill = document.querySelector('.progress-bar-fill');
    if (progressFill) {
      progressFill.style.width = `${progressPercent}%`;
    }

    // í¼ì„¼íŠ¸ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
    const percentText = document.querySelector('.progress-bar-container + p');
    if (percentText) {
      percentText.textContent = `ì™„ì„±ë„ ${progressPercent}%`;
    }
  }

  /**
   * íŒíŠ¸ ë²„íŠ¼ ë Œë”ë§
   */
  function renderHintButton(sceneId) {
    const hasSavedGuide = step3Data.drawingGuides && step3Data.drawingGuides[sceneId];
    const guideInfo = hasSavedGuide ? step3Data.drawingGuides[sceneId] : null;
    const hasUserAdditions = guideInfo?.userAdditions?.length > 0;
    const hasEdits = guideInfo?.editedItems && Object.keys(guideInfo.editedItems).length > 0;

    if (hasSavedGuide) {
      return `
        <button class="hint-btn saved-guide" onclick="showDrawingHint('${sceneId}')" id="hint-btn-${sceneId}">
          <span style="font-size: 1.5rem;">ğŸ“</span>
          <div>
            <strong>ë‚˜ì˜ ê·¸ë¦¼ ê°€ì´ë“œ</strong>
            <p style="margin: 0; font-size: 0.85rem; color: var(--text-light);">
              ${hasUserAdditions ? 'âœ¨ ë‚´ ì•„ì´ë””ì–´ ì¶”ê°€ë¨' : ''}
              ${hasEdits ? 'âœï¸ ìˆ˜ì •ë¨' : ''}
              ${!hasUserAdditions && !hasEdits ? 'ì €ì¥ëœ ê°€ì´ë“œ ë³´ê¸°' : ''}
            </p>
          </div>
          <span class="saved-badge">ì €ì¥ë¨</span>
        </button>
        <style>
          .hint-btn.saved-guide {
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
            border-color: #10b981;
            position: relative;
          }
          .saved-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #10b981;
            color: white;
            font-size: 0.7rem;
            padding: 2px 8px;
            border-radius: 10px;
            font-weight: 600;
          }
        </style>
      `;
    }

    return `
      <button class="hint-btn" onclick="showDrawingHint('${sceneId}')" id="hint-btn-${sceneId}">
        <span style="font-size: 1.5rem;">ğŸ’¡</span>
        <div>
          <strong>ê·¸ë¦¼ íŒíŠ¸ ë³´ê¸°</strong>
          <p style="margin: 0; font-size: 0.85rem; color: var(--text-light);">ë˜ë¦¬ê°€ ê·¸ë¦¼ íŒì„ ì•Œë ¤ì¤˜ìš”!</p>
        </div>
      </button>
    `;
  }

  /**
   * ê·¸ë¦¼ íŒíŠ¸ ë³´ê¸° (AI í™œìš©)
   */
  async function showDrawingHint(sceneId) {
    const scene = step3Data.scenes.find(s => s.id === sceneId);
    if (!scene) return;

    // ì €ì¥ëœ ê°€ì´ë“œê°€ ìˆìœ¼ë©´ ë°”ë¡œ ëª¨ë‹¬ í‘œì‹œ
    const savedGuide = step3Data.drawingGuides[sceneId];
    if (savedGuide && savedGuide.hints) {
      showHintModal(scene, savedGuide.hints);
      return;
    }

    const hintBtn = document.getElementById(`hint-btn-${sceneId}`);
    if (hintBtn) {
      hintBtn.disabled = true;
      hintBtn.innerHTML = `
        <span style="font-size: 1.5rem;">â³</span>
        <div>
          <strong>íŒíŠ¸ ìƒì„± ì¤‘...</strong>
          <p style="margin: 0; font-size: 0.85rem; color: var(--text-light);">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”</p>
        </div>
      `;
    }

    try {
      // ë˜ë¦¬ AIì—ê²Œ ê·¸ë¦¼ íŒíŠ¸ ìš”ì²­
      const result = await callApi('getDrawingHint', {
        sceneDescription: scene.description,
        sceneDialogue: scene.dialogue,
        stageName: scene.stageName
      });

      if (result.success && result.hint) {
        showHintModal(scene, result.hint);
      } else {
        // AI ì‘ë‹µ ì‹¤íŒ¨ ì‹œ ê¸°ë³¸ íŒíŠ¸ ì œê³µ
        showHintModal(scene, generateDefaultHint(scene));
      }
    } catch (error) {
      console.error('íŒíŠ¸ ìƒì„± ì‹¤íŒ¨:', error);
      showHintModal(scene, generateDefaultHint(scene));
    } finally {
      // ë²„íŠ¼ ë³µì› - ì €ì¥ëœ ê°€ì´ë“œ ì—¬ë¶€ì— ë”°ë¼ ë‹¤ë¥´ê²Œ í‘œì‹œ
      refreshHintButton(sceneId);
    }
  }

  /**
   * íŒíŠ¸ ë²„íŠ¼ ìƒˆë¡œê³ ì¹¨
   */
  function refreshHintButton(sceneId) {
    const hintBtn = document.getElementById(`hint-btn-${sceneId}`);
    if (hintBtn) {
      hintBtn.disabled = false;
      hintBtn.outerHTML = renderHintButton(sceneId);
    }
  }

  /**
   * ê¸°ë³¸ íŒíŠ¸ ìƒì„± (AI ì‹¤íŒ¨ ì‹œ)
   */
  function generateDefaultHint(scene) {
    return {
      whatToDraw: [
        'ì¥ë©´ì— ë‚˜ì˜¤ëŠ” ì£¼ì¸ê³µì„ ê·¸ë ¤ë³´ì„¸ìš”',
        'ë°°ê²½(ì¥ì†Œ)ì„ ê°„ë‹¨íˆ í‘œí˜„í•´ë³´ì„¸ìš”',
        'ì¤‘ìš”í•œ ë¬¼ê±´ì´ë‚˜ ì†Œí’ˆì„ ì¶”ê°€í•´ë³´ì„¸ìš”'
      ],
      whereToPut: [
        'ì£¼ì¸ê³µì€ ê·¸ë¦¼ ì¤‘ì•™ì— í¬ê²Œ ê·¸ë ¤ë³´ì„¸ìš”',
        'ë°°ê²½ì€ ë’¤ìª½ì— ê°„ë‹¨íˆ ê·¸ë ¤ìš”',
        'ëŒ€ì‚¬ê°€ ìˆë‹¤ë©´ ë§í’ì„ ì„ ì¶”ê°€í•´ë³´ì„¸ìš”'
      ],
      tips: [
        'ìƒ‰ì—°í•„ì´ë‚˜ ì‚¬ì¸íœìœ¼ë¡œ ìƒ‰ì¹ í•˜ë©´ ë” ì˜ˆë»ìš”',
        'í‘œì •ì„ ë„£ìœ¼ë©´ ê°ì •ì´ ì˜ ì „ë‹¬ë¼ìš”',
        'ë°°ê²½ì— êµ¬ë¦„ì´ë‚˜ ë‚˜ë¬´ë¥¼ ê·¸ë ¤ë³´ì„¸ìš”'
      ]
    };
  }

  /**
   * íŒíŠ¸ ëª¨ë‹¬ í‘œì‹œ (í¸ì§‘ ê°€ëŠ¥ ë²„ì „)
   */
  function showHintModal(scene, hint) {
    // ê¸°ì¡´ ì €ì¥ëœ ê°€ì´ë“œê°€ ìˆëŠ”ì§€ í™•ì¸
    const existingGuide = step3Data.drawingGuides[scene.id];

    // ì €ì¥ëœ ë°ì´í„°ê°€ ìˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ AI íŒíŠ¸ ì‚¬ìš©
    const currentHints = existingGuide?.hints || hint;
    const userAdditions = existingGuide?.userAdditions || [];
    const editedItems = existingGuide?.editedItems || {};

    // í˜„ì¬ í¸ì§‘ ì¤‘ì¸ ì¥ë©´ ID ì €ì¥
    window.currentEditingSceneId = scene.id;
    window.currentEditingHints = JSON.parse(JSON.stringify(currentHints)); // ê¹Šì€ ë³µì‚¬
    window.currentUserAdditions = [...userAdditions];
    window.currentEditedItems = {...editedItems};
    // ì›ë³¸ íŒíŠ¸ ì €ì¥ (ì´ˆê¸°í™”ìš©)
    window.originalHints = JSON.parse(JSON.stringify(hint));

    // ê°€ì´ë“œ ì™„ì„±ë„ ê³„ì‚°
    const completionInfo = calculateGuideCompletion(currentHints, userAdditions, editedItems);

    showModal({
      title: `ğŸ’¡ ë‚˜ì˜ ê·¸ë¦¼ ê°€ì´ë“œ: ${escapeHtml(scene.stageName)}`,
      content: renderEditableHintContent(currentHints, userAdditions, editedItems, completionInfo),
      buttons: [
        { text: 'ì·¨ì†Œ', class: 'btn-ghost', action: () => hideModal() },
        { text: 'ğŸ’¾ ì €ì¥í•˜ê¸°', class: 'btn-primary', action: () => saveDrawingGuide(scene.id) }
      ],
      extraActions: `
        <div class="modal-extra-actions" style="display: flex; gap: 8px; margin-right: auto;">
          <button class="btn btn-outline btn-sm" onclick="downloadGuideAsPDF('${scene.id}')" title="PDFë¡œ ë‹¤ìš´ë¡œë“œ">
            ğŸ“„ PDF
          </button>
          <button class="btn btn-outline btn-sm" onclick="refreshAiHints('${scene.id}')" title="AIì—ê²Œ ìƒˆë¡œìš´ íŒíŠ¸ ìš”ì²­">
            ğŸ”„ ìƒˆ íŒíŠ¸
          </button>
          <button class="btn btn-outline btn-sm" onclick="resetGuideToOriginal()" title="ì›ë˜ AI íŒíŠ¸ë¡œ ë˜ëŒë¦¬ê¸°">
            â†©ï¸ ì´ˆê¸°í™”
          </button>
        </div>
      `
    });
  }

  /**
   * ê°€ì´ë“œ ì™„ì„±ë„ ê³„ì‚°
   */
  function calculateGuideCompletion(hints, userAdditions, editedItems) {
    let totalItems = 0;
    let customizedItems = 0;

    // AI íŒíŠ¸ í•­ëª© ìˆ˜
    ['whatToDraw', 'whereToPut', 'tips'].forEach(key => {
      if (hints[key]) {
        totalItems += hints[key].length;
        // ìˆ˜ì •ëœ í•­ëª© ìˆ˜
        hints[key].forEach((_, idx) => {
          if (editedItems[`${key}_${idx}`]) {
            customizedItems++;
          }
        });
      }
    });

    // ì‚¬ìš©ì ì•„ì´ë””ì–´
    const userIdeasCount = userAdditions.length;
    customizedItems += userIdeasCount;

    // ì™„ì„±ë„ ê³„ì‚° (ì‚¬ìš©ìí™” ë¹„ìœ¨ + ì•„ì´ë””ì–´ ì¶”ê°€ ë³´ë„ˆìŠ¤)
    const editRatio = totalItems > 0 ? (customizedItems / totalItems) * 100 : 0;
    const hasUserIdeas = userIdeasCount > 0;

    let level = 'beginner';
    let message = 'ì•„ì§ ì‹œì‘ ë‹¨ê³„ì˜ˆìš”!';
    let emoji = 'ğŸŒ±';

    if (editRatio >= 50 || userIdeasCount >= 3) {
      level = 'master';
      message = 'ë‚˜ë§Œì˜ ê°€ì´ë“œ ì™„ì„±! ğŸ‰';
      emoji = 'ğŸ†';
    } else if (editRatio >= 25 || userIdeasCount >= 1) {
      level = 'intermediate';
      message = 'ì¢‹ì•„ìš”! ê³„ì† ë°œì „ ì¤‘!';
      emoji = 'â­';
    }

    return {
      totalItems,
      customizedItems,
      userIdeasCount,
      percentage: Math.min(100, Math.round(editRatio + (userIdeasCount * 10))),
      level,
      message,
      emoji
    };
  }

  /**
   * í¸ì§‘ ê°€ëŠ¥í•œ íŒíŠ¸ ì½˜í…ì¸  ë Œë”ë§
   */
  function renderEditableHintContent(hints, userAdditions, editedItems, completionInfo) {
    const completion = completionInfo || calculateGuideCompletion(hints, userAdditions, editedItems);

    return `
      <div class="hint-modal-content editable-hints">
        <!-- ì™„ì„±ë„ í‘œì‹œ (P2) -->
        <div class="guide-completion-bar" id="guide-completion">
          <div class="completion-header">
            <span class="completion-emoji">${completion.emoji}</span>
            <span class="completion-message">${completion.message}</span>
            <span class="completion-percentage">${completion.percentage}%</span>
          </div>
          <div class="completion-progress">
            <div class="completion-fill" style="width: ${completion.percentage}%;"></div>
          </div>
          <div class="completion-stats">
            <span>âœï¸ ìˆ˜ì •: ${completion.customizedItems}ê°œ</span>
            <span>ğŸ’­ ë‚´ ì•„ì´ë””ì–´: ${completion.userIdeasCount}ê°œ</span>
          </div>
        </div>

        <!-- ë˜ë¦¬ ì‘ì› ë©”ì‹œì§€ -->
        <div class="ttori-encouragement" id="ttori-encouragement">
          <div class="ttori-avatar">ğŸ¿ï¸</div>
          <div class="ttori-message">
            í´ë¦­í•´ì„œ íŒíŠ¸ë¥¼ ìˆ˜ì •í•˜ê±°ë‚˜, ë‚˜ë§Œì˜ ì•„ì´ë””ì–´ë¥¼ ì¶”ê°€í•´ë³´ì„¸ìš”!
          </div>
        </div>

        ${renderEditableSection('whatToDraw', 'ğŸ¨ ë¬´ì—‡ì„ ê·¸ë¦´ê¹Œ?', hints.whatToDraw || [], editedItems)}
        ${renderEditableSection('whereToPut', 'ğŸ“ ì–´ë””ì— ë°°ì¹˜í• ê¹Œ?', hints.whereToPut || [], editedItems)}
        ${renderEditableSection('tips', 'âœ¨ ë¶„ìœ„ê¸° í‘œí˜„ íŒ', hints.tips || [], editedItems)}

        <!-- ë‚˜ë§Œì˜ ì•„ì´ë””ì–´ ì„¹ì…˜ -->
        <div class="hint-section user-ideas-section">
          <h4>ğŸ’­ ë‚˜ë§Œì˜ ì•„ì´ë””ì–´</h4>
          <div class="user-ideas-list" id="user-ideas-list"
               ondragover="handleUserIdeaDragOver(event)" ondrop="handleUserIdeaDrop(event)">
            ${userAdditions.length > 0 ?
              userAdditions.map((item, idx) => `
                <div class="editable-hint-item user-added" data-idx="${idx}"
                     draggable="true"
                     ondragstart="handleUserIdeaDragStart(event, ${idx})"
                     ondragend="handleUserIdeaDragEnd(event)">
                  <span class="drag-handle" title="ë“œë˜ê·¸í•˜ì—¬ ìˆœì„œ ë³€ê²½">â‹®â‹®</span>
                  <span class="hint-badge user-badge">ë‚´ ì•„ì´ë””ì–´</span>
                  <span class="hint-text" onclick="editUserIdea(${idx})">${escapeHtml(item)}</span>
                  <button class="hint-delete-btn" onclick="deleteUserIdea(${idx})" title="ì‚­ì œ">Ã—</button>
                </div>
              `).join('') :
              '<p class="empty-ideas">ì•„ì§ ì¶”ê°€ëœ ì•„ì´ë””ì–´ê°€ ì—†ì–´ìš”</p>'
            }
          </div>
          <div class="add-idea-form">
            <input type="text" id="new-idea-input" placeholder="ë‚˜ë§Œì˜ ì•„ì´ë””ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."
                   onkeypress="if(event.key==='Enter') addUserIdea()" maxlength="200">
            <button class="btn btn-sm btn-secondary" onclick="addUserIdea()">+ ì¶”ê°€</button>
          </div>
        </div>
      </div>

      <style>
        .editable-hints .hint-section {
          margin-bottom: 16px;
        }

        .ttori-encouragement {
          display: flex;
          align-items: center;
          gap: 12px;
          padding: 12px 16px;
          background: linear-gradient(135deg, #fef3c7 0%, #fef9c3 100%);
          border-radius: 12px;
          margin-bottom: 16px;
          border: 2px solid #f59e0b;
        }

        .ttori-avatar {
          font-size: 2rem;
          animation: bounce 1s infinite;
        }

        @keyframes bounce {
          0%, 100% { transform: translateY(0); }
          50% { transform: translateY(-5px); }
        }

        .ttori-message {
          font-size: 0.9rem;
          color: #92400e;
          font-weight: 500;
        }

        .editable-hint-item {
          display: flex;
          align-items: center;
          gap: 8px;
          padding: 10px 12px;
          background: white;
          border-radius: 8px;
          margin-bottom: 8px;
          border: 2px solid var(--border);
          transition: all 0.2s;
        }

        .editable-hint-item:hover {
          border-color: var(--primary);
          box-shadow: 0 2px 8px rgba(99, 102, 241, 0.15);
        }

        .editable-hint-item.editing {
          border-color: var(--primary);
          background: var(--primary-light);
        }

        .editable-hint-item.user-added {
          border-color: #10b981;
          background: #ecfdf5;
        }

        .editable-hint-item.was-edited {
          border-color: #f59e0b;
        }

        .hint-badge {
          font-size: 0.65rem;
          padding: 2px 6px;
          border-radius: 4px;
          font-weight: 600;
          flex-shrink: 0;
        }

        .hint-badge.ai-badge {
          background: #e0e7ff;
          color: #4338ca;
        }

        .hint-badge.edited-badge {
          background: #fef3c7;
          color: #b45309;
        }

        .hint-badge.user-badge {
          background: #d1fae5;
          color: #047857;
        }

        .hint-text {
          flex: 1;
          cursor: pointer;
          padding: 4px;
          border-radius: 4px;
          line-height: 1.4;
        }

        .hint-text:hover {
          background: rgba(99, 102, 241, 0.1);
        }

        .hint-edit-input {
          flex: 1;
          padding: 6px 10px;
          border: 2px solid var(--primary);
          border-radius: 6px;
          font-size: 0.9rem;
          outline: none;
        }

        .hint-delete-btn {
          width: 24px;
          height: 24px;
          border-radius: 50%;
          border: none;
          background: #fee2e2;
          color: #dc2626;
          cursor: pointer;
          font-size: 1rem;
          display: flex;
          align-items: center;
          justify-content: center;
          opacity: 0;
          transition: opacity 0.2s;
        }

        .editable-hint-item:hover .hint-delete-btn {
          opacity: 1;
        }

        .hint-delete-btn:hover {
          background: #dc2626;
          color: white;
        }

        .user-ideas-section {
          background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
          border: 2px solid #10b981;
        }

        .user-ideas-section h4 {
          color: #047857;
        }

        .empty-ideas {
          color: var(--text-muted);
          font-style: italic;
          text-align: center;
          padding: 12px;
        }

        .add-idea-form {
          display: flex;
          gap: 8px;
          margin-top: 12px;
        }

        .add-idea-form input {
          flex: 1;
          padding: 10px 14px;
          border: 2px solid var(--border);
          border-radius: 8px;
          font-size: 0.9rem;
          outline: none;
          transition: border-color 0.2s;
        }

        .add-idea-form input:focus {
          border-color: #10b981;
        }

        .hint-item-actions {
          display: flex;
          gap: 4px;
        }

        .hint-save-btn, .hint-cancel-btn {
          padding: 4px 10px;
          border-radius: 4px;
          border: none;
          cursor: pointer;
          font-size: 0.8rem;
        }

        .hint-save-btn {
          background: var(--primary);
          color: white;
        }

        .hint-cancel-btn {
          background: var(--border);
          color: var(--text);
        }

        /* P2: ì™„ì„±ë„ í‘œì‹œ */
        .guide-completion-bar {
          background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
          border: 2px solid #0ea5e9;
          border-radius: 12px;
          padding: 12px 16px;
          margin-bottom: 16px;
        }

        .completion-header {
          display: flex;
          align-items: center;
          gap: 8px;
          margin-bottom: 8px;
        }

        .completion-emoji {
          font-size: 1.5rem;
        }

        .completion-message {
          flex: 1;
          font-weight: 600;
          color: #0369a1;
        }

        .completion-percentage {
          font-size: 1.2rem;
          font-weight: 700;
          color: #0ea5e9;
        }

        .completion-progress {
          height: 8px;
          background: #e0e7ff;
          border-radius: 4px;
          overflow: hidden;
          margin-bottom: 8px;
        }

        .completion-fill {
          height: 100%;
          background: linear-gradient(90deg, #0ea5e9, #06b6d4);
          border-radius: 4px;
          transition: width 0.5s ease;
        }

        .completion-stats {
          display: flex;
          gap: 16px;
          font-size: 0.8rem;
          color: #64748b;
        }

        /* P1: ë“œë˜ê·¸ ì •ë ¬ */
        .editable-hint-item {
          cursor: grab;
        }

        .editable-hint-item:active {
          cursor: grabbing;
        }

        .editable-hint-item.dragging {
          opacity: 0.5;
          background: var(--primary-light);
        }

        .editable-hint-item.drag-over {
          border-top: 3px solid var(--primary);
        }

        .drag-handle {
          cursor: grab;
          color: var(--text-muted);
          margin-right: 4px;
        }

        .drag-handle:active {
          cursor: grabbing;
        }
      </style>
    `;
  }

  /**
   * í¸ì§‘ ê°€ëŠ¥í•œ ì„¹ì…˜ ë Œë”ë§
   */
  function renderEditableSection(sectionKey, title, items, editedItems) {
    return `
      <div class="hint-section" data-section="${sectionKey}">
        <h4>${title}</h4>
        <div class="hint-items-list" data-section="${sectionKey}"
             ondragover="handleDragOver(event)" ondrop="handleDrop(event, '${sectionKey}')">
          ${items.map((item, idx) => {
            const itemKey = `${sectionKey}_${idx}`;
            const isEdited = editedItems[itemKey];
            const displayText = isEdited ? editedItems[itemKey] : item;

            return `
              <div class="editable-hint-item ${isEdited ? 'was-edited' : ''}"
                   data-section="${sectionKey}" data-idx="${idx}"
                   draggable="true"
                   ondragstart="handleDragStart(event, '${sectionKey}', ${idx})"
                   ondragend="handleDragEnd(event)">
                <span class="drag-handle" title="ë“œë˜ê·¸í•˜ì—¬ ìˆœì„œ ë³€ê²½">â‹®â‹®</span>
                <span class="hint-badge ${isEdited ? 'edited-badge' : 'ai-badge'}">${isEdited ? 'ìˆ˜ì •ë¨' : 'AI'}</span>
                <span class="hint-text" onclick="startEditHintItem('${sectionKey}', ${idx})">${escapeHtml(displayText)}</span>
                <button class="hint-delete-btn" onclick="deleteHintItem('${sectionKey}', ${idx})" title="ì‚­ì œ">Ã—</button>
              </div>
            `;
          }).join('')}
        </div>
      </div>
    `;
  }

  /**
   * íŒíŠ¸ í•­ëª© í¸ì§‘ ì‹œì‘
   */
  function startEditHintItem(sectionKey, idx) {
    const itemKey = `${sectionKey}_${idx}`;
    const originalText = window.currentEditingHints[sectionKey][idx];
    const currentText = window.currentEditedItems[itemKey] || originalText;

    const itemEl = document.querySelector(`.editable-hint-item[data-section="${sectionKey}"][data-idx="${idx}"]`);
    if (!itemEl) return;

    itemEl.classList.add('editing');
    itemEl.innerHTML = `
      <span class="hint-badge edited-badge">í¸ì§‘ ì¤‘</span>
      <input type="text" class="hint-edit-input" value="${escapeHtml(currentText)}"
             onkeypress="if(event.key==='Enter') saveHintItemEdit('${sectionKey}', ${idx})"
             onkeydown="if(event.key==='Escape') cancelHintItemEdit('${sectionKey}', ${idx})">
      <div class="hint-item-actions">
        <button class="hint-save-btn" onclick="saveHintItemEdit('${sectionKey}', ${idx})">ì €ì¥</button>
        <button class="hint-cancel-btn" onclick="cancelHintItemEdit('${sectionKey}', ${idx})">ì·¨ì†Œ</button>
      </div>
    `;

    // ì…ë ¥ í•„ë“œì— í¬ì»¤ìŠ¤
    const input = itemEl.querySelector('.hint-edit-input');
    if (input) {
      input.focus();
      input.select();
    }

    // ë˜ë¦¬ ì‘ì› ë©”ì‹œì§€ ì—…ë°ì´íŠ¸
    updateTtoriMessage('ì¢‹ì•„ìš”! ìì‹ ë§Œì˜ ë°©ì‹ìœ¼ë¡œ ë°”ê¿”ë³´ì„¸ìš”! âœ¨');
  }

  /**
   * íŒíŠ¸ í•­ëª© í¸ì§‘ ì €ì¥
   */
  function saveHintItemEdit(sectionKey, idx) {
    const itemEl = document.querySelector(`.editable-hint-item[data-section="${sectionKey}"][data-idx="${idx}"]`);
    if (!itemEl) return;

    const input = itemEl.querySelector('.hint-edit-input');
    const rawText = input?.value?.trim();

    if (!rawText) {
      showToast('ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!', 'warning');
      return;
    }

    // XSS ë°©ì§€ë¥¼ ìœ„í•œ sanitize
    const newText = sanitizeInput(rawText);

    if (!newText) {
      showToast('ìœ íš¨í•œ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!', 'warning');
      return;
    }

    const itemKey = `${sectionKey}_${idx}`;
    window.currentEditedItems[itemKey] = newText;

    // UI ì—…ë°ì´íŠ¸
    itemEl.classList.remove('editing');
    itemEl.classList.add('was-edited');
    itemEl.innerHTML = `
      <span class="drag-handle" title="ë“œë˜ê·¸í•˜ì—¬ ìˆœì„œ ë³€ê²½">â‹®â‹®</span>
      <span class="hint-badge edited-badge">ìˆ˜ì •ë¨</span>
      <span class="hint-text" onclick="startEditHintItem('${sectionKey}', ${idx})">${escapeHtml(newText)}</span>
      <button class="hint-delete-btn" onclick="deleteHintItem('${sectionKey}', ${idx})" title="ì‚­ì œ">Ã—</button>
    `;

    // ì™„ì„±ë„ ì—…ë°ì´íŠ¸
    updateCompletionUI();

    // ë˜ë¦¬ ì‘ì› ë©”ì‹œì§€
    updateTtoriMessage('ë©‹ì ¸ìš”! ë‚˜ë§Œì˜ ì•„ì´ë””ì–´ë¡œ ë°”ê¿¨ë„¤ìš”! ğŸ¨');
  }

  /**
   * íŒíŠ¸ í•­ëª© í¸ì§‘ ì·¨ì†Œ
   */
  function cancelHintItemEdit(sectionKey, idx) {
    const itemKey = `${sectionKey}_${idx}`;
    const originalText = window.currentEditingHints[sectionKey][idx];
    const currentText = window.currentEditedItems[itemKey] || originalText;
    const isEdited = !!window.currentEditedItems[itemKey];

    const itemEl = document.querySelector(`.editable-hint-item[data-section="${sectionKey}"][data-idx="${idx}"]`);
    if (!itemEl) return;

    itemEl.classList.remove('editing');
    if (isEdited) itemEl.classList.add('was-edited');

    itemEl.innerHTML = `
      <span class="drag-handle" title="ë“œë˜ê·¸í•˜ì—¬ ìˆœì„œ ë³€ê²½">â‹®â‹®</span>
      <span class="hint-badge ${isEdited ? 'edited-badge' : 'ai-badge'}">${isEdited ? 'ìˆ˜ì •ë¨' : 'AI'}</span>
      <span class="hint-text" onclick="startEditHintItem('${sectionKey}', ${idx})">${escapeHtml(currentText)}</span>
      <button class="hint-delete-btn" onclick="deleteHintItem('${sectionKey}', ${idx})" title="ì‚­ì œ">Ã—</button>
    `;
  }

  /**
   * íŒíŠ¸ í•­ëª© ì‚­ì œ
   */
  function deleteHintItem(sectionKey, idx) {
    const itemKey = `${sectionKey}_${idx}`;

    // ë°°ì—´ì—ì„œ ì œê±°
    window.currentEditingHints[sectionKey].splice(idx, 1);

    // editedItems ì¬ì •ë ¬
    const newEditedItems = {};
    Object.keys(window.currentEditedItems).forEach(key => {
      if (key.startsWith(sectionKey + '_')) {
        const keyIdx = parseInt(key.split('_')[1]);
        if (keyIdx < idx) {
          newEditedItems[key] = window.currentEditedItems[key];
        } else if (keyIdx > idx) {
          newEditedItems[`${sectionKey}_${keyIdx - 1}`] = window.currentEditedItems[key];
        }
        // idxì™€ ê°™ì€ ê²½ìš°ëŠ” ì‚­ì œë˜ë¯€ë¡œ ë¬´ì‹œ
      } else {
        newEditedItems[key] = window.currentEditedItems[key];
      }
    });
    window.currentEditedItems = newEditedItems;

    // ì„¹ì…˜ UI ë‹¤ì‹œ ë Œë”ë§
    refreshHintSection(sectionKey);
    updateCompletionUI();
    updateTtoriMessage('íŒíŠ¸ê°€ ì‚­ì œë˜ì—ˆì–´ìš”!');
  }

  /**
   * íŒíŠ¸ ì„¹ì…˜ ìƒˆë¡œê³ ì¹¨
   */
  function refreshHintSection(sectionKey) {
    const sectionEl = document.querySelector(`.hint-section[data-section="${sectionKey}"]`);
    if (!sectionEl) return;

    const titleMap = {
      'whatToDraw': 'ğŸ¨ ë¬´ì—‡ì„ ê·¸ë¦´ê¹Œ?',
      'whereToPut': 'ğŸ“ ì–´ë””ì— ë°°ì¹˜í• ê¹Œ?',
      'tips': 'âœ¨ ë¶„ìœ„ê¸° í‘œí˜„ íŒ'
    };

    sectionEl.outerHTML = renderEditableSection(
      sectionKey,
      titleMap[sectionKey],
      window.currentEditingHints[sectionKey],
      window.currentEditedItems
    );
  }

  /**
   * ì…ë ¥ê°’ sanitize (XSS ë°©ì§€)
   */
  function sanitizeInput(text) {
    if (!text) return '';
    // HTML íƒœê·¸ ì œê±° ë° íŠ¹ìˆ˜ë¬¸ì ì´ìŠ¤ì¼€ì´í”„
    return text
      .replace(/<[^>]*>/g, '') // HTML íƒœê·¸ ì œê±°
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#039;')
      .trim()
      .substring(0, 200); // ìµœëŒ€ ê¸¸ì´ ì œí•œ
  }

  /**
   * ë‚˜ë§Œì˜ ì•„ì´ë””ì–´ ì¶”ê°€
   */
  function addUserIdea() {
    const input = document.getElementById('new-idea-input');
    const rawInput = input?.value?.trim();

    if (!rawInput) {
      showToast('ì•„ì´ë””ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!', 'warning');
      return;
    }

    // XSS ë°©ì§€ë¥¼ ìœ„í•œ sanitize
    const newIdea = sanitizeInput(rawInput);

    if (!newIdea) {
      showToast('ìœ íš¨í•œ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!', 'warning');
      return;
    }

    window.currentUserAdditions.push(newIdea);
    input.value = '';

    // UI ì—…ë°ì´íŠ¸
    refreshUserIdeasList();
    updateCompletionUI();
    updateTtoriMessage('ì™€! ë©‹ì§„ ì•„ì´ë””ì–´ë„¤ìš”! ğŸŒŸ');
  }

  /**
   * ë‚˜ë§Œì˜ ì•„ì´ë””ì–´ í¸ì§‘
   */
  function editUserIdea(idx) {
    const currentText = window.currentUserAdditions[idx];
    const listEl = document.getElementById('user-ideas-list');
    const itemEl = listEl.querySelector(`.editable-hint-item[data-idx="${idx}"]`);

    if (!itemEl) return;

    itemEl.classList.add('editing');
    itemEl.innerHTML = `
      <span class="hint-badge user-badge">í¸ì§‘ ì¤‘</span>
      <input type="text" class="hint-edit-input" value="${escapeHtml(currentText)}"
             onkeypress="if(event.key==='Enter') saveUserIdeaEdit(${idx})"
             onkeydown="if(event.key==='Escape') refreshUserIdeasList()">
      <div class="hint-item-actions">
        <button class="hint-save-btn" onclick="saveUserIdeaEdit(${idx})">ì €ì¥</button>
        <button class="hint-cancel-btn" onclick="refreshUserIdeasList()">ì·¨ì†Œ</button>
      </div>
    `;

    const input = itemEl.querySelector('.hint-edit-input');
    if (input) {
      input.focus();
      input.select();
    }
  }

  /**
   * ë‚˜ë§Œì˜ ì•„ì´ë””ì–´ í¸ì§‘ ì €ì¥
   */
  function saveUserIdeaEdit(idx) {
    const listEl = document.getElementById('user-ideas-list');
    const input = listEl.querySelector(`.editable-hint-item[data-idx="${idx}"] .hint-edit-input`);
    const rawText = input?.value?.trim();

    if (!rawText) {
      showToast('ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!', 'warning');
      return;
    }

    // XSS ë°©ì§€ë¥¼ ìœ„í•œ sanitize
    const newText = sanitizeInput(rawText);

    if (!newText) {
      showToast('ìœ íš¨í•œ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!', 'warning');
      return;
    }

    window.currentUserAdditions[idx] = newText;
    refreshUserIdeasList();
    updateTtoriMessage('ì•„ì´ë””ì–´ê°€ ìˆ˜ì •ë˜ì—ˆì–´ìš”! âœï¸');
  }

  /**
   * ë‚˜ë§Œì˜ ì•„ì´ë””ì–´ ì‚­ì œ
   */
  function deleteUserIdea(idx) {
    window.currentUserAdditions.splice(idx, 1);
    refreshUserIdeasList();
    updateCompletionUI();
    updateTtoriMessage('ì•„ì´ë””ì–´ê°€ ì‚­ì œë˜ì—ˆì–´ìš”!');
  }

  /**
   * ë‚˜ë§Œì˜ ì•„ì´ë””ì–´ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
   */
  function refreshUserIdeasList() {
    const listEl = document.getElementById('user-ideas-list');
    if (!listEl) return;

    if (window.currentUserAdditions.length > 0) {
      listEl.innerHTML = window.currentUserAdditions.map((item, idx) => `
        <div class="editable-hint-item user-added" data-idx="${idx}"
             draggable="true"
             ondragstart="handleUserIdeaDragStart(event, ${idx})"
             ondragend="handleUserIdeaDragEnd(event)">
          <span class="drag-handle" title="ë“œë˜ê·¸í•˜ì—¬ ìˆœì„œ ë³€ê²½">â‹®â‹®</span>
          <span class="hint-badge user-badge">ë‚´ ì•„ì´ë””ì–´</span>
          <span class="hint-text" onclick="editUserIdea(${idx})">${escapeHtml(item)}</span>
          <button class="hint-delete-btn" onclick="deleteUserIdea(${idx})" title="ì‚­ì œ">Ã—</button>
        </div>
      `).join('');
    } else {
      listEl.innerHTML = '<p class="empty-ideas">ì•„ì§ ì¶”ê°€ëœ ì•„ì´ë””ì–´ê°€ ì—†ì–´ìš”</p>';
    }
  }

  // ============================================
  // ì‚¬ìš©ì ì•„ì´ë””ì–´ ë“œë˜ê·¸ ì •ë ¬
  // ============================================

  let draggedUserIdeaIdx = null;

  /**
   * ì‚¬ìš©ì ì•„ì´ë””ì–´ ë“œë˜ê·¸ ì‹œì‘
   */
  function handleUserIdeaDragStart(event, idx) {
    draggedUserIdeaIdx = idx;
    event.target.classList.add('dragging');
    event.dataTransfer.effectAllowed = 'move';
    event.dataTransfer.setData('text/plain', idx);
  }

  /**
   * ì‚¬ìš©ì ì•„ì´ë””ì–´ ë“œë˜ê·¸ ì¢…ë£Œ
   */
  function handleUserIdeaDragEnd(event) {
    event.target.classList.remove('dragging');
    document.querySelectorAll('.user-ideas-list .drag-over').forEach(el => el.classList.remove('drag-over'));
    draggedUserIdeaIdx = null;
  }

  /**
   * ì‚¬ìš©ì ì•„ì´ë””ì–´ ë“œë˜ê·¸ ì˜¤ë²„
   */
  function handleUserIdeaDragOver(event) {
    event.preventDefault();
    event.dataTransfer.dropEffect = 'move';

    const target = event.target.closest('.editable-hint-item.user-added');
    if (target && parseInt(target.dataset.idx) !== draggedUserIdeaIdx) {
      document.querySelectorAll('.user-ideas-list .drag-over').forEach(el => el.classList.remove('drag-over'));
      target.classList.add('drag-over');
    }
  }

  /**
   * ì‚¬ìš©ì ì•„ì´ë””ì–´ ë“œë¡­ ì²˜ë¦¬
   */
  function handleUserIdeaDrop(event) {
    event.preventDefault();

    const target = event.target.closest('.editable-hint-item.user-added');
    if (!target || draggedUserIdeaIdx === null) return;

    const targetIdx = parseInt(target.dataset.idx);
    if (targetIdx === draggedUserIdeaIdx) return;

    // ë°°ì—´ ìˆœì„œ ë³€ê²½
    const [movedItem] = window.currentUserAdditions.splice(draggedUserIdeaIdx, 1);
    window.currentUserAdditions.splice(targetIdx, 0, movedItem);

    // UI ìƒˆë¡œê³ ì¹¨
    refreshUserIdeasList();
    updateCompletionUI();
    updateTtoriMessage('ì•„ì´ë””ì–´ ìˆœì„œê°€ ë³€ê²½ë˜ì—ˆì–´ìš”! ğŸ“');
  }

  /**
   * ë˜ë¦¬ ì‘ì› ë©”ì‹œì§€ ì—…ë°ì´íŠ¸
   */
  function updateTtoriMessage(message) {
    const msgEl = document.querySelector('.ttori-message');
    if (msgEl) {
      msgEl.textContent = message;
      msgEl.style.animation = 'none';
      msgEl.offsetHeight; // ë¦¬í”Œë¡œìš°
      msgEl.style.animation = 'pulse 0.3s ease';
    }
  }

  /**
   * ì™„ì„±ë„ UI ì—…ë°ì´íŠ¸
   */
  function updateCompletionUI() {
    const completion = calculateGuideCompletion(
      window.currentEditingHints,
      window.currentUserAdditions,
      window.currentEditedItems
    );

    const completionEl = document.getElementById('guide-completion');
    if (completionEl) {
      completionEl.querySelector('.completion-emoji').textContent = completion.emoji;
      completionEl.querySelector('.completion-message').textContent = completion.message;
      completionEl.querySelector('.completion-percentage').textContent = `${completion.percentage}%`;
      completionEl.querySelector('.completion-fill').style.width = `${completion.percentage}%`;
      completionEl.querySelector('.completion-stats').innerHTML = `
        <span>âœï¸ ìˆ˜ì •: ${completion.customizedItems}ê°œ</span>
        <span>ğŸ’­ ë‚´ ì•„ì´ë””ì–´: ${completion.userIdeasCount}ê°œ</span>
      `;
    }
  }

  // ============================================
  // P1: AI íŒíŠ¸ ìƒˆë¡œê³ ì¹¨
  // ============================================

  /**
   * AI íŒíŠ¸ ìƒˆë¡œ ìš”ì²­
   */
  async function refreshAiHints(sceneId) {
    const scene = step3Data.scenes.find(s => s.id === sceneId);
    if (!scene) return;

    showConfirm('AIì—ê²Œ ìƒˆë¡œìš´ íŒíŠ¸ë¥¼ ìš”ì²­í• ê¹Œìš”? í˜„ì¬ ìˆ˜ì •í•œ ë‚´ìš©ì€ ìœ ì§€ë©ë‹ˆë‹¤.', async () => {
      showLoading('ìƒˆë¡œìš´ íŒíŠ¸ ìƒì„± ì¤‘...');

      try {
        const result = await callApi('getDrawingHint', {
          sceneDescription: scene.description,
          sceneDialogue: scene.dialogue,
          stageName: scene.stageName
        });

        hideLoading();

        if (result.success && result.hint) {
          // ìƒˆ íŒíŠ¸ë¥¼ ê¸°ì¡´ì— ë³‘í•© (ê¸°ì¡´ ìˆ˜ì • ë‚´ìš©ì€ ìœ ì§€)
          mergeNewHints(result.hint);
          updateTtoriMessage('ìƒˆë¡œìš´ íŒíŠ¸ê°€ ì¶”ê°€ë˜ì—ˆì–´ìš”! âœ¨');
          showToast('ìƒˆë¡œìš´ AI íŒíŠ¸ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
        } else {
          showToast('íŒíŠ¸ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
        }
      } catch (error) {
        hideLoading();
        console.error('íŒíŠ¸ ìƒˆë¡œê³ ì¹¨ ì‹¤íŒ¨:', error);
        showToast('íŒíŠ¸ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
      }
    });
  }

  /**
   * ìƒˆ íŒíŠ¸ ë³‘í•©
   */
  function mergeNewHints(newHints) {
    // ê° ì„¹ì…˜ì— ìƒˆ íŒíŠ¸ ì¶”ê°€
    ['whatToDraw', 'whereToPut', 'tips'].forEach(key => {
      if (newHints[key] && newHints[key].length > 0) {
        // ê¸°ì¡´ì— ì—†ëŠ” ìƒˆ íŒíŠ¸ë§Œ ì¶”ê°€
        const existing = window.currentEditingHints[key] || [];
        newHints[key].forEach(newItem => {
          if (!existing.includes(newItem)) {
            window.currentEditingHints[key].push(newItem);
          }
        });

        // ì„¹ì…˜ UI ìƒˆë¡œê³ ì¹¨
        refreshHintSection(key);
      }
    });

    updateCompletionUI();
  }

  // ============================================
  // P1: íŒíŠ¸ ì´ˆê¸°í™” (ì›ë³¸ ë³µì›)
  // ============================================

  /**
   * ê°€ì´ë“œë¥¼ ì›ë˜ AI íŒíŠ¸ë¡œ ì´ˆê¸°í™”
   */
  function resetGuideToOriginal() {
    showConfirm('ëª¨ë“  ìˆ˜ì • ë‚´ìš©ì„ ì´ˆê¸°í™”í•˜ê³  ì›ë˜ AI íŒíŠ¸ë¡œ ë˜ëŒë¦´ê¹Œìš”?', () => {
      // ì›ë³¸ íŒíŠ¸ë¡œ ë³µì›
      window.currentEditingHints = JSON.parse(JSON.stringify(window.originalHints));
      window.currentUserAdditions = [];
      window.currentEditedItems = {};

      // ëª¨ë“  ì„¹ì…˜ UI ìƒˆë¡œê³ ì¹¨
      ['whatToDraw', 'whereToPut', 'tips'].forEach(key => {
        refreshHintSection(key);
      });
      refreshUserIdeasList();
      updateCompletionUI();

      updateTtoriMessage('ì›ë˜ íŒíŠ¸ë¡œ ëŒì•„ì™”ì–´ìš”! ë‹¤ì‹œ ì‹œì‘í•´ë³¼ê¹Œìš”? ğŸ”„');
      showToast('ê°€ì´ë“œê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
    });
  }

  // ============================================
  // P1: ë“œë˜ê·¸ ì •ë ¬
  // ============================================

  let draggedItem = null;
  let draggedSection = null;
  let draggedIdx = null;

  /**
   * ë“œë˜ê·¸ ì‹œì‘
   */
  function handleDragStart(event, sectionKey, idx) {
    draggedItem = event.target;
    draggedSection = sectionKey;
    draggedIdx = idx;
    event.target.classList.add('dragging');
    event.dataTransfer.effectAllowed = 'move';
    event.dataTransfer.setData('text/plain', idx);
  }

  /**
   * ë“œë˜ê·¸ ì¢…ë£Œ
   */
  function handleDragEnd(event) {
    event.target.classList.remove('dragging');
    document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
    draggedItem = null;
    draggedSection = null;
    draggedIdx = null;
  }

  /**
   * ë“œë˜ê·¸ ì˜¤ë²„
   */
  function handleDragOver(event) {
    event.preventDefault();
    event.dataTransfer.dropEffect = 'move';

    const target = event.target.closest('.editable-hint-item');
    if (target && target !== draggedItem) {
      document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
      target.classList.add('drag-over');
    }
  }

  /**
   * ë“œë¡­ ì²˜ë¦¬
   */
  function handleDrop(event, sectionKey) {
    event.preventDefault();

    if (draggedSection !== sectionKey) {
      // ë‹¤ë¥¸ ì„¹ì…˜ìœ¼ë¡œëŠ” ì´ë™ ë¶ˆê°€
      showToast('ê°™ì€ ì„¹ì…˜ ë‚´ì—ì„œë§Œ ìˆœì„œë¥¼ ë³€ê²½í•  ìˆ˜ ìˆì–´ìš”.', 'warning');
      return;
    }

    const target = event.target.closest('.editable-hint-item');
    if (!target || target === draggedItem) return;

    const targetIdx = parseInt(target.dataset.idx);

    // ë°°ì—´ ìˆœì„œ ë³€ê²½
    const items = window.currentEditingHints[sectionKey];
    const [movedItem] = items.splice(draggedIdx, 1);
    items.splice(targetIdx, 0, movedItem);

    // editedItems ì¸ë±ìŠ¤ ì¬ì •ë ¬
    reindexEditedItems(sectionKey);

    // UI ìƒˆë¡œê³ ì¹¨
    refreshHintSection(sectionKey);
    updateTtoriMessage('ìˆœì„œê°€ ë³€ê²½ë˜ì—ˆì–´ìš”! ğŸ“');
  }

  /**
   * ìˆ˜ì •ëœ í•­ëª© ì¸ë±ìŠ¤ ì¬ì •ë ¬
   */
  function reindexEditedItems(sectionKey) {
    const items = window.currentEditingHints[sectionKey];
    const newEditedItems = {};

    // ê¸°ì¡´ editedItemsì—ì„œ í•´ë‹¹ ì„¹ì…˜ ì™¸ì˜ í•­ëª©ë“¤ ë³´ì¡´
    Object.keys(window.currentEditedItems).forEach(key => {
      if (!key.startsWith(sectionKey + '_')) {
        newEditedItems[key] = window.currentEditedItems[key];
      }
    });

    // ìƒˆ ì¸ë±ìŠ¤ë¡œ ì¬í• ë‹¹
    items.forEach((item, idx) => {
      // ì´ì „ì— ìˆ˜ì •ëœ í•­ëª©ì¸ì§€ í™•ì¸ (ì›ë³¸ê³¼ ë¹„êµ)
      const originalItems = window.originalHints[sectionKey] || [];
      const originalIdx = originalItems.indexOf(item);

      if (originalIdx === -1) {
        // ì›ë³¸ì— ì—†ëŠ” í•­ëª© = ìƒˆë¡œ ì¶”ê°€ëœ í•­ëª©ì´ê±°ë‚˜ ìˆ˜ì •ëœ í•­ëª©
        // ì´ì „ editedItemsì—ì„œ ê°’ ì°¾ê¸°
        for (const key of Object.keys(window.currentEditedItems)) {
          if (key.startsWith(sectionKey + '_') && window.currentEditedItems[key] === item) {
            newEditedItems[`${sectionKey}_${idx}`] = item;
            break;
          }
        }
      }
    });

    window.currentEditedItems = newEditedItems;
  }

  /**
   * ê·¸ë¦¼ ê°€ì´ë“œ ì €ì¥
   */
  function saveDrawingGuide(sceneId) {
    // step3Dataì— ì €ì¥
    step3Data.drawingGuides[sceneId] = {
      hints: window.currentEditingHints,
      userAdditions: window.currentUserAdditions,
      editedItems: window.currentEditedItems,
      savedAt: new Date().toISOString()
    };

    // localStorageì—ë„ ë°±ì—… ì €ì¥
    try {
      const storageKey = `drawingGuide_${step3Data.studentNumber}_${sceneId}`;
      localStorage.setItem(storageKey, JSON.stringify(step3Data.drawingGuides[sceneId]));
    } catch (e) {
      console.warn('localStorage ì €ì¥ ì‹¤íŒ¨:', e);
    }

    hideModal();

    // íŒíŠ¸ ë²„íŠ¼ ì—…ë°ì´íŠ¸ (ì €ì¥ë¨ í‘œì‹œ)
    refreshHintButton(sceneId);

    // ì¥ë©´ ì¸ë„¤ì¼ë„ ì—…ë°ì´íŠ¸
    document.getElementById('scene-thumbnails').innerHTML = renderSceneThumbnails();

    showToast('ê·¸ë¦¼ ê°€ì´ë“œê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ’¾', 'success');
  }

  /**
   * ê·¸ë¦¼ ê°€ì´ë“œ PDF ë‹¤ìš´ë¡œë“œ
   */
  async function downloadGuideAsPDF(sceneId) {
    const scene = step3Data.scenes.find(s => s.id === sceneId);
    if (!scene) return;

    showLoading('PDF ìƒì„± ì¤‘...');

    try {
      // í˜„ì¬ í¸ì§‘ ì¤‘ì¸ ë°ì´í„° ì‚¬ìš©
      const guideData = {
        sceneName: scene.stageName,
        sceneDescription: scene.description,
        hints: window.currentEditingHints,
        userAdditions: window.currentUserAdditions,
        editedItems: window.currentEditedItems,
        studentName: step3Data.studentName,
        title: step3Data.title
      };

      const result = await callApi('exportDrawingGuidePDF', guideData);

      hideLoading();

      if (result.success && result.pdfUrl) {
        window.open(result.pdfUrl, '_blank');
        showToast('ë‚˜ì˜ ê·¸ë¦¼ ê°€ì´ë“œ PDFê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ“„', 'success');
      } else {
        showToast(result.error || 'PDF ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
      }
    } catch (error) {
      hideLoading();
      console.error('PDF ìƒì„± ì˜¤ë¥˜:', error);
      showToast('PDF ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
    }
  }

  /**
   * ìŠ¤í† ë¦¬ë³´ë“œ ë¯¸ë¦¬ë³´ê¸°
   */
  function previewStoryboard() {
    const scenesHtml = step3Data.scenes.map((scene, index) => {
      const imageInfo = step3Data.sceneImages[scene.id];
      return `
        <div style="background: var(--bg); padding: 12px; border-radius: 8px; display: flex; gap: 12px; align-items: flex-start;">
          <div style="width: 120px; height: 100px; flex-shrink: 0; background: white; border-radius: 8px; overflow: hidden; display: flex; align-items: center; justify-content: center; border: 2px solid var(--border);">
            ${imageInfo?.imageData ?
              `<img src="${imageInfo.imageData}" style="max-width: 100%; max-height: 100%; object-fit: contain;">` :
              `<span style="color: var(--text-muted);">ğŸ–¼ï¸</span>`
            }
          </div>
          <div style="flex: 1;">
            <div style="font-weight: 600; margin-bottom: 4px;">
              ${index + 1}. ${escapeHtml(scene.stageName)}
            </div>
            <p style="font-size: 0.85rem; margin: 0; color: var(--text-light);">
              ${escapeHtml(scene.description) || '(ì„¤ëª… ì—†ìŒ)'}
            </p>
            ${scene.dialogue ? `
              <p style="font-size: 0.85rem; margin-top: 4px; font-style: italic; color: var(--primary);">
                "${escapeHtml(scene.dialogue)}"
              </p>
            ` : ''}
          </div>
        </div>
      `;
    }).join('');

    showModal({
      title: `ğŸ‘ï¸ ìŠ¤í† ë¦¬ë³´ë“œ ë¯¸ë¦¬ë³´ê¸°`,
      content: `
        <div style="margin-bottom: 16px; padding: 12px; background: var(--primary-light); border-radius: 8px;">
          <h3 style="margin: 0;">ğŸ“– ${escapeHtml(step3Data.title)}</h3>
          <p style="margin: 4px 0 0 0; color: var(--text-light);">${step3Data.scenes.length}ê°œ ì¥ë©´</p>
        </div>
        <div style="display: flex; flex-direction: column; gap: 8px; max-height: 400px; overflow-y: auto;">
          ${scenesHtml}
        </div>
      `,
      buttons: [{ text: 'ë‹«ê¸°', class: 'btn-primary' }]
    });
  }

  /**
   * PDF ë‚´ë³´ë‚´ê¸°
   */
  async function exportToPDF() {
    showLoading('PDF ìƒì„± ì¤‘...');

    try {
      const result = await callApi('exportStoryboardPDF', {
        studentName: step3Data.studentName,
        studentNumber: step3Data.studentNumber,
        title: step3Data.title,
        scenes: step3Data.scenes,
        sceneImages: step3Data.sceneImages
      });

      hideLoading();

      if (result.success && result.pdfUrl) {
        // PDF ë‹¤ìš´ë¡œë“œ ë§í¬ ì—´ê¸°
        window.open(result.pdfUrl, '_blank');
        showToast('PDFê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ“„', 'success');
      } else {
        showToast(result.error || 'PDF ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
      }
    } catch (error) {
      hideLoading();
      console.error('PDF ìƒì„± ì˜¤ë¥˜:', error);
      showToast('PDF ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
    }
  }

  /**
   * Step 3 ì €ì¥
   */
  async function saveStep3(isComplete = false) {
    if (isSavingStep3) return;

    const saveBtn = document.getElementById('btn-save-step3');
    const submitBtn = document.getElementById('btn-submit-step3');

    if (isComplete) {
      // ì™„ë£Œ ê²€ì¦: ëª¨ë“  ì¥ë©´ì— ì´ë¯¸ì§€ê°€ ìˆì–´ì•¼ í•¨
      const missingImages = step3Data.scenes.filter(
        scene => !step3Data.sceneImages[scene.id]?.imageData
      );

      if (missingImages.length > 0) {
        showToast(`${missingImages.length}ê°œ ì¥ë©´ì— ê·¸ë¦¼ì´ ì—†ìŠµë‹ˆë‹¤. ëª¨ë“  ì¥ë©´ì— ê·¸ë¦¼ì„ ì¶”ê°€í•´ì£¼ì„¸ìš”!`, 'warning');

        // ì²« ë²ˆì§¸ ëˆ„ë½ëœ ì¥ë©´ìœ¼ë¡œ ì´ë™
        const missingIndex = step3Data.scenes.findIndex(
          scene => !step3Data.sceneImages[scene.id]?.imageData
        );
        if (missingIndex !== -1) {
          selectScene(missingIndex);
        }
        return;
      }
    }

    isSavingStep3 = true;

    try {
      // ë²„íŠ¼ ìƒíƒœ ë³€ê²½
      if (isComplete) {
        if (submitBtn) {
          submitBtn.disabled = true;
          submitBtn.innerHTML = 'â³ ì œì¶œ ì¤‘...';
        }
      } else {
        if (saveBtn) {
          saveBtn.disabled = true;
          saveBtn.innerHTML = 'â³ ì €ì¥ ì¤‘...';
        }
      }

      const result = await callApi('saveWork', {
        studentName: step3Data.studentName,
        studentNumber: step3Data.studentNumber,
        step: 3,
        workData: {
          title: step3Data.title,
          scenes: step3Data.scenes,
          sceneImages: step3Data.sceneImages,
          drawingGuides: step3Data.drawingGuides,  // ê·¸ë¦¼ ê°€ì´ë“œ ì¶”ê°€
          totalScenes: step3Data.scenes.length,
          completedScenes: Object.keys(step3Data.sceneImages).filter(
            id => step3Data.sceneImages[id]?.imageData
          ).length,
          isComplete: isComplete,
          status: isComplete ? 'submitted' : 'draft'
        }
      });

      if (result.success) {
        if (isComplete) {
          if (submitBtn) {
            submitBtn.innerHTML = 'âœ… ì œì¶œ ì™„ë£Œ!';
            submitBtn.style.background = 'var(--success)';
          }
          showToast('ìŠ¤í† ë¦¬ë³´ë“œê°€ ì™„ì„±ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ‰', 'success');
          stopAutoSaveStep3();
          setTimeout(() => navigateTo('student-main'), 1500);
        } else {
          if (saveBtn) {
            saveBtn.innerHTML = 'âœ“ ì €ì¥ë¨!';
            saveBtn.style.color = 'var(--success)';
            saveBtn.style.borderColor = 'var(--success)';
            setTimeout(() => {
              saveBtn.innerHTML = 'ğŸ’¾ ì €ì¥í•˜ê¸°';
              saveBtn.style.color = '';
              saveBtn.style.borderColor = '';
              saveBtn.disabled = false;
            }, 2000);
          }
          showToast('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
        }
      } else {
        // ì‹¤íŒ¨ ì‹œ ë³µêµ¬
        if (saveBtn) {
          saveBtn.innerHTML = 'ğŸ’¾ ì €ì¥í•˜ê¸°';
          saveBtn.disabled = false;
        }
        if (submitBtn) {
          submitBtn.innerHTML = 'ğŸ“® ì œì¶œí•˜ê¸°';
          submitBtn.disabled = false;
          submitBtn.style.background = '';
        }
        showToast(result.error || 'ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
      }
    } catch (error) {
      console.error('ì €ì¥ ì˜¤ë¥˜:', error);
      if (saveBtn) {
        saveBtn.innerHTML = 'ğŸ’¾ ì €ì¥í•˜ê¸°';
        saveBtn.disabled = false;
      }
      if (submitBtn) {
        submitBtn.innerHTML = 'ğŸ“® ì œì¶œí•˜ê¸°';
        submitBtn.disabled = false;
        submitBtn.style.background = '';
      }
      showToast('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
    } finally {
      isSavingStep3 = false;
    }
  }

  /**
   * ìë™ ì €ì¥
   */
  let autoSaveStep3Interval = null;

  function startAutoSaveStep3() {
    stopAutoSaveStep3();
    autoSaveStep3Interval = setInterval(() => {
      saveStep3(false);
    }, STEP3_AUTO_SAVE_INTERVAL_MS);
  }

  function stopAutoSaveStep3() {
    if (autoSaveStep3Interval) {
      clearInterval(autoSaveStep3Interval);
      autoSaveStep3Interval = null;
    }
  }

  /**
   * ë‚˜ê°€ê¸° í™•ì¸
   */
  function confirmExitStep3() {
    showConfirm('ì €ì¥í•˜ì§€ ì•Šì€ ë‚´ìš©ì´ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë‚˜ê°€ì‹œê² ìŠµë‹ˆê¹Œ?', () => {
      stopAutoSaveStep3();
      navigateTo('student-main');
    });
  }
</script>
