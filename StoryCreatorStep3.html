<script>
  /* ============================================
     ìŠ¤í† ë¦¬ í¬ë¦¬ì—ì´í„° - STEP 3: ë‚´ ê·¸ë¦¼ìœ¼ë¡œ ì™„ì„±í•˜ê¸°
     - Step 2ì˜ ì¥ë©´ë“¤ì— ì´ë¯¸ì§€ë¥¼ ì¶”ê°€í•˜ì—¬ ìŠ¤í† ë¦¬ë³´ë“œ ì™„ì„±
     - AI ê·¸ë¦¼ íŒíŠ¸ ì œê³µ (ê¸°ì¡´ Gemini API í™œìš©)
     - ì´ë¯¸ì§€ ì—…ë¡œë“œ (ì¹´ë©”ë¼/ê°¤ëŸ¬ë¦¬)
     - ì´ë¯¸ì§€ í¬ë¡­/íšŒì „ ê¸°ëŠ¥
     - PDF ë‚´ë³´ë‚´ê¸°
     ============================================ */

  // ìƒìˆ˜ ì •ì˜
  const STEP3_AUTO_SAVE_INTERVAL_MS = 30000;
  const MAX_IMAGE_SIZE_MB = 5;
  const SUPPORTED_IMAGE_TYPES = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];

  let step3Data = {
    studentName: '',
    studentNumber: 0,
    title: '',
    scenes: [],        // Step 2ì—ì„œ ê°€ì ¸ì˜¨ ì¥ë©´ë“¤
    sceneImages: {}    // { sceneId: { imageData, uploadType, uploadedAt } }
  };

  // í˜„ì¬ ì„ íƒëœ ì¥ë©´
  let selectedSceneIndex = 0;

  // ì €ì¥ ì¤‘ í”Œë˜ê·¸
  let isSavingStep3 = false;

  // ì´ë¯¸ì§€ í¸ì§‘ ìƒíƒœ
  let imageEditState = {
    sceneId: null,
    originalImage: null,
    rotation: 0,
    cropData: null
  };

  async function renderStoryCreatorStep3(container, data) {
    step3Data.studentName = data?.studentName || AppState.currentUser?.name;
    step3Data.studentNumber = data?.studentNumber || AppState.currentUser?.number;

    // Step 2 ë°ì´í„° ë¡œë“œ
    try {
      showLoading('Step 2 ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...');
      const step2Result = await callApi('getWork', {
        studentName: step3Data.studentName,
        studentNumber: step3Data.studentNumber,
        step: 2
      });

      if (step2Result.success && step2Result.data) {
        step3Data.scenes = step2Result.data.workData?.scenes || [];
        step3Data.title = step2Result.data.workData?.title || '';
      } else {
        hideLoading();
        showToast('Step 2 ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € Step 2ë¥¼ ì™„ë£Œí•´ì£¼ì„¸ìš”.', 'error');
        navigateTo('student-main');
        return;
      }
    } catch (error) {
      console.error('Step 2 ë¡œë“œ ì‹¤íŒ¨:', error);
      hideLoading();
      showToast('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨', 'error');
      navigateTo('student-main');
      return;
    } finally {
      hideLoading();
    }

    // ê¸°ì¡´ Step 3 ë°ì´í„°ê°€ ìˆëŠ”ì§€ í™•ì¸
    if (data?.existingWork?.workData?.sceneImages) {
      step3Data.sceneImages = data.existingWork.workData.sceneImages;
    }

    renderStep3UI(container);
  }

  function renderStep3UI(container) {
    const completedCount = Object.keys(step3Data.sceneImages).filter(
      id => step3Data.sceneImages[id]?.imageData
    ).length;
    const totalCount = step3Data.scenes.length;
    const progressPercent = totalCount > 0 ? Math.round((completedCount / totalCount) * 100) : 0;

    container.innerHTML = `
      <div class="container fade-in">
        ${renderStudentHeader('STEP 3: ë‚´ ê·¸ë¦¼ìœ¼ë¡œ ì™„ì„±í•˜ê¸°')}

        <!-- ì•ˆë‚´ ì¹´ë“œ -->
        <div class="card mb-3" style="background: linear-gradient(135deg, #fef3c7 0%, #fef9c3 100%);">
          <div class="flex items-center gap-3">
            <span style="font-size: 2rem;">ğŸ¨</span>
            <div>
              <h3 style="margin: 0 0 4px 0;">ì§ì ‘ ê·¸ë¦° ê·¸ë¦¼ì´ë‚˜ ì‚¬ì§„ìœ¼ë¡œ ì´ì•¼ê¸°ë¥¼ ì™„ì„±í•´ë³´ì„¸ìš”!</h3>
              <p style="margin: 0; color: var(--text-light); font-size: 0.9rem;">
                ê° ì¥ë©´ì— ì–´ìš¸ë¦¬ëŠ” ê·¸ë¦¼ì„ ê·¸ë¦¬ê±°ë‚˜ ì‚¬ì§„ì„ ì°ì–´ì„œ ì¶”ê°€í•  ìˆ˜ ìˆì–´ìš”.
              </p>
            </div>
          </div>
        </div>

        <!-- ì§„í–‰ ìƒí™© -->
        <div class="card mb-3">
          <div class="flex justify-between items-center mb-2">
            <div>
              <h3 style="margin: 0;">ğŸ“– ${escapeHtml(step3Data.title)}</h3>
              <span class="badge" style="background: var(--primary-light); color: var(--primary); margin-top: 4px;">
                ${completedCount}/${totalCount} ì¥ë©´ ì™„ì„±
              </span>
            </div>
            <div class="flex gap-2">
              <button class="btn btn-outline" id="btn-save-step3" onclick="saveStep3(false)">
                ğŸ’¾ ì €ì¥í•˜ê¸°
              </button>
              <button class="btn btn-primary" id="btn-submit-step3" onclick="saveStep3(true)">
                ğŸ“® ì œì¶œí•˜ê¸°
              </button>
            </div>
          </div>

          <!-- ì§„í–‰ë¥  ë°” -->
          <div class="progress-bar-container">
            <div class="progress-bar-fill" style="width: ${progressPercent}%;"></div>
          </div>
          <p style="text-align: center; font-size: 0.85rem; color: var(--text-muted); margin-top: 4px;">
            ì™„ì„±ë„ ${progressPercent}%
          </p>
        </div>

        <!-- ì¥ë©´ ì¸ë„¤ì¼ ë„¤ë¹„ê²Œì´ì…˜ -->
        <div class="scene-thumbnails mb-3" id="scene-thumbnails">
          ${renderSceneThumbnails()}
        </div>

        <!-- ì„ íƒëœ ì¥ë©´ í¸ì§‘ ì˜ì—­ -->
        <div class="card" id="scene-editor">
          ${renderSceneEditor()}
        </div>

        <!-- í•˜ë‹¨ ë²„íŠ¼ -->
        <div class="flex justify-between mt-3">
          <button class="btn btn-ghost" onclick="confirmExitStep3()">
            â† ëŒì•„ê°€ê¸°
          </button>
          <div class="flex gap-2">
            <button class="btn btn-outline" onclick="previewStoryboard()">
              ğŸ‘ï¸ ë¯¸ë¦¬ë³´ê¸°
            </button>
            <button class="btn btn-secondary" onclick="exportToPDF()">
              ğŸ“„ PDF ì €ì¥
            </button>
          </div>
        </div>
      </div>

      <!-- ìˆ¨ê²¨ì§„ íŒŒì¼ ì…ë ¥ -->
      <input type="file" id="image-file-input" accept="image/*" style="display: none;" onchange="handleFileSelect(event)">
      <input type="file" id="camera-input" accept="image/*" capture="environment" style="display: none;" onchange="handleFileSelect(event)">

      <style>
        .progress-bar-container {
          height: 8px;
          background: var(--border);
          border-radius: 4px;
          overflow: hidden;
        }

        .progress-bar-fill {
          height: 100%;
          background: linear-gradient(90deg, var(--primary), var(--success));
          border-radius: 4px;
          transition: width 0.3s ease;
        }

        .scene-thumbnails {
          display: flex;
          gap: 12px;
          overflow-x: auto;
          padding: 8px 4px;
          -webkit-overflow-scrolling: touch;
        }

        .scene-thumb {
          flex-shrink: 0;
          width: 100px;
          cursor: pointer;
          transition: transform 0.2s;
        }

        .scene-thumb:hover {
          transform: translateY(-4px);
        }

        .scene-thumb.active {
          transform: translateY(-4px);
        }

        .scene-thumb-inner {
          width: 100px;
          height: 80px;
          border-radius: 8px;
          border: 3px solid var(--border);
          background: var(--bg);
          display: flex;
          align-items: center;
          justify-content: center;
          overflow: hidden;
          position: relative;
        }

        .scene-thumb.active .scene-thumb-inner {
          border-color: var(--primary);
          box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        .scene-thumb.completed .scene-thumb-inner {
          border-color: var(--success);
        }

        .scene-thumb-inner img {
          width: 100%;
          height: 100%;
          object-fit: cover;
        }

        .scene-thumb-placeholder {
          font-size: 1.5rem;
          color: var(--text-muted);
        }

        .scene-thumb-label {
          text-align: center;
          font-size: 0.75rem;
          margin-top: 4px;
          color: var(--text-light);
          white-space: nowrap;
          overflow: hidden;
          text-overflow: ellipsis;
        }

        .scene-thumb-number {
          position: absolute;
          top: 4px;
          left: 4px;
          width: 20px;
          height: 20px;
          background: var(--primary);
          color: white;
          border-radius: 50%;
          font-size: 0.7rem;
          display: flex;
          align-items: center;
          justify-content: center;
          font-weight: 700;
        }

        .scene-thumb.completed .scene-thumb-number {
          background: var(--success);
        }

        .scene-editor-content {
          display: grid;
          grid-template-columns: 1fr 1fr;
          gap: 24px;
        }

        @media (max-width: 768px) {
          .scene-editor-content {
            grid-template-columns: 1fr;
          }
        }

        .scene-image-area {
          background: var(--bg);
          border-radius: 12px;
          min-height: 300px;
          display: flex;
          flex-direction: column;
          align-items: center;
          justify-content: center;
          border: 3px dashed var(--border);
          position: relative;
          overflow: hidden;
        }

        .scene-image-area.has-image {
          border-style: solid;
          border-color: var(--success);
        }

        .scene-image-area img {
          max-width: 100%;
          max-height: 300px;
          object-fit: contain;
        }

        .image-upload-options {
          display: flex;
          gap: 12px;
          margin-top: 16px;
        }

        .upload-option-btn {
          display: flex;
          flex-direction: column;
          align-items: center;
          gap: 8px;
          padding: 16px 24px;
          background: white;
          border: 2px solid var(--border);
          border-radius: 12px;
          cursor: pointer;
          transition: all 0.2s;
        }

        .upload-option-btn:hover {
          border-color: var(--primary);
          background: var(--primary-light);
          transform: translateY(-2px);
        }

        .upload-option-btn .icon {
          font-size: 2rem;
        }

        .upload-option-btn .label {
          font-size: 0.9rem;
          font-weight: 500;
        }

        .scene-description-area {
          display: flex;
          flex-direction: column;
        }

        .scene-description-box {
          background: var(--bg);
          padding: 16px;
          border-radius: 8px;
          margin-bottom: 16px;
        }

        .scene-description-box h4 {
          margin: 0 0 8px 0;
          display: flex;
          align-items: center;
          gap: 8px;
        }

        .scene-description-box p {
          margin: 0;
          line-height: 1.6;
        }

        .scene-dialogue {
          font-style: italic;
          color: var(--primary);
          margin-top: 8px;
          padding-left: 12px;
          border-left: 3px solid var(--primary);
        }

        .hint-btn {
          display: flex;
          align-items: center;
          gap: 8px;
          padding: 12px 20px;
          background: linear-gradient(135deg, #fef3c7, #fef9c3);
          border: 2px solid #f59e0b;
          border-radius: 8px;
          cursor: pointer;
          transition: all 0.2s;
          margin-top: auto;
        }

        .hint-btn:hover {
          background: #fef3c7;
          transform: translateY(-2px);
          box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
        }

        .hint-btn:disabled {
          opacity: 0.5;
          cursor: not-allowed;
          transform: none;
        }

        .image-actions {
          position: absolute;
          bottom: 12px;
          right: 12px;
          display: flex;
          gap: 8px;
        }

        .image-action-btn {
          width: 36px;
          height: 36px;
          border-radius: 50%;
          background: white;
          border: 1px solid var(--border);
          cursor: pointer;
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 1rem;
          transition: all 0.2s;
          box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .image-action-btn:hover {
          background: var(--primary-light);
          border-color: var(--primary);
        }

        .image-action-btn.delete:hover {
          background: #fee2e2;
          border-color: var(--danger);
        }

        /* íŒíŠ¸ ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .hint-modal-content {
          max-height: 400px;
          overflow-y: auto;
        }

        .hint-section {
          background: var(--bg);
          padding: 16px;
          border-radius: 8px;
          margin-bottom: 12px;
        }

        .hint-section h4 {
          margin: 0 0 12px 0;
          display: flex;
          align-items: center;
          gap: 8px;
        }

        .hint-section ul {
          margin: 0;
          padding-left: 20px;
        }

        .hint-section li {
          margin-bottom: 8px;
          line-height: 1.5;
        }

        /* ì´ë¯¸ì§€ í¸ì§‘ ëª¨ë‹¬ */
        .image-edit-area {
          position: relative;
          background: #000;
          border-radius: 8px;
          overflow: hidden;
          display: flex;
          align-items: center;
          justify-content: center;
          min-height: 300px;
        }

        .image-edit-area img {
          max-width: 100%;
          max-height: 400px;
          transition: transform 0.3s;
        }

        .edit-controls {
          display: flex;
          justify-content: center;
          gap: 12px;
          margin-top: 16px;
        }

        .edit-control-btn {
          padding: 12px 20px;
          border-radius: 8px;
          border: 2px solid var(--border);
          background: white;
          cursor: pointer;
          display: flex;
          align-items: center;
          gap: 8px;
          transition: all 0.2s;
        }

        .edit-control-btn:hover {
          border-color: var(--primary);
          background: var(--primary-light);
        }
      </style>
    `;

    startAutoSaveStep3();
  }

  /**
   * ì¥ë©´ ì¸ë„¤ì¼ ë Œë”ë§
   */
  function renderSceneThumbnails() {
    return step3Data.scenes.map((scene, index) => {
      const imageData = step3Data.sceneImages[scene.id]?.imageData;
      const isActive = index === selectedSceneIndex;
      const isCompleted = !!imageData;

      return `
        <div class="scene-thumb ${isActive ? 'active' : ''} ${isCompleted ? 'completed' : ''}"
             onclick="selectScene(${index})">
          <div class="scene-thumb-inner">
            <span class="scene-thumb-number">${index + 1}</span>
            ${imageData ?
              `<img src="${imageData}" alt="ì¥ë©´ ${index + 1}">` :
              `<span class="scene-thumb-placeholder">+</span>`
            }
          </div>
          <div class="scene-thumb-label">${escapeHtml(scene.stageName || `ì¥ë©´ ${index + 1}`)}</div>
        </div>
      `;
    }).join('');
  }

  /**
   * ì¥ë©´ í¸ì§‘ê¸° ë Œë”ë§
   */
  function renderSceneEditor() {
    if (step3Data.scenes.length === 0) {
      return `
        <div class="empty-state">
          <div class="empty-state-icon">ğŸ“­</div>
          <h3>ì¥ë©´ì´ ì—†ìŠµë‹ˆë‹¤</h3>
          <p>Step 2ì—ì„œ ì¥ë©´ì„ ë¨¼ì € ë§Œë“¤ì–´ì£¼ì„¸ìš”.</p>
        </div>
      `;
    }

    const scene = step3Data.scenes[selectedSceneIndex];
    const imageInfo = step3Data.sceneImages[scene.id];
    const hasImage = !!imageInfo?.imageData;

    return `
      <div class="scene-editor-header mb-3">
        <div class="flex items-center gap-3">
          <div class="scene-number" style="width: 40px; height: 40px; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 1.2rem;">
            ${selectedSceneIndex + 1}
          </div>
          <div>
            <h3 style="margin: 0;">${escapeHtml(scene.stageName || `ì¥ë©´ ${selectedSceneIndex + 1}`)}</h3>
            <span class="badge ${scene.isOriginal ? '' : 'badge-active'}" style="${scene.isOriginal ? 'background: var(--primary-light); color: var(--primary);' : ''}">
              ${scene.isOriginal ? 'ê¸°ë³¸ ì¥ë©´' : 'ì¶”ê°€ ì¥ë©´'}
            </span>
          </div>
        </div>
      </div>

      <div class="scene-editor-content">
        <!-- ì´ë¯¸ì§€ ì˜ì—­ -->
        <div class="scene-image-area ${hasImage ? 'has-image' : ''}" id="image-area-${scene.id}">
          ${hasImage ? `
            <img src="${imageInfo.imageData}" alt="ì¥ë©´ ì´ë¯¸ì§€" id="scene-image-${scene.id}">
            <div class="image-actions">
              <button class="image-action-btn" onclick="editImage('${scene.id}')" title="í¸ì§‘">
                âœï¸
              </button>
              <button class="image-action-btn" onclick="changeImage('${scene.id}')" title="ë³€ê²½">
                ğŸ”„
              </button>
              <button class="image-action-btn delete" onclick="deleteImage('${scene.id}')" title="ì‚­ì œ">
                ğŸ—‘ï¸
              </button>
            </div>
          ` : `
            <div style="text-align: center; padding: 20px;">
              <p style="font-size: 3rem; margin-bottom: 8px;">ğŸ–¼ï¸</p>
              <p style="color: var(--text-muted); margin-bottom: 16px;">ê·¸ë¦¼ì„ ì¶”ê°€í•´ì£¼ì„¸ìš”</p>

              <div class="image-upload-options">
                <button class="upload-option-btn" onclick="captureFromCamera('${scene.id}')">
                  <span class="icon">ğŸ“·</span>
                  <span class="label">ì´¬ì˜í•˜ê¸°</span>
                </button>
                <button class="upload-option-btn" onclick="selectFromGallery('${scene.id}')">
                  <span class="icon">ğŸ“</span>
                  <span class="label">ê°€ì ¸ì˜¤ê¸°</span>
                </button>
              </div>
            </div>
          `}
        </div>

        <!-- ì„¤ëª… ì˜ì—­ -->
        <div class="scene-description-area">
          <div class="scene-description-box">
            <h4>ğŸ“ ë‚´ê°€ ì“´ ì´ì•¼ê¸°</h4>
            <p>${escapeHtml(scene.description) || '<span style="color: var(--text-muted);">(ì„¤ëª… ì—†ìŒ)</span>'}</p>
            ${scene.dialogue ? `
              <div class="scene-dialogue">"${escapeHtml(scene.dialogue)}"</div>
            ` : ''}
          </div>

          <button class="hint-btn" onclick="showDrawingHint('${scene.id}')" id="hint-btn-${scene.id}">
            <span style="font-size: 1.5rem;">ğŸ’¡</span>
            <div>
              <strong>ê·¸ë¦¼ íŒíŠ¸ ë³´ê¸°</strong>
              <p style="margin: 0; font-size: 0.85rem; color: var(--text-light);">ë˜ë¦¬ê°€ ê·¸ë¦¼ íŒì„ ì•Œë ¤ì¤˜ìš”!</p>
            </div>
          </button>

          <!-- ì¥ë©´ ë„¤ë¹„ê²Œì´ì…˜ -->
          <div class="flex justify-between mt-3">
            <button class="btn btn-ghost" onclick="navigateScene(-1)" ${selectedSceneIndex === 0 ? 'disabled' : ''}>
              â† ì´ì „ ì¥ë©´
            </button>
            <button class="btn btn-ghost" onclick="navigateScene(1)" ${selectedSceneIndex === step3Data.scenes.length - 1 ? 'disabled' : ''}>
              ë‹¤ìŒ ì¥ë©´ â†’
            </button>
          </div>
        </div>
      </div>
    `;
  }

  /**
   * ì¥ë©´ ì„ íƒ
   */
  function selectScene(index) {
    if (index < 0 || index >= step3Data.scenes.length) return;
    selectedSceneIndex = index;

    // ì¸ë„¤ì¼ê³¼ í¸ì§‘ê¸° ì—…ë°ì´íŠ¸
    document.getElementById('scene-thumbnails').innerHTML = renderSceneThumbnails();
    document.getElementById('scene-editor').innerHTML = renderSceneEditor();
  }

  /**
   * ì¥ë©´ ë„¤ë¹„ê²Œì´ì…˜
   */
  function navigateScene(direction) {
    const newIndex = selectedSceneIndex + direction;
    if (newIndex >= 0 && newIndex < step3Data.scenes.length) {
      selectScene(newIndex);
    }
  }

  // í˜„ì¬ ì´ë¯¸ì§€ ì—…ë¡œë“œ ëŒ€ìƒ ì¥ë©´ ID
  let currentUploadSceneId = null;

  /**
   * ì¹´ë©”ë¼ë¡œ ì´¬ì˜
   */
  function captureFromCamera(sceneId) {
    currentUploadSceneId = sceneId;
    document.getElementById('camera-input').click();
  }

  /**
   * ê°¤ëŸ¬ë¦¬ì—ì„œ ì„ íƒ
   */
  function selectFromGallery(sceneId) {
    currentUploadSceneId = sceneId;
    document.getElementById('image-file-input').click();
  }

  /**
   * ì´ë¯¸ì§€ ë³€ê²½
   */
  function changeImage(sceneId) {
    selectFromGallery(sceneId);
  }

  /**
   * íŒŒì¼ ì„ íƒ ì²˜ë¦¬
   */
  function handleFileSelect(event) {
    const file = event.target.files[0];
    if (!file) return;

    // íŒŒì¼ íƒ€ì… ê²€ì¦
    if (!SUPPORTED_IMAGE_TYPES.includes(file.type)) {
      showToast('ì§€ì›í•˜ì§€ ì•ŠëŠ” ì´ë¯¸ì§€ í˜•ì‹ì…ë‹ˆë‹¤. (JPG, PNG, GIF, WebPë§Œ ê°€ëŠ¥)', 'error');
      return;
    }

    // íŒŒì¼ í¬ê¸° ê²€ì¦
    if (file.size > MAX_IMAGE_SIZE_MB * 1024 * 1024) {
      showToast(`ì´ë¯¸ì§€ í¬ê¸°ê°€ ë„ˆë¬´ í½ë‹ˆë‹¤. (ìµœëŒ€ ${MAX_IMAGE_SIZE_MB}MB)`, 'error');
      return;
    }

    const reader = new FileReader();
    reader.onload = function(e) {
      // ì´ë¯¸ì§€ ë¦¬ì‚¬ì´ì¦ˆ ì²˜ë¦¬
      resizeImage(e.target.result, 1200, 1200, (resizedData) => {
        saveImageToScene(currentUploadSceneId, resizedData, 'gallery');
      });
    };
    reader.readAsDataURL(file);

    // ì…ë ¥ ì´ˆê¸°í™”
    event.target.value = '';
  }

  /**
   * ì´ë¯¸ì§€ ë¦¬ì‚¬ì´ì¦ˆ
   */
  function resizeImage(dataUrl, maxWidth, maxHeight, callback) {
    const img = new Image();
    img.onload = function() {
      let width = img.width;
      let height = img.height;

      // í¬ê¸° ì¡°ì • í•„ìš” ì—¬ë¶€ í™•ì¸
      if (width <= maxWidth && height <= maxHeight) {
        callback(dataUrl);
        return;
      }

      // ë¹„ìœ¨ ìœ ì§€í•˜ë©° í¬ê¸° ì¡°ì •
      if (width > height) {
        if (width > maxWidth) {
          height = Math.round(height * maxWidth / width);
          width = maxWidth;
        }
      } else {
        if (height > maxHeight) {
          width = Math.round(width * maxHeight / height);
          height = maxHeight;
        }
      }

      const canvas = document.createElement('canvas');
      canvas.width = width;
      canvas.height = height;

      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0, width, height);

      callback(canvas.toDataURL('image/jpeg', 0.85));
    };
    img.src = dataUrl;
  }

  /**
   * ì´ë¯¸ì§€ ì €ì¥
   */
  function saveImageToScene(sceneId, imageData, uploadType) {
    step3Data.sceneImages[sceneId] = {
      imageData: imageData,
      uploadType: uploadType,
      uploadedAt: new Date().toISOString()
    };

    // UI ì—…ë°ì´íŠ¸
    document.getElementById('scene-thumbnails').innerHTML = renderSceneThumbnails();
    document.getElementById('scene-editor').innerHTML = renderSceneEditor();
    updateProgressUI();

    showToast('ì´ë¯¸ì§€ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ¨', 'success');
  }

  /**
   * ì´ë¯¸ì§€ ì‚­ì œ
   */
  function deleteImage(sceneId) {
    showConfirm('ì´ ì´ë¯¸ì§€ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?', () => {
      delete step3Data.sceneImages[sceneId];

      document.getElementById('scene-thumbnails').innerHTML = renderSceneThumbnails();
      document.getElementById('scene-editor').innerHTML = renderSceneEditor();
      updateProgressUI();

      showToast('ì´ë¯¸ì§€ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
    });
  }

  /**
   * ì´ë¯¸ì§€ í¸ì§‘ (íšŒì „)
   */
  function editImage(sceneId) {
    const imageInfo = step3Data.sceneImages[sceneId];
    if (!imageInfo) return;

    imageEditState = {
      sceneId: sceneId,
      originalImage: imageInfo.imageData,
      rotation: 0
    };

    showModal({
      title: 'ğŸ–¼ï¸ ì´ë¯¸ì§€ í¸ì§‘',
      content: `
        <div class="image-edit-area">
          <img src="${imageInfo.imageData}" id="edit-preview-image" style="transform: rotate(0deg);">
        </div>
        <div class="edit-controls">
          <button class="edit-control-btn" onclick="rotateEditImage(-90)">
            â†º ì™¼ìª½ íšŒì „
          </button>
          <button class="edit-control-btn" onclick="rotateEditImage(90)">
            â†» ì˜¤ë¥¸ìª½ íšŒì „
          </button>
        </div>
      `,
      buttons: [
        { text: 'ì·¨ì†Œ', class: 'btn-ghost', action: () => hideModal() },
        { text: 'ì ìš©', class: 'btn-primary', action: () => applyImageEdit() }
      ]
    });
  }

  /**
   * ì´ë¯¸ì§€ íšŒì „
   */
  function rotateEditImage(degrees) {
    imageEditState.rotation = (imageEditState.rotation + degrees) % 360;
    const previewImg = document.getElementById('edit-preview-image');
    if (previewImg) {
      previewImg.style.transform = `rotate(${imageEditState.rotation}deg)`;
    }
  }

  /**
   * ì´ë¯¸ì§€ í¸ì§‘ ì ìš©
   */
  function applyImageEdit() {
    if (!imageEditState.sceneId || imageEditState.rotation === 0) {
      hideModal();
      return;
    }

    const img = new Image();
    img.onload = function() {
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');

      // 90ë„ ë˜ëŠ” 270ë„ íšŒì „ ì‹œ ìº”ë²„ìŠ¤ í¬ê¸° ë³€ê²½
      if (Math.abs(imageEditState.rotation) === 90 || Math.abs(imageEditState.rotation) === 270) {
        canvas.width = img.height;
        canvas.height = img.width;
      } else {
        canvas.width = img.width;
        canvas.height = img.height;
      }

      // ìº”ë²„ìŠ¤ ì¤‘ì‹¬ìœ¼ë¡œ ì´ë™ í›„ íšŒì „
      ctx.translate(canvas.width / 2, canvas.height / 2);
      ctx.rotate(imageEditState.rotation * Math.PI / 180);
      ctx.drawImage(img, -img.width / 2, -img.height / 2);

      const rotatedData = canvas.toDataURL('image/jpeg', 0.85);
      step3Data.sceneImages[imageEditState.sceneId].imageData = rotatedData;

      // UI ì—…ë°ì´íŠ¸
      document.getElementById('scene-thumbnails').innerHTML = renderSceneThumbnails();
      document.getElementById('scene-editor').innerHTML = renderSceneEditor();

      hideModal();
      showToast('ì´ë¯¸ì§€ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
    };
    img.src = imageEditState.originalImage;
  }

  /**
   * ì§„í–‰ë¥  UI ì—…ë°ì´íŠ¸
   */
  function updateProgressUI() {
    const completedCount = Object.keys(step3Data.sceneImages).filter(
      id => step3Data.sceneImages[id]?.imageData
    ).length;
    const totalCount = step3Data.scenes.length;
    const progressPercent = totalCount > 0 ? Math.round((completedCount / totalCount) * 100) : 0;

    // ë°°ì§€ ì—…ë°ì´íŠ¸
    const badge = document.querySelector('.card .badge');
    if (badge && badge.textContent.includes('ì¥ë©´ ì™„ì„±')) {
      badge.textContent = `${completedCount}/${totalCount} ì¥ë©´ ì™„ì„±`;
    }

    // ì§„í–‰ë¥  ë°” ì—…ë°ì´íŠ¸
    const progressFill = document.querySelector('.progress-bar-fill');
    if (progressFill) {
      progressFill.style.width = `${progressPercent}%`;
    }

    // í¼ì„¼íŠ¸ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
    const percentText = document.querySelector('.progress-bar-container + p');
    if (percentText) {
      percentText.textContent = `ì™„ì„±ë„ ${progressPercent}%`;
    }
  }

  /**
   * ê·¸ë¦¼ íŒíŠ¸ ë³´ê¸° (AI í™œìš©)
   */
  async function showDrawingHint(sceneId) {
    const scene = step3Data.scenes.find(s => s.id === sceneId);
    if (!scene) return;

    const hintBtn = document.getElementById(`hint-btn-${sceneId}`);
    if (hintBtn) {
      hintBtn.disabled = true;
      hintBtn.innerHTML = `
        <span style="font-size: 1.5rem;">â³</span>
        <div>
          <strong>íŒíŠ¸ ìƒì„± ì¤‘...</strong>
          <p style="margin: 0; font-size: 0.85rem; color: var(--text-light);">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”</p>
        </div>
      `;
    }

    try {
      // ë˜ë¦¬ AIì—ê²Œ ê·¸ë¦¼ íŒíŠ¸ ìš”ì²­
      const result = await callApi('getDrawingHint', {
        sceneDescription: scene.description,
        sceneDialogue: scene.dialogue,
        stageName: scene.stageName
      });

      if (result.success && result.hint) {
        showHintModal(scene, result.hint);
      } else {
        // AI ì‘ë‹µ ì‹¤íŒ¨ ì‹œ ê¸°ë³¸ íŒíŠ¸ ì œê³µ
        showHintModal(scene, generateDefaultHint(scene));
      }
    } catch (error) {
      console.error('íŒíŠ¸ ìƒì„± ì‹¤íŒ¨:', error);
      showHintModal(scene, generateDefaultHint(scene));
    } finally {
      if (hintBtn) {
        hintBtn.disabled = false;
        hintBtn.innerHTML = `
          <span style="font-size: 1.5rem;">ğŸ’¡</span>
          <div>
            <strong>ê·¸ë¦¼ íŒíŠ¸ ë³´ê¸°</strong>
            <p style="margin: 0; font-size: 0.85rem; color: var(--text-light);">ë˜ë¦¬ê°€ ê·¸ë¦¼ íŒì„ ì•Œë ¤ì¤˜ìš”!</p>
          </div>
        `;
      }
    }
  }

  /**
   * ê¸°ë³¸ íŒíŠ¸ ìƒì„± (AI ì‹¤íŒ¨ ì‹œ)
   */
  function generateDefaultHint(scene) {
    return {
      whatToDraw: [
        'ì¥ë©´ì— ë‚˜ì˜¤ëŠ” ì£¼ì¸ê³µì„ ê·¸ë ¤ë³´ì„¸ìš”',
        'ë°°ê²½(ì¥ì†Œ)ì„ ê°„ë‹¨íˆ í‘œí˜„í•´ë³´ì„¸ìš”',
        'ì¤‘ìš”í•œ ë¬¼ê±´ì´ë‚˜ ì†Œí’ˆì„ ì¶”ê°€í•´ë³´ì„¸ìš”'
      ],
      whereToPut: [
        'ì£¼ì¸ê³µì€ ê·¸ë¦¼ ì¤‘ì•™ì— í¬ê²Œ ê·¸ë ¤ë³´ì„¸ìš”',
        'ë°°ê²½ì€ ë’¤ìª½ì— ê°„ë‹¨íˆ ê·¸ë ¤ìš”',
        'ëŒ€ì‚¬ê°€ ìˆë‹¤ë©´ ë§í’ì„ ì„ ì¶”ê°€í•´ë³´ì„¸ìš”'
      ],
      tips: [
        'ìƒ‰ì—°í•„ì´ë‚˜ ì‚¬ì¸íœìœ¼ë¡œ ìƒ‰ì¹ í•˜ë©´ ë” ì˜ˆë»ìš”',
        'í‘œì •ì„ ë„£ìœ¼ë©´ ê°ì •ì´ ì˜ ì „ë‹¬ë¼ìš”',
        'ë°°ê²½ì— êµ¬ë¦„ì´ë‚˜ ë‚˜ë¬´ë¥¼ ê·¸ë ¤ë³´ì„¸ìš”'
      ]
    };
  }

  /**
   * íŒíŠ¸ ëª¨ë‹¬ í‘œì‹œ
   */
  function showHintModal(scene, hint) {
    showModal({
      title: `ğŸ’¡ ê·¸ë¦¼ íŒíŠ¸: ${escapeHtml(scene.stageName)}`,
      content: `
        <div class="hint-modal-content">
          <div class="hint-section">
            <h4>ğŸ¨ ë¬´ì—‡ì„ ê·¸ë¦´ê¹Œ?</h4>
            <ul>
              ${(hint.whatToDraw || []).map(item => `<li>${escapeHtml(item)}</li>`).join('')}
            </ul>
          </div>

          <div class="hint-section">
            <h4>ğŸ“ ì–´ë””ì— ë°°ì¹˜í• ê¹Œ?</h4>
            <ul>
              ${(hint.whereToPut || []).map(item => `<li>${escapeHtml(item)}</li>`).join('')}
            </ul>
          </div>

          <div class="hint-section">
            <h4>âœ¨ ë¶„ìœ„ê¸° í‘œí˜„ íŒ</h4>
            <ul>
              ${(hint.tips || []).map(item => `<li>${escapeHtml(item)}</li>`).join('')}
            </ul>
          </div>
        </div>
      `,
      buttons: [{ text: 'ë‹«ê¸°', class: 'btn-primary' }]
    });
  }

  /**
   * ìŠ¤í† ë¦¬ë³´ë“œ ë¯¸ë¦¬ë³´ê¸°
   */
  function previewStoryboard() {
    const scenesHtml = step3Data.scenes.map((scene, index) => {
      const imageInfo = step3Data.sceneImages[scene.id];
      return `
        <div style="background: var(--bg); padding: 12px; border-radius: 8px; display: flex; gap: 12px; align-items: flex-start;">
          <div style="width: 120px; height: 100px; flex-shrink: 0; background: white; border-radius: 8px; overflow: hidden; display: flex; align-items: center; justify-content: center; border: 2px solid var(--border);">
            ${imageInfo?.imageData ?
              `<img src="${imageInfo.imageData}" style="max-width: 100%; max-height: 100%; object-fit: contain;">` :
              `<span style="color: var(--text-muted);">ğŸ–¼ï¸</span>`
            }
          </div>
          <div style="flex: 1;">
            <div style="font-weight: 600; margin-bottom: 4px;">
              ${index + 1}. ${escapeHtml(scene.stageName)}
            </div>
            <p style="font-size: 0.85rem; margin: 0; color: var(--text-light);">
              ${escapeHtml(scene.description) || '(ì„¤ëª… ì—†ìŒ)'}
            </p>
            ${scene.dialogue ? `
              <p style="font-size: 0.85rem; margin-top: 4px; font-style: italic; color: var(--primary);">
                "${escapeHtml(scene.dialogue)}"
              </p>
            ` : ''}
          </div>
        </div>
      `;
    }).join('');

    showModal({
      title: `ğŸ‘ï¸ ìŠ¤í† ë¦¬ë³´ë“œ ë¯¸ë¦¬ë³´ê¸°`,
      content: `
        <div style="margin-bottom: 16px; padding: 12px; background: var(--primary-light); border-radius: 8px;">
          <h3 style="margin: 0;">ğŸ“– ${escapeHtml(step3Data.title)}</h3>
          <p style="margin: 4px 0 0 0; color: var(--text-light);">${step3Data.scenes.length}ê°œ ì¥ë©´</p>
        </div>
        <div style="display: flex; flex-direction: column; gap: 8px; max-height: 400px; overflow-y: auto;">
          ${scenesHtml}
        </div>
      `,
      buttons: [{ text: 'ë‹«ê¸°', class: 'btn-primary' }]
    });
  }

  /**
   * PDF ë‚´ë³´ë‚´ê¸°
   */
  async function exportToPDF() {
    showLoading('PDF ìƒì„± ì¤‘...');

    try {
      const result = await callApi('exportStoryboardPDF', {
        studentName: step3Data.studentName,
        studentNumber: step3Data.studentNumber,
        title: step3Data.title,
        scenes: step3Data.scenes,
        sceneImages: step3Data.sceneImages
      });

      hideLoading();

      if (result.success && result.pdfUrl) {
        // PDF ë‹¤ìš´ë¡œë“œ ë§í¬ ì—´ê¸°
        window.open(result.pdfUrl, '_blank');
        showToast('PDFê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ“„', 'success');
      } else {
        showToast(result.error || 'PDF ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
      }
    } catch (error) {
      hideLoading();
      console.error('PDF ìƒì„± ì˜¤ë¥˜:', error);
      showToast('PDF ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
    }
  }

  /**
   * Step 3 ì €ì¥
   */
  async function saveStep3(isComplete = false) {
    if (isSavingStep3) return;

    const saveBtn = document.getElementById('btn-save-step3');
    const submitBtn = document.getElementById('btn-submit-step3');

    if (isComplete) {
      // ì™„ë£Œ ê²€ì¦: ëª¨ë“  ì¥ë©´ì— ì´ë¯¸ì§€ê°€ ìˆì–´ì•¼ í•¨
      const missingImages = step3Data.scenes.filter(
        scene => !step3Data.sceneImages[scene.id]?.imageData
      );

      if (missingImages.length > 0) {
        showToast(`${missingImages.length}ê°œ ì¥ë©´ì— ê·¸ë¦¼ì´ ì—†ìŠµë‹ˆë‹¤. ëª¨ë“  ì¥ë©´ì— ê·¸ë¦¼ì„ ì¶”ê°€í•´ì£¼ì„¸ìš”!`, 'warning');

        // ì²« ë²ˆì§¸ ëˆ„ë½ëœ ì¥ë©´ìœ¼ë¡œ ì´ë™
        const missingIndex = step3Data.scenes.findIndex(
          scene => !step3Data.sceneImages[scene.id]?.imageData
        );
        if (missingIndex !== -1) {
          selectScene(missingIndex);
        }
        return;
      }
    }

    isSavingStep3 = true;

    try {
      // ë²„íŠ¼ ìƒíƒœ ë³€ê²½
      if (isComplete) {
        if (submitBtn) {
          submitBtn.disabled = true;
          submitBtn.innerHTML = 'â³ ì œì¶œ ì¤‘...';
        }
      } else {
        if (saveBtn) {
          saveBtn.disabled = true;
          saveBtn.innerHTML = 'â³ ì €ì¥ ì¤‘...';
        }
      }

      const result = await callApi('saveWork', {
        studentName: step3Data.studentName,
        studentNumber: step3Data.studentNumber,
        step: 3,
        workData: {
          title: step3Data.title,
          scenes: step3Data.scenes,
          sceneImages: step3Data.sceneImages,
          totalScenes: step3Data.scenes.length,
          completedScenes: Object.keys(step3Data.sceneImages).filter(
            id => step3Data.sceneImages[id]?.imageData
          ).length,
          isComplete: isComplete,
          status: isComplete ? 'submitted' : 'draft'
        }
      });

      if (result.success) {
        if (isComplete) {
          if (submitBtn) {
            submitBtn.innerHTML = 'âœ… ì œì¶œ ì™„ë£Œ!';
            submitBtn.style.background = 'var(--success)';
          }
          showToast('ìŠ¤í† ë¦¬ë³´ë“œê°€ ì™„ì„±ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ‰', 'success');
          stopAutoSaveStep3();
          setTimeout(() => navigateTo('student-main'), 1500);
        } else {
          if (saveBtn) {
            saveBtn.innerHTML = 'âœ“ ì €ì¥ë¨!';
            saveBtn.style.color = 'var(--success)';
            saveBtn.style.borderColor = 'var(--success)';
            setTimeout(() => {
              saveBtn.innerHTML = 'ğŸ’¾ ì €ì¥í•˜ê¸°';
              saveBtn.style.color = '';
              saveBtn.style.borderColor = '';
              saveBtn.disabled = false;
            }, 2000);
          }
          showToast('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
        }
      } else {
        // ì‹¤íŒ¨ ì‹œ ë³µêµ¬
        if (saveBtn) {
          saveBtn.innerHTML = 'ğŸ’¾ ì €ì¥í•˜ê¸°';
          saveBtn.disabled = false;
        }
        if (submitBtn) {
          submitBtn.innerHTML = 'ğŸ“® ì œì¶œí•˜ê¸°';
          submitBtn.disabled = false;
          submitBtn.style.background = '';
        }
        showToast(result.error || 'ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
      }
    } catch (error) {
      console.error('ì €ì¥ ì˜¤ë¥˜:', error);
      if (saveBtn) {
        saveBtn.innerHTML = 'ğŸ’¾ ì €ì¥í•˜ê¸°';
        saveBtn.disabled = false;
      }
      if (submitBtn) {
        submitBtn.innerHTML = 'ğŸ“® ì œì¶œí•˜ê¸°';
        submitBtn.disabled = false;
        submitBtn.style.background = '';
      }
      showToast('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
    } finally {
      isSavingStep3 = false;
    }
  }

  /**
   * ìë™ ì €ì¥
   */
  let autoSaveStep3Interval = null;

  function startAutoSaveStep3() {
    stopAutoSaveStep3();
    autoSaveStep3Interval = setInterval(() => {
      saveStep3(false);
    }, STEP3_AUTO_SAVE_INTERVAL_MS);
  }

  function stopAutoSaveStep3() {
    if (autoSaveStep3Interval) {
      clearInterval(autoSaveStep3Interval);
      autoSaveStep3Interval = null;
    }
  }

  /**
   * ë‚˜ê°€ê¸° í™•ì¸
   */
  function confirmExitStep3() {
    showConfirm('ì €ì¥í•˜ì§€ ì•Šì€ ë‚´ìš©ì´ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë‚˜ê°€ì‹œê² ìŠµë‹ˆê¹Œ?', () => {
      stopAutoSaveStep3();
      navigateTo('student-main');
    });
  }
</script>
