<script>
  /* ============================================
     í•™ìƒ ë¡œê·¸ì¸ í™”ë©´
     ============================================ */

  function renderStudentLogin(container) {
    const settings = AppState.settings || {};
    const teacherName = settings.teacherName ? `${escapeHtml(settings.teacherName)} ì„ ìƒë‹˜ì˜ ` : '';
    // ë‚ ì§œ í˜•ì‹ ë°ì´í„° í•„í„°ë§
    const className = safeSettingValue ? safeSettingValue(settings.className) : settings.className;
    const classInfo = className ? `(${escapeHtml(className)})` : '';

    container.innerHTML = `
      <div class="container-narrow fade-in" role="main" aria-label="í•™ìƒ ë¡œê·¸ì¸ í˜ì´ì§€">
        <!-- í•™ìƒìš© ë¡œê·¸ì¸ í—¤ë” -->
        <header class="card card-rainbow-top" style="margin-bottom: 24px; padding-top: 30px;" role="banner">
          <div class="text-center">
            <h1 class="title-handwriting" style="color: var(--primary); font-size: 1.8rem;">
              ${teacherName ? `${teacherName}` : ''}ìŠ¤í† ë¦¬ í•™ìŠµì§€
            </h1>
            ${classInfo ? `<p style="color: var(--text-light); margin-top: 4px;">${classInfo}</p>` : ''}
          </div>
        </header>

        <div class="card slide-up" role="region" aria-label="ë¡œê·¸ì¸ í¼">
          <div class="text-center mb-3">
            <h2 id="login-title">í•™ìƒ ë¡œê·¸ì¸</h2>
            <p style="color: var(--text-light);" id="login-description">
              ì„ ìƒë‹˜ê»˜ ë°›ì€ ì •ë³´ë¡œ ë¡œê·¸ì¸í•˜ì„¸ìš”
            </p>
          </div>

          <form id="login-form" onsubmit="submitLogin(event)" aria-labelledby="login-title" aria-describedby="login-description">
            <div class="form-group">
              <label class="form-label" for="login-name" id="name-label">ì´ë¦„</label>
              <input type="text" id="login-name" name="name" class="form-input form-input-lg"
                     placeholder="ì˜ˆ: í™ê¸¸ë™" autocomplete="name" required
                     aria-labelledby="name-label" aria-required="true"
                     aria-describedby="name-hint">
              <span id="name-hint" class="sr-only">ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”</span>
            </div>

            <div class="form-group">
              <label class="form-label" for="login-number" id="number-label">ë²ˆí˜¸</label>
              <input type="number" id="login-number" name="number" class="form-input form-input-lg"
                     placeholder="ì˜ˆ: 15" min="1" max="100" inputmode="numeric" required
                     aria-labelledby="number-label" aria-required="true"
                     aria-describedby="number-hint">
              <span id="number-hint" class="sr-only">1ë¶€í„° 100ê¹Œì§€ì˜ ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”</span>
            </div>

            <div id="pin-section" style="display: none;" aria-live="polite">
              ${renderPinInput('login-pin', 'PIN (ë³¸ì¸ì´ ì„¤ì •í•œ 6ìë¦¬ ìˆ«ì)')}
              <p class="form-helper" style="text-align: center; margin-top: -8px;" id="pin-hint">
                PINì„ ìŠì—ˆìœ¼ë©´ ì„ ìƒë‹˜ê»˜ ë¬¸ì˜í•˜ì„¸ìš”
              </p>
            </div>

            <div id="login-error" class="alert alert-error" style="display: none;" role="alert" aria-live="assertive"></div>

            <button type="submit" id="login-btn" class="btn btn-primary btn-lg btn-block mt-3"
                    aria-describedby="login-btn-hint">
              <span id="login-btn-text">ë‹¤ìŒ</span>
            </button>
            <span id="login-btn-hint" class="sr-only">ì´ë¦„ê³¼ ë²ˆí˜¸ ì…ë ¥ í›„ ë‹¤ìŒ ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”</span>
          </form>

          <div class="text-center mt-3" style="padding-top: 16px; border-top: 1px solid var(--border);">
            <a href="javascript:void(0)" onclick="showTeacherModeInfo(event)"
               style="color: var(--text-light); font-size: 0.85rem;"
               role="button" aria-label="ì„ ìƒë‹˜ ëª¨ë“œë¡œ ì „í™˜í•˜ê¸°">
              ì„ ìƒë‹˜ì´ì‹ ê°€ìš”? ì—¬ê¸°ë¥¼ í´ë¦­í•˜ì„¸ìš”
            </a>
          </div>
        </div>
      </div>
    `;

    // ì´ë¦„ ì…ë ¥ í•„ë“œì— í¬ì»¤ìŠ¤
    setTimeout(() => {
      const nameInput = document.getElementById('login-name');
      if (nameInput) nameInput.focus();
    }, 100);

    // ë²ˆí˜¸ ì…ë ¥ í›„ ìë™ìœ¼ë¡œ í•™ìƒ í™•ì¸
    const numberInput = document.getElementById('login-number');
    numberInput.addEventListener('blur', checkStudentAndShowPin);
  }

  /**
   * í•™ìƒ í™•ì¸ í›„ PIN ì…ë ¥ ì„¹ì…˜ í‘œì‹œ
   */
  async function checkStudentAndShowPin() {
    const name = document.getElementById('login-name').value.trim();
    const number = document.getElementById('login-number').value;

    if (!name || !number) return;

    const result = await checkStudent(name, number);

    const pinSection = document.getElementById('pin-section');
    const loginBtn = document.getElementById('login-btn-text');
    const errorDiv = document.getElementById('login-error');

    if (!result) return;

    if (!result.success) {
      if (result.notFound) {
        errorDiv.innerHTML = `
          <strong>â“ ë“±ë¡ë˜ì§€ ì•Šì€ í•™ìƒì…ë‹ˆë‹¤</strong>
          <p style="margin-top: 8px;">ì…ë ¥í•œ ì •ë³´ë¥¼ í™•ì¸í•˜ê±°ë‚˜, ì„ ìƒë‹˜ê»˜ ë¬¸ì˜í•´ì£¼ì„¸ìš”.</p>
        `;
        errorDiv.style.display = 'block';
        pinSection.style.display = 'none';
      } else {
        errorDiv.innerHTML = result.error;
        errorDiv.style.display = 'block';
      }
      return;
    }

    errorDiv.style.display = 'none';

    if (result.needSetPin) {
      // PIN ì„¤ì •ì´ í•„ìš”í•œ ê²½ìš°
      navigateTo('pin-setup', {
        name: result.name,
        number: result.number
      });
    } else {
      // PIN ì…ë ¥ ì„¹ì…˜ í‘œì‹œ
      pinSection.style.display = 'block';
      loginBtn.textContent = 'ë¡œê·¸ì¸';

      // PIN ì…ë ¥ ì„¤ì •
      setupPinInput('login-pin');
    }
  }

  /**
   * ë¡œê·¸ì¸ í¼ ì œì¶œ
   */
  async function submitLogin(event) {
    event.preventDefault();

    const name = document.getElementById('login-name').value.trim();
    const number = document.getElementById('login-number').value;
    const pinSection = document.getElementById('pin-section');

    if (pinSection.style.display === 'none') {
      // ì•„ì§ í•™ìƒ í™•ì¸ ì•ˆë¨ - í™•ì¸ ë¨¼ì €
      await checkStudentAndShowPin();
      return;
    }

    const pin = getPinValue('login-pin');
    await handleStudentLogin(name, number, pin);
  }

  /**
   * êµì‚¬ ëª¨ë“œ ì•ˆë‚´
   */
  function showTeacherModeInfo(event) {
    if (event) {
      event.preventDefault();
      event.stopPropagation();
    }

    showModal({
      title: 'ì„ ìƒë‹˜ ëª¨ë“œ',
      content: `
        <div style="text-align: center; padding: 16px 0;">
          <div style="font-size: 3rem; margin-bottom: 16px;">ğŸ‘©â€ğŸ«</div>
          <p style="margin-bottom: 20px;">
            ì„ ìƒë‹˜ì´ì‹œë¼ë©´ ì•„ë˜ ë²„íŠ¼ì„ ëˆŒëŸ¬<br>
            ì„ ìƒë‹˜ ëª¨ë“œë¡œ ì ‘ì†í•˜ì„¸ìš”.
          </p>
          <button class="btn btn-primary btn-lg btn-block" onclick="enterTeacherMode()">
            ì„ ìƒë‹˜ ëª¨ë“œë¡œ ì ‘ì†í•˜ê¸°
          </button>
          <p style="margin-top: 16px; color: var(--text-light); font-size: 0.85rem;">
            ë˜ëŠ” URL ë’¤ì— <code>?mode=teacher</code>ë¥¼ ì¶”ê°€í•´ë„ ë©ë‹ˆë‹¤.
          </p>
        </div>
      `
    });
  }

  /**
   * êµì‚¬ ëª¨ë“œ ì§„ì… - ì¸ì¦ í•„ìš”
   */
  async function enterTeacherMode() {
    closeModal();
    showLoading('í™•ì¸ ì¤‘...');

    try {
      // êµì‚¬ ì¸ì¦ í™•ì¸ í›„ ì ì ˆí•œ í™”ë©´ìœ¼ë¡œ ì´ë™
      await handleTeacherModeEntry();
    } catch (error) {
      console.log('êµì‚¬ ëª¨ë“œ ì „í™˜ ì˜¤ë¥˜:', error);
      hideLoading();
      // ì˜¤ë¥˜ ì‹œ ë¡œê·¸ì¸ í™”ë©´ìœ¼ë¡œ
      navigateTo('teacher-login', { isFirstSetup: true, hasPin: false });
    }
  }
</script>
