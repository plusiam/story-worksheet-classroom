<script>
  /* ============================================
     ìŠ¤í† ë¦¬ í¬ë¦¬ì—ì´í„° - ì‘í’ˆ í¸ì§‘ í™”ë©´
     ============================================ */

  let storyData = {
    step: 1,
    studentName: '',
    studentNumber: 0,
    workData: null
  };

  const STAGES = [
    { id: 'beginning', name: 'ë°œë‹¨', emoji: 'ğŸŒ…', hint: 'ì´ì•¼ê¸°ê°€ ì‹œì‘ë˜ëŠ” ë¶€ë¶„ì´ì—ìš”. ì£¼ì¸ê³µê³¼ ë°°ê²½ì„ ì†Œê°œí•´ë³´ì„¸ìš”.' },
    { id: 'development', name: 'ì „ê°œ', emoji: 'ğŸ­', hint: 'ì‚¬ê±´ì´ ì¼ì–´ë‚˜ê³  ì´ì•¼ê¸°ê°€ ë°œì „í•˜ëŠ” ë¶€ë¶„ì´ì—ìš”.' },
    { id: 'climax', name: 'ì ˆì •', emoji: 'âš¡', hint: 'ê°€ì¥ ì¤‘ìš”í•˜ê³  ê¸´ì¥ê° ìˆëŠ” ë¶€ë¶„ì´ì—ìš”.' },
    { id: 'ending', name: 'ê²°ë§', emoji: 'ğŸŒˆ', hint: 'ì´ì•¼ê¸°ê°€ ë§ˆë¬´ë¦¬ë˜ëŠ” ë¶€ë¶„ì´ì—ìš”.' }
  ];

  async function renderStoryCreator(container, data) {
    storyData = {
      step: data?.step || 1,
      studentName: data?.studentName || AppState.currentUser?.name,
      studentNumber: data?.studentNumber || AppState.currentUser?.number,
      workData: data?.existingWork?.workData || createEmptyWorkData()
    };

    container.innerHTML = `
      <div class="container fade-in">
        ${renderStudentHeader(`STEP ${storyData.step}: 4ì»· ìŠ¤í† ë¦¬ ë§Œë“¤ê¸°`)}

        <!-- ì§„í–‰ ìƒí™© -->
        <div class="card mb-3">
          <div class="flex justify-between items-center">
            <div>
              <h3 style="margin: 0;">ğŸ“– ë‚˜ì˜ ì´ì•¼ê¸°</h3>
              <input type="text" id="story-title" class="form-input mt-1" style="font-size: 1.2rem; font-weight: 600;"
                     placeholder="ì´ì•¼ê¸° ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" value="${escapeHtml(storyData.workData.title || '')}">
            </div>
            <div class="flex gap-2">
              <button class="btn btn-outline" onclick="saveStory(false)">
                ğŸ’¾ ì €ì¥
              </button>
              <button class="btn btn-primary" onclick="saveStory(true)">
                âœ… ì™„ë£Œ
              </button>
            </div>
          </div>
        </div>

        <!-- 4ì»· íŒ¨ë„ -->
        <div class="story-panels">
          ${renderStoryPanels()}
        </div>

        <!-- í•˜ë‹¨ ë²„íŠ¼ -->
        <div class="flex justify-between mt-3">
          <button class="btn btn-ghost" onclick="confirmExit()">
            â† ëŒì•„ê°€ê¸°
          </button>
          <div class="flex gap-2">
            <button class="btn btn-outline" onclick="previewStory()">
              ğŸ‘ï¸ ë¯¸ë¦¬ë³´ê¸°
            </button>
            <button class="btn btn-secondary" onclick="exportStory()">
              ğŸ“¤ ë‚´ë³´ë‚´ê¸°
            </button>
          </div>
        </div>
      </div>

      <!-- ë˜ë¦¬ AI í˜¸ì¶œ ë²„íŠ¼ (í”Œë¡œíŒ…) -->
      <button class="ttori-fab" id="ttori-fab" onclick="toggleTtoriPanel()" title="ë˜ë¦¬ì—ê²Œ ë¬¼ì–´ë³´ê¸°">
        ğŸ¤
      </button>

      <style>
        .story-panels {
          display: grid;
          grid-template-columns: repeat(2, 1fr);
          gap: 16px;
        }

        @media (max-width: 768px) {
          .story-panels {
            grid-template-columns: 1fr;
          }
        }

        .story-panel {
          background: var(--card);
          border-radius: var(--radius);
          padding: 20px;
          box-shadow: var(--shadow);
          position: relative;
        }

        .story-panel-header {
          display: flex;
          align-items: center;
          gap: 8px;
          margin-bottom: 16px;
          padding-bottom: 12px;
          border-bottom: 2px solid var(--border);
        }

        .story-panel-number {
          width: 36px;
          height: 36px;
          background: var(--primary);
          color: white;
          border-radius: 50%;
          display: flex;
          align-items: center;
          justify-content: center;
          font-weight: 700;
        }

        .story-panel-stage {
          font-size: 1.5rem;
        }

        .story-textarea {
          width: 100%;
          min-height: 100px;
          padding: 12px;
          border: 2px solid var(--border);
          border-radius: var(--radius-sm);
          font-family: inherit;
          font-size: 1rem;
          resize: vertical;
          transition: var(--transition);
        }

        .story-textarea:focus {
          outline: none;
          border-color: var(--primary);
        }

        .story-hint {
          color: var(--text-muted);
          font-size: 0.85rem;
          margin-top: 8px;
          padding: 8px 12px;
          background: var(--bg);
          border-radius: var(--radius-sm);
        }
      </style>
    `;

    // ìë™ ì €ì¥ ì„¤ì • (30ì´ˆë§ˆë‹¤)
    startAutoSave();
  }

  /**
   * ë¹ˆ ì‘í’ˆ ë°ì´í„° ìƒì„±
   */
  function createEmptyWorkData() {
    return {
      title: '',
      panels: STAGES.map((stage, index) => ({
        id: index + 1,
        stage: stage.id,
        stageName: stage.name,
        description: '',
        dialogue: ''
      })),
      version: 1
    };
  }

  /**
   * ìŠ¤í† ë¦¬ íŒ¨ë„ ë Œë”ë§
   */
  function renderStoryPanels() {
    return storyData.workData.panels.map((panel, index) => {
      const stage = STAGES[index];
      return `
        <div class="story-panel slide-up" style="animation-delay: ${index * 0.1}s;">
          <div class="story-panel-header">
            <div class="story-panel-number">${panel.id}</div>
            <span class="story-panel-stage">${stage.emoji}</span>
            <div>
              <strong>${stage.name}</strong>
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">ì¥ë©´ ì„¤ëª…</label>
            <textarea id="panel-desc-${panel.id}" class="story-textarea"
                      placeholder="ì´ ì¥ë©´ì—ì„œ ë¬´ìŠ¨ ì¼ì´ ì¼ì–´ë‚˜ë‚˜ìš”?"
                      onchange="updatePanel(${panel.id}, 'description', this.value)">${escapeHtml(panel.description || '')}</textarea>
          </div>

          <div class="form-group">
            <label class="form-label">ëŒ€ì‚¬ (ì„ íƒ)</label>
            <textarea id="panel-dialogue-${panel.id}" class="story-textarea" style="min-height: 60px;"
                      placeholder="ë“±ì¥ì¸ë¬¼ì´ í•˜ëŠ” ë§ì„ ì ì–´ë³´ì„¸ìš”"
                      onchange="updatePanel(${panel.id}, 'dialogue', this.value)">${escapeHtml(panel.dialogue || '')}</textarea>
          </div>

          <div class="story-hint">
            ğŸ’¡ ${stage.hint}
          </div>
        </div>
      `;
    }).join('');
  }

  /**
   * íŒ¨ë„ ë°ì´í„° ì—…ë°ì´íŠ¸
   */
  function updatePanel(panelId, field, value) {
    const panel = storyData.workData.panels.find(p => p.id === panelId);
    if (panel) {
      panel[field] = value;
    }
  }

  /**
   * ì‘í’ˆ ì €ì¥
   */
  async function saveStory(isComplete = false) {
    // ì œëª© ì—…ë°ì´íŠ¸
    storyData.workData.title = document.getElementById('story-title').value.trim();

    // ê° íŒ¨ë„ ë°ì´í„° ìˆ˜ì§‘
    storyData.workData.panels.forEach(panel => {
      const descEl = document.getElementById(`panel-desc-${panel.id}`);
      const dialogueEl = document.getElementById(`panel-dialogue-${panel.id}`);

      if (descEl) panel.description = descEl.value;
      if (dialogueEl) panel.dialogue = dialogueEl.value;
    });

    // ì™„ë£Œ ì—¬ë¶€ ì²´í¬
    if (isComplete) {
      // í•„ìˆ˜ í•­ëª© í™•ì¸
      const emptyPanels = storyData.workData.panels.filter(p => !p.description.trim());
      if (emptyPanels.length > 0) {
        showToast('ëª¨ë“  ì¥ë©´ì˜ ì„¤ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!', 'warning');
        return;
      }

      if (!storyData.workData.title.trim()) {
        showToast('ì´ì•¼ê¸° ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!', 'warning');
        document.getElementById('story-title').focus();
        return;
      }
    }

    try {
      showLoading('ì €ì¥ ì¤‘...');

      const result = await callApi('saveWork', {
        studentName: storyData.studentName,
        studentNumber: storyData.studentNumber,
        step: storyData.step,
        workData: {
          ...storyData.workData,
          isComplete: isComplete,
          status: isComplete ? 'submitted' : 'draft'
        }
      });

      if (result.success) {
        if (isComplete) {
          showToast('ì‘í’ˆì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ‰', 'success');
          navigateTo('student-main');
        } else {
          showToast('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
        }
      } else {
        showToast(result.error || 'ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
      }
    } catch (error) {
      console.error('ì €ì¥ ì˜¤ë¥˜:', error);
      showToast('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
    }
  }

  /**
   * ìë™ ì €ì¥
   */
  let autoSaveInterval = null;

  function startAutoSave() {
    stopAutoSave();
    autoSaveInterval = setInterval(() => {
      saveStory(false);
    }, 30000); // 30ì´ˆë§ˆë‹¤
  }

  function stopAutoSave() {
    if (autoSaveInterval) {
      clearInterval(autoSaveInterval);
      autoSaveInterval = null;
    }
  }

  /**
   * ë‚˜ê°€ê¸° í™•ì¸
   */
  function confirmExit() {
    showConfirm(
      'ì €ì¥í•˜ì§€ ì•Šì€ ë‚´ìš©ì´ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë‚˜ê°€ì‹œê² ìŠµë‹ˆê¹Œ?',
      () => {
        stopAutoSave();
        navigateTo('student-main');
      }
    );
  }

  /**
   * ë¯¸ë¦¬ë³´ê¸°
   */
  function previewStory() {
    // í˜„ì¬ ë°ì´í„° ìˆ˜ì§‘
    storyData.workData.title = document.getElementById('story-title').value.trim();
    storyData.workData.panels.forEach(panel => {
      const descEl = document.getElementById(`panel-desc-${panel.id}`);
      const dialogueEl = document.getElementById(`panel-dialogue-${panel.id}`);
      if (descEl) panel.description = descEl.value;
      if (dialogueEl) panel.dialogue = dialogueEl.value;
    });

    const title = storyData.workData.title || 'ì œëª© ì—†ìŒ';

    showModal({
      title: `ğŸ‘ï¸ ë¯¸ë¦¬ë³´ê¸°: ${escapeHtml(title)}`,
      content: `
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
          ${storyData.workData.panels.map((panel, index) => `
            <div style="background: var(--bg); padding: 12px; border-radius: 8px;">
              <div style="font-weight: 600; margin-bottom: 8px;">
                ${STAGES[index].emoji} ${panel.stageName}
              </div>
              <p style="font-size: 0.9rem; margin: 0;">${escapeHtml(panel.description) || '<span style="color: var(--text-muted);">(ì„¤ëª… ì—†ìŒ)</span>'}</p>
              ${panel.dialogue ? `
                <p style="margin-top: 8px; font-style: italic; color: var(--primary);">
                  "${escapeHtml(panel.dialogue)}"
                </p>
              ` : ''}
            </div>
          `).join('')}
        </div>
      `,
      buttons: [
        { text: 'ë‹«ê¸°', class: 'btn-primary' }
      ]
    });
  }

  /**
   * ë‚´ë³´ë‚´ê¸°
   */
  async function exportStory() {
    try {
      const result = await callApi('exportWork', {
        studentName: storyData.studentName,
        studentNumber: storyData.studentNumber,
        step: storyData.step
      });

      if (result.success && result.json) {
        downloadJSON(result.json, `ìŠ¤í† ë¦¬_${storyData.studentName}_STEP${storyData.step}.json`);
        showToast('ë‚´ë³´ë‚´ê¸° ì™„ë£Œ!', 'success');
      } else {
        showToast(result.error || 'ë‚´ë³´ë‚´ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
      }
    } catch (error) {
      showToast('ë‚´ë³´ë‚´ê¸° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
    }
  }

  /**
   * í˜„ì¬ ìŠ¤í† ë¦¬ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (ë˜ë¦¬ AIìš©)
   */
  function getCurrentStoryData() {
    // í˜„ì¬ ì…ë ¥ëœ ë°ì´í„° ìˆ˜ì§‘
    const title = document.getElementById('story-title')?.value.trim() || '';

    const panels = storyData.workData.panels.map((panel, index) => {
      const descEl = document.getElementById(`panel-desc-${panel.id}`);
      const dialogueEl = document.getElementById(`panel-dialogue-${panel.id}`);

      return {
        id: panel.id,
        stage: panel.stage,
        stageName: panel.stageName,
        content: descEl?.value || panel.description || '',
        dialogue: dialogueEl?.value || panel.dialogue || ''
      };
    });

    return {
      title: title,
      step: storyData.step,
      panels: panels,
      studentName: storyData.studentName,
      studentNumber: storyData.studentNumber
    };
  }

  /**
   * ë˜ë¦¬ AI íŒ¨ë„ í™œì„±í™” ì—¬ë¶€ í™•ì¸
   */
  async function checkTtoriFabVisibility() {
    try {
      const result = await callApi('checkAiEnabled');
      const fab = document.getElementById('ttori-fab');
      if (fab) {
        fab.style.display = result.enabled ? 'flex' : 'none';
      }
    } catch (error) {
      console.log('ë˜ë¦¬ FAB í™•ì¸ ì‹¤íŒ¨:', error);
    }
  }

  // í˜ì´ì§€ ë¡œë“œ ì‹œ ë˜ë¦¬ FAB í‘œì‹œ ì—¬ë¶€ í™•ì¸
  document.addEventListener('DOMContentLoaded', checkTtoriFabVisibility);
</script>
